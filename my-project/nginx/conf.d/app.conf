# Upstreams
upstream frontend { server frontend:80; }
upstream ai_api { server ai_api:8000; }
upstream ledger_api { server ledger_api:8000; }
upstream sql_api { server sql_api:8000; }
upstream rag_api { server rag_api:8000; }

# Common server block template (HTTP)
server {
    listen 80;
    server_name app.local;

    # Frontend (SPA) - 物理ファイルが無ければ @spa にフォールバック
    location / {
        try_files $uri @spa;
    }

    location @spa {
        proxy_pass http://frontend;
        include /etc/nginx/conf.d/_proxy_headers.conf;
        include /etc/nginx/conf.d/_proxy_ws.conf;
    }

    # API routes - keep trailing slash to strip prefix for upstream
    location /ai_api/ {
        include /etc/nginx/conf.d/_proxy_headers.conf;
        include /etc/nginx/conf.d/_proxy_ws.conf;
        proxy_pass http://ai_api/;
    }
    location /ledger_api/ {
        include /etc/nginx/conf.d/_proxy_headers.conf;
        include /etc/nginx/conf.d/_proxy_ws.conf;
        proxy_pass http://ledger_api/;
    }
    location /sql_api/ {
        include /etc/nginx/conf.d/_proxy_headers.conf;
        include /etc/nginx/conf.d/_proxy_ws.conf;
        proxy_pass http://sql_api/;
    }
    location /rag_api/ {
        include /etc/nginx/conf.d/_proxy_headers.conf;
        include /etc/nginx/conf.d/_proxy_ws.conf;
        proxy_pass http://rag_api/;
    }
}

# Staging host
server {
    listen 80;
    server_name stg.app.local;

    location / {
        try_files $uri @spa;
    }

    location @spa {
        proxy_pass http://frontend;
        include /etc/nginx/conf.d/_proxy_headers.conf;
        include /etc/nginx/conf.d/_proxy_ws.conf;
    }

    location /ai_api/ {
        include /etc/nginx/conf.d/_proxy_headers.conf;
        include /etc/nginx/conf.d/_proxy_ws.conf;
        proxy_pass http://ai_api/;
    }
    location /ledger_api/ {
        include /etc/nginx/conf.d/_proxy_headers.conf;
        include /etc/nginx/conf.d/_proxy_ws.conf;
        proxy_pass http://ledger_api/;
    }
    location /sql_api/ {
        include /etc/nginx/conf.d/_proxy_headers.conf;
        include /etc/nginx/conf.d/_proxy_ws.conf;
        proxy_pass http://sql_api/;
    }
    location /rag_api/ {
        include /etc/nginx/conf.d/_proxy_headers.conf;
        include /etc/nginx/conf.d/_proxy_ws.conf;
        proxy_pass http://rag_api/;
    }
}

# Optional HTTPS skeleton (certs mounting expected under /etc/nginx/certs)
server {
    listen 443 ssl;
    server_name app.local stg.app.local;
    ssl_certificate     /etc/nginx/certs/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/privkey.pem;
    # Basic redirect to HTTP until certs are set properly (or proxy similarly as above)
    return 301 http://$host$request_uri;
}
