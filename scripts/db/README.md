# Database Development Tools

**ç›®çš„**: é–‹ç™ºç’°å¢ƒã§ã®ã‚¹ã‚­ãƒ¼ãƒç®¡ç†ãƒ»æ¤œè¨¼ãƒ„ãƒ¼ãƒ«

---

## ğŸ“Œ ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¤ã„ã¦

ã“ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã¯ã€**é–‹ç™ºç’°å¢ƒå°‚ç”¨**ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ„ãƒ¼ãƒ«ãŒæ ¼ç´ã•ã‚Œã¦ã„ã¾ã™ã€‚

> **âš ï¸ æœ¬ç•ªç’°å¢ƒã®æ¨©é™ç®¡ç†ã«ã¤ã„ã¦**  
> æœ¬ç•ªç’°å¢ƒã®ãƒ­ãƒ¼ãƒ«ãƒ»æ¨©é™ç®¡ç†ã¯ [ops/db/](../../ops/db/) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚  
> ã“ã¡ã‚‰ã¯é–‹ç™ºç”¨ã®ã‚¹ã‚­ãƒ¼ãƒãƒ€ãƒ³ãƒ—ãƒ»æ¤œè¨¼ãƒ„ãƒ¼ãƒ«ã®ã¿ã§ã™ã€‚

---

## ğŸ”§ åˆ©ç”¨å¯èƒ½ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆ

### `dump_schema_current.sh`

**ç›®çš„**: ç¾åœ¨ã®ã‚¹ã‚­ãƒ¼ãƒå…¨ä½“ã‚’SQLãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ€ãƒ³ãƒ—

```bash
# ä½¿ã„æ–¹
bash scripts/db/dump_schema_current.sh

# ã¾ãŸã¯ Makefile çµŒç”±
make db-dev-dump-schema ENV=local_dev
```

**å‡ºåŠ›å…ˆ**: `app/backend/core_api/migrations/alembic/sql_current/schema_head.sql`

**ç”¨é€”**:

- ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‰å¾Œã®æ¯”è¼ƒ
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–

---

### `export_schema_baseline_local_dev.sh`

**ç›®çš„**: Alembic v2 ã®èµ·ç‚¹ã¨ãªã‚‹ã‚¹ã‚­ãƒ¼ãƒãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ

```bash
# ä½¿ã„æ–¹
bash scripts/db/export_schema_baseline_local_dev.sh

# ã¾ãŸã¯ Makefile çµŒç”±
make db-dev-export-baseline ENV=local_dev
```

**å‡ºåŠ›å…ˆ**: `app/backend/core_api/migrations_v2/sql/schema_baseline.sql`

**å‰ææ¡ä»¶**:

- local_dev ç’°å¢ƒãŒèµ·å‹•æ¸ˆã¿ (`make up ENV=local_dev`)
- Alembic ãŒ head ã¾ã§é©ç”¨æ¸ˆã¿ (`make al-up ENV=local_dev`)

**ç”¨é€”**:

- Alembic ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸºæº–ç‚¹ä½œæˆ
- æ–°ã—ã„ç’°å¢ƒã¸ã®ã‚¹ã‚­ãƒ¼ãƒç§»è¡Œ

---

## ğŸ”— é–¢é€£ãƒªã‚½ãƒ¼ã‚¹

### æœ¬ç•ªç’°å¢ƒé‹ç”¨

| é …ç›®             | å ´æ‰€                                       |
| ---------------- | ------------------------------------------ |
| **æ¨©é™ç®¡ç†**     | [ops/db/](../../ops/db/)                   |
| **ãƒ­ãƒ¼ãƒ«è¨­è¨ˆ**   | [ops/db/README.md](../../ops/db/README.md) |
| **å®Ÿè¡Œç”¨SQL**    | [ops/db/sql/](../../ops/db/sql/)           |
| **æ—§ã‚¹ã‚¯ãƒªãƒ—ãƒˆ** | [ops/db/legacy/](../../ops/db/legacy/)     |

### Makefile ã‚³ãƒãƒ³ãƒ‰

| ã‚³ãƒãƒ³ãƒ‰                      | èª¬æ˜                                |
| ----------------------------- | ----------------------------------- |
| `make db-dev-dump-schema`     | ã‚¹ã‚­ãƒ¼ãƒãƒ€ãƒ³ãƒ—                      |
| `make db-dev-export-baseline` | ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ            |
| `make db-apply-all ENV=...`   | æœ¬ç•ªç”¨ãƒ­ãƒ¼ãƒ«é©ç”¨ï¼ˆops/db/sql/ä½¿ç”¨ï¼‰ |

è©³ç´°ã¯ [mk/50_db_roles.mk](../../mk/50_db_roles.mk) ã‚’å‚ç…§ã€‚

---

## ğŸ“š ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### ã‚¹ã‚­ãƒ¼ãƒãƒ€ãƒ³ãƒ—ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°

- âœ… **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨å‰**: ç¾çŠ¶ã‚’è¨˜éŒ²
- âœ… **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é©ç”¨å¾Œ**: å¤‰æ›´ã‚’ç¢ºèª
- âœ… **ãƒ¬ãƒ“ãƒ¥ãƒ¼å‰**: PRã«æ·»ä»˜
- âœ… **ãƒªãƒªãƒ¼ã‚¹å‰**: æœ€çµ‚ç¢ºèª

### ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†

```bash
# ã‚¹ã‚­ãƒ¼ãƒãƒ€ãƒ³ãƒ—ã¯ Git ç®¡ç†ä¸‹
git add app/backend/core_api/migrations/alembic/sql_current/schema_head.sql
git commit -m "docs: update schema dump after migration XXXX"

# ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‚‚ Git ç®¡ç†
git add app/backend/core_api/migrations_v2/sql/schema_baseline.sql
git commit -m "feat: add Alembic v2 schema baseline"
```

---

## âš ï¸ æ³¨æ„äº‹é …

1. **æœ¬ç•ªç’°å¢ƒã§ã¯ä½¿ç”¨ã—ãªã„**: ã“ã‚Œã‚‰ã¯é–‹ç™ºãƒ„ãƒ¼ãƒ«ã§ã™
2. **æ¨©é™ç®¡ç†ã¯ ops/db/ ã‚’ä½¿ç”¨**: ãƒ­ãƒ¼ãƒ«ä½œæˆãƒ»æ¨©é™ä»˜ä¸ã¯æœ¬ç•ªé‹ç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§
3. **ã‚¹ã‚­ãƒ¼ãƒãƒ€ãƒ³ãƒ—ã¯ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨**: å®Ÿè¡Œå¯èƒ½ãªãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ Alembic ã§ç®¡ç†

---

**æœ€çµ‚æ›´æ–°æ—¥**: 2025-12-24
