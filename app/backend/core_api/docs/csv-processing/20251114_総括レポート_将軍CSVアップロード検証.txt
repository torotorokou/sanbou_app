総括レポート: 将軍CSVアップロード機能の検証

作成日: 2025-11-14
検証環境: local_dev (Docker Compose + PostgreSQL 17)
対象ブランチ: refactor/clean-architecture-2025-11

概要:
本レポートは、将軍CSVアップロード機能について下記の6点をステップごとに検証した結果をまとめたものです。
1) raw データ保存の検証
2) upload_file ログの検証
3) stg 層への整形処理の検証
4) flash / final の動作確認
5) 重複処理・移行のための設計案
6) 最終的な総括とロードマップ

検証の主な結論:
- CSV アップロードの基本パイプライン（受信→整形→保存→ログ更新）は正常に動作しています。
- ただし、アーキテクチャ上の「新旧 raw 層の混在」と「空行除去処理の欠如」が見つかり、これらは早期対応が必要です。

主な検証結果（要点）:
1. raw データ保存
- 現状: 整形済みデータは `stg.*_shogun_flash` に保存される。旧 raw 層である `raw.*_shogun_flash` にも保存されている。
- 新設計の raw 層 (`raw.*_raw`, TEXT 型) は存在するが未使用（0 行）。
- 影響: データの二重保存と技術的負債。

2. upload_file ログ
- `log.upload_file` はファイル名、hash、csv_type、row_count、processing_status を正しく記録・更新している。
- UNIQUE(file_hash, file_type, csv_type) により重複アップロードは防がれている。
- `metadata` と `uploaded_by` は現状ほとんど活用されていない。

3. stg 層への整形
- backend_shared のフォーマッタが機能し、日本語ヘッダ→英語カラム・型変換（date, numeric など）も正常。
- ただし CSV に空行が含まれると NULL 制約違反で失敗するケースあり。

4. flash / final の区分
- エンドポイント `/database/upload/syogun_csv`（flash）と `/database/upload/syogun_csv_final`（final）は正常に動作。
- DI により flash / final 用の writer が切替えられている。
- ただし旧 raw 層がまだ利用されているため移行方針が必要。

発見された問題点（優先度付き）:
1) 空行除去処理の欠如（高）
- 影響: アップロード失敗、サポート負荷増加。
- 対策: `_format_csv_data()` 内で事前に空行を除去し、除去した行数をログに記録。

2) 新旧 raw 層の混在（中）
- 影響: 無駄な保存、開発者の混乱、移行コストの増加。
- 対策: 旧 raw 層の廃止計画を策定し、新 raw 層（TEXT）を用いたワークフローへ移行。

3) metadata / uploaded_by の未活用（低）
- 影響: 解析・運用上の情報不足。
- 対策: upload 時に CSV のメタ情報（ヘッダ、行数、CSV バージョン等）を `metadata` に記録。認証導入後は `uploaded_by` を埋める。

推奨ロードマップ（短期〜中期）:
フェーズ1（即時: 1 日以内）
- 空行除去の実装とエラーメッセージ改善（優先）
- 軽微なログ項目活用（除去行数など）の追加

フェーズ2（1〜2 週間）
- 旧 raw 層の廃止計画作成
- 新 raw 層（`raw.*_raw`）を使う UseCase への切替え（段階的）
- flash/final 運用ルールのドキュメント化

フェーズ3（3〜8 週間）
- 重複チェック・デデュープ設計と実装
- YAML ベースの CSV メタカタログ拡張
- テスト（ユニット・結合）強化

期待される効果:
- 短期: アップロード成功率の改善、サポートコスト削減
- 中期: 設計の明確化による開発効率向上、ディスク利用効率改善
- 長期: 新規 CSV 種別や運用変更に対する柔軟性向上

補足（技術的所見）:
- UseCase (`UploadSyogunCsvUseCase`) は現在の責務を果たしているが、raw 書き込み責務の所在（RawDataRepository vs ShogunCsvRepository）を整理すると可読性が上がる。
- YAML 設定（`syogun_csv_masters.yaml`）は CSV 仕様管理に有用。メタ情報やバージョニングを追加すると移行が楽になる。

結論:
- 現状の CSV アップロード機能は動作しているが、技術的負債（旧 raw 層の残存、空行ハンドリング）が残る。
- 優先度高で空行除去を実装し、その後段階的に新 raw 層への移行・重複処理を実施することを推奨する。

---

レポート作成者: バックエンドQA兼リファクタリング担当（検証実施）

（このファイルは自動生成された検証レポートです。追加の要望があれば教えてください）
