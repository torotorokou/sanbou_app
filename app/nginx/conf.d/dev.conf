# =============================================================================
# dev.conf - ローカル開発環境用 nginx 設定 (ENV=local_dev with nginx)
# =============================================================================
# 想定アクセス経路: localhost:8080 → nginx → backend/frontend
# 認証: 開発環境のため認証なし
# ポート: HTTP 8080 (ホスト側) → 80 (コンテナ内)
#
# 使用方法:
#   make dev-with-nginx
#   ブラウザで http://localhost:8080 にアクセス
# =============================================================================

# Upstream 定義（docker-compose のサービス名で解決）
resolver 127.0.0.11 valid=30s;

upstream ai_api      { server ai_api:8000; }
upstream core_api    { server core_api:8000; }
upstream ledger_api  { server ledger_api:8000; }
upstream manual_api  { server manual_api:8000; }

server {
    listen 80 default_server;
    server_name _;
    
    # セキュリティヘッダー（開発環境）
    include /etc/nginx/conf.d/_security_headers.conf;
    
    # フロントエンドは開発サーバー (Vite) にプロキシ
    # 本番と異なり、React の開発サーバーが別プロセスで動いている
    location / {
        proxy_pass http://frontend:5173;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
        proxy_read_timeout 300s;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
    }

    # ヘルスチェック
    location = /health {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "OK";
    }

    # ===================== API Proxy (/api/ prefix) =====================
    location /api/ai_api/ {
        include /etc/nginx/conf.d/_proxy_headers_dev_stg.conf;
        proxy_pass http://ai_api/;
    }

    location /api/core_api/ {
        include /etc/nginx/conf.d/_proxy_headers_dev_stg.conf;
        proxy_pass http://core_api/;
    }

    location /api/ledger_api/ {
        include /etc/nginx/conf.d/_proxy_headers_dev_stg.conf;
        proxy_pass http://ledger_api/;
    }

    location /api/rag_api/ {
        set $rag_backend "http://rag_api:8000";
        include /etc/nginx/conf.d/_proxy_headers_dev_stg.conf;
        proxy_pass $rag_backend/;
    }

    location /api/manual_api/ {
        include /etc/nginx/conf.d/_proxy_headers_dev_stg.conf;
        proxy_pass http://manual_api/;
    }

    # ===================== Legacy Paths (no /api/ prefix) =====================
    location /core_api/ {
        include /etc/nginx/conf.d/_proxy_headers_dev_stg.conf;
        proxy_pass http://core_api/;
    }

    location /ai_api/ {
        include /etc/nginx/conf.d/_proxy_headers_dev_stg.conf;
        proxy_pass http://ai_api/;
    }

    location /ledger_api/ {
        include /etc/nginx/conf.d/_proxy_headers_dev_stg.conf;
        proxy_pass http://ledger_api/;
    }

    location /rag_api/ {
        set $rag_backend "http://rag_api:8000";
        include /etc/nginx/conf.d/_proxy_headers_dev_stg.conf;
        proxy_pass $rag_backend/;
    }

    location /manual_api/ {
        include /etc/nginx/conf.d/_proxy_headers_dev_stg.conf;
        proxy_pass http://manual_api/;
    }

    # Docs redirect
    location = /docs {
        rewrite ^ /ledger_api/docs last;
    }
}
