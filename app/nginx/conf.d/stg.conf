# =============================================================================
# stg.conf - GCP VM ステージング環境用 nginx 設定 (ENV=vm_stg)
# =============================================================================
# 想定アクセス経路: VPN/Tailscale 経由（http://100.x.x.x/）
# 認証: AUTH_MODE=vpn_dummy (IAP 不要)
# ポート: HTTP 80 のみ（HTTPS は不要、VPN 内で暗号化済み）
# 
# 注意:
#   - upstream 定義は app.conf で共通化されているため、ここでは重複定義しない
#   - IAP ヘッダは不要（VPN 内簡易認証のため）
#   - DBeaver 等の外部ツール接続は VM の 5432 ポート経由
# =============================================================================

# upstream 定義は app.conf にあるため省略（重複エラー回避）

server {
    listen 80 default_server;
    server_name _;
    root /usr/share/nginx/html;
    index index.html;

    # ヘルスチェック（Makefile health ターゲット用）
    location = /health {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "OK";
    }

    # SPA フォールバック
    location / {
        try_files $uri $uri/ /index.html;
    }

    # ===================== API Proxy (VPN 用、IAP ヘッダなし) =====================
    # 共通 proxy 設定を include で読み込み
    location /api/ai_api/ {
        include /etc/nginx/conf.d/_proxy_common.conf;
        proxy_pass http://ai_api/;
    }

    location /api/core_api/ {
        include /etc/nginx/conf.d/_proxy_common.conf;
        proxy_pass http://core_api/;
    }

    location /api/ledger_api/ {
        include /etc/nginx/conf.d/_proxy_common.conf;
        proxy_pass http://ledger_api/;
    }

    location /api/rag_api/ {
        include /etc/nginx/conf.d/_proxy_common.conf;
        proxy_pass http://rag_api/;
    }

    location /api/manual_api/ {
        include /etc/nginx/conf.d/_proxy_common.conf;
        proxy_pass http://manual_api/;
    }

    # レガシーパス対応（/api/ プレフィックスなし）
    location /ledger_api/ {
        include /etc/nginx/conf.d/_proxy_common.conf;
        proxy_pass http://ledger_api;
    }

    location = /docs {
        rewrite ^ /ledger_api/docs last;
    }
}
