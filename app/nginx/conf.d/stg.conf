# =============================================================================
# stg.conf - GCP VM ステージング環境用 nginx 設定 (ENV=vm_stg)
# =============================================================================
# 配置方法:
#   - ビルド時: app/nginx/Dockerfile の "FROM nginx:1.27-alpine AS stg" ステージでコピー
#   - 実行時: docker-compose.stg.yml で volume マウントして上書き
#     volumes:
#       - ../app/nginx/conf.d/stg.conf:/etc/nginx/conf.d/stg.conf:ro
#
# 想定アクセス経路: VPN/Tailscale 経由(http://100.x.x.x/)
# 認証: AUTH_MODE=vpn_dummy (IAP 不要)
# ポート: HTTP 80 のみ(HTTPS は不要、VPN 内で暗号化済み)
#
# ★ 重要: vm_stg / vm_prod 共通ポリシー
#   - VM 側 nginx は HTTP(80) のみで応答する構成です
#   - HTTPS へのリダイレクトは行いません
#   - 308/301 リダイレクトも含め、すべての HTTPS リダイレクトを除去しています
#   - TLS / ドメイン / IAP 認証は GCP Load Balancer 側で終端します
# =============================================================================

# Upstream 定義（docker-compose のサービス名で解決）
resolver 127.0.0.11 valid=30s;

upstream ai_api      { server ai_api:8000; }
upstream core_api    { server core_api:8000; }
upstream ledger_api  { server ledger_api:8000; }
upstream manual_api  { server manual_api:8000; }

server {
    listen 80 default_server;
    server_name _;
    root /usr/share/nginx/html;
    index index.html;

    # ヘルスチェック
    location = /health {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "OK";
    }

    # SPA フォールバック
    location / {
        try_files $uri $uri/ /index.html;
    }

    # ===================== API Proxy (/api/ prefix) =====================
    location /api/ai_api/ {
        include /etc/nginx/conf.d/_proxy_common.conf;
        proxy_pass http://ai_api/;
    }

    location /api/core_api/ {
        include /etc/nginx/conf.d/_proxy_common.conf;
        proxy_pass http://core_api/;
    }

    location /api/ledger_api/ {
        include /etc/nginx/conf.d/_proxy_common.conf;
        proxy_pass http://ledger_api/;
    }

    location /api/rag_api/ {
        set $rag_backend "http://rag_api:8000";
        include /etc/nginx/conf.d/_proxy_common.conf;
        proxy_pass $rag_backend/;
    }

    location /api/manual_api/ {
        include /etc/nginx/conf.d/_proxy_common.conf;
        proxy_pass http://manual_api/;
    }

    # ===================== Legacy Paths (no /api/ prefix) =====================
    location /core_api/ {
        include /etc/nginx/conf.d/_proxy_common.conf;
        proxy_pass http://core_api/;
    }

    location /ai_api/ {
        include /etc/nginx/conf.d/_proxy_common.conf;
        proxy_pass http://ai_api/;
    }

    location /ledger_api/ {
        include /etc/nginx/conf.d/_proxy_common.conf;
        proxy_pass http://ledger_api/;
    }

    location /rag_api/ {
        set $rag_backend "http://rag_api:8000";
        include /etc/nginx/conf.d/_proxy_common.conf;
        proxy_pass $rag_backend/;
    }

    location /manual_api/ {
        include /etc/nginx/conf.d/_proxy_common.conf;
        proxy_pass http://manual_api/;
    }

    # Docs redirect
    location = /docs {
        rewrite ^ /ledger_api/docs last;
    }
}
