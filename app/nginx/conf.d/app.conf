## Upstreams
## Compose ネットワーク内ではサービス名で名前解決できるためシンプルに定義
## 2025-12-05: Updated to match vm_stg/vm_prod docker-compose services
##             Removed sql_api (no such service exists)
##             Added manual_api (マニュアル管理 API)
upstream ai_api      { server ai_api:8000; }
upstream core_api    { server core_api:8000; }
upstream ledger_api  { server ledger_api:8000; }
upstream rag_api     { server rag_api:8000; }
upstream manual_api  { server manual_api:8000; }

# Common server block template (HTTP)
server {
    listen 80;
    # 任意 Host 許可 (内部 / 旧構成用)。LB→VM を HTTPS 化後は段階的に 80 を LB Health / ローカル検証以外では使わない想定。
    server_name _;

    # HTTP 経由アクセスを極力 HTTPS へ誘導 (ヘルスチェック / 明示除外パスは除く)
    set $redirect_https 1;
    if ($request_uri ~* ^/(health)$) { set $redirect_https 0; }
    if ($http_x_forwarded_proto = "https") { set $redirect_https 0; }
    if ($redirect_https = 1) {
        return 308 https://$host$request_uri;
    }

    # fallback: ヘルスチェックなどが HTTP のまま叩かれても 200 を返す
    root /usr/share/nginx/html;
    index index.html;
    # 2025-12-05: Health endpoint for Makefile HEALTH_URL=/health (docker-compose healthcheck)
    location = /health { access_log off; add_header Content-Type text/plain; return 200 "OK"; }
    location / { try_files $uri $uri/ /index.html; }
}

# Staging host
## 2つ目の server ブロックは不要になったため削除 (単一設定でホスト名問わず応答)

# Optional HTTPS skeleton (certs mounting expected under /etc/nginx/certs)
server {
    listen 443 ssl http2;
    server_name _;

    # ---- TLS Hardening (LB→VM 間 TLS 用) ----
    ssl_certificate     /etc/nginx/certs/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/privkey.pem;
    ssl_session_cache   shared:SSL:20m;
    ssl_session_timeout 10m;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         'TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256:HIGH:!aNULL:!MD5';
    ssl_prefer_server_ciphers on;
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains" always;
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header Referrer-Policy no-referrer-when-downgrade always;
    add_header X-XSS-Protection "1; mode=block" always;

    # ---- App Root (React SPA) ----
    root /usr/share/nginx/html;
    index index.html;

    # 2025-12-05: Health endpoint for Makefile HEALTH_URL=/health (docker-compose healthcheck)
    # Health (HTTPS) LB 用
    location = /health { access_log off; add_header Content-Type text/plain; return 200 "OK"; }

    # SPA fallback
    location / { try_files $uri $uri/ /index.html; }

    # ===================== API Proxy =====================
    # 2025-12-05: Removed sql_api (no such service in docker-compose)
    #             Added manual_api for manual management
    location ~ ^/(api/)?ai_api/ { include /etc/nginx/conf.d/_proxy_headers.conf; include /etc/nginx/conf.d/_proxy_ws.conf; proxy_pass http://ai_api; }
    location ~ ^/(api/)?core_api/ { include /etc/nginx/conf.d/_proxy_headers.conf; include /etc/nginx/conf.d/_proxy_ws.conf; proxy_pass http://core_api; }
    location ~ ^/(api/)?ledger_api/ { include /etc/nginx/conf.d/_proxy_headers.conf; include /etc/nginx/conf.d/_proxy_ws.conf; proxy_pass http://ledger_api; }
    location ~ ^/(api/)?rag_api/ { include /etc/nginx/conf.d/_proxy_headers.conf; include /etc/nginx/conf.d/_proxy_ws.conf; proxy_pass http://rag_api; }
    location ~ ^/(api/)?manual_api/ { include /etc/nginx/conf.d/_proxy_headers.conf; include /etc/nginx/conf.d/_proxy_ws.conf; proxy_pass http://manual_api; }
    rewrite ^/api/(ai_api|core_api|ledger_api|rag_api|manual_api)/(.*)$ /$1/$2 last;
    location = /docs { rewrite ^ /ledger_api/docs last; }
}
