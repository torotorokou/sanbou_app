## =============================================================
## Makefile : ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹é‹ç”¨ãƒ„ãƒ¼ãƒ«ï¼ˆops/maintenance/ï¼‰
## =============================================================
##
## ç›®çš„:
##   - Cloud Run ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒšãƒ¼ã‚¸ã®ç®¡ç†
##   - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æœ¬ä½“ã¨ã¯ç‹¬ç«‹ã—ãŸé‹ç”¨ãƒ„ãƒ¼ãƒ«
##
## ä½¿ã„æ–¹:
##   cd ops/maintenance
##   make deploy
##   make test
##   make setup-iap
##
## ã¾ãŸã¯ã€ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰:
##   make maintenance-deploy PROJECT_ID=honest-sanbou-app-prod
##   make maintenance-test PROJECT_ID=honest-sanbou-app-prod
##
## è¨­å®š:
##   .env ãƒ•ã‚¡ã‚¤ãƒ«ã§ PROJECT_ID ãªã©ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
##   ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: .env.example
##
## =============================================================

# .env ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°èª­ã¿è¾¼ã‚€ï¼ˆGit ç®¡ç†å¤–ï¼‰
-include .env

## ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
SERVICE_NAME ?= maintenance-page
REGION ?= asia-northeast1
PROJECT_ID ?=

# Cloud Run ã®è¨­å®š
MIN_INSTANCES ?= 0
MAX_INSTANCES ?= 10
CPU ?= 1
MEMORY ?= 256Mi
TIMEOUT ?= 10s
CONCURRENCY ?= 80

# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
CLOUDRUN_DIR := cloudrun

# Artifact Registry ãƒªãƒã‚¸ãƒˆãƒªï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ï¼‰
ARTIFACT_REPO ?= sanbou-app

# LB è¨­å®šï¼ˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ç”¨ï¼‰
URL_MAP_NAME ?= sanbou-prod-lb
PROD_BACKEND_SERVICE ?= sanbou-prod-backend
MAINTENANCE_BACKEND_SERVICE ?= maintenance-page-backend

.PHONY: help deploy deploy-local test check setup-iap setup-build-permissions clean \
        enable-apis setup-build-permissions check-build-log test-direct \
        maintenance-on maintenance-off maintenance-status

## ============================================================
## ãƒ˜ãƒ«ãƒ—
## ============================================================
help:
	@echo "=== ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹é‹ç”¨ Makefile ==="
	@echo ""
	@echo "å‰ææ¡ä»¶:"
	@echo "  PROJECT_ID=xxx ã‚’æŒ‡å®šã—ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„"
	@echo ""
	@echo "åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—:"
	@echo "  make setup-cloudbuild-permissions PROJECT_ID=xxx"
	@echo "  make deploy PROJECT_ID=xxx"
	@echo "  make setup-iap PROJECT_ID=xxx"
	@echo ""
	@echo "ã‚ˆãä½¿ã†ã‚³ãƒãƒ³ãƒ‰:"
	@echo "  make deploy PROJECT_ID=xxx     - Cloud Run ã«ãƒ‡ãƒ—ãƒ­ã‚¤"
	@echo "  make test PROJECT_ID=xxx       - å‹•ä½œç¢ºèªï¼ˆèªè¨¼ä»˜ããƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰"
	@echo "  make check PROJECT_ID=xxx      - ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª"
	@echo ""
	@echo "ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:"
	@echo "  make setup-cloudbuild-permissions PROJECT_ID=xxx"
	@echo ""
	@echo "è¨­å®š:"
	@echo "  SERVICE_NAME = $(SERVICE_NAME)"
	@echo "  REGION       = $(REGION)"
	@echo "  MIN_INSTANCES= $(MIN_INSTANCES)"
	@echo "  MAX_INSTANCES= $(MAX_INSTANCES)"
	@echo "  CPU          = $(CPU)"
	@echo "  MEMORY       = $(MEMORY)"
	@echo ""

## ============================================================
## APIæœ‰åŠ¹åŒ–ï¼ˆåˆå›ã®ã¿ï¼‰
## ============================================================
enable-apis:
	@if [ -z "$(PROJECT_ID)" ]; then \
	  echo "[error] PROJECT_ID is required."; \
	  echo "Usage: make enable-apis PROJECT_ID=your-project-id"; \
	  exit 1; \
	fi
	@echo "[info] Enabling required APIs for project $(PROJECT_ID)"
	@echo "  - cloudbuild.googleapis.com"
	@echo "  - run.googleapis.com"
	@echo "  - artifactregistry.googleapis.com"
	gcloud services enable \
	  cloudbuild.googleapis.com \
	  run.googleapis.com \
	  artifactregistry.googleapis.com \
	  --project=$(PROJECT_ID)
	@echo "[ok] âœ… APIs enabled"

## ============================================================
## Cloud Build æ¨©é™è¨­å®šï¼ˆæœ€å°æ¨©é™ç‰ˆï¼‰
## èª¬æ˜:
##   Cloud Build SA ã«å¿…è¦æœ€å°é™ã®ãƒ­ãƒ¼ãƒ«ã‚’ä»˜ä¸ã—ã¾ã™ã€‚
##   - artifactregistry.writer: ã‚¤ãƒ¡ãƒ¼ã‚¸ã®pushæ¨©é™
##   - run.admin: Cloud Run ã‚µãƒ¼ãƒ“ã‚¹ã®ä½œæˆ/æ›´æ–°
##   - iam.serviceAccountUser: ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½¿ç”¨
## ============================================================
setup-build-permissions:
	@if [ -z "$(PROJECT_ID)" ]; then \
	  echo "[error] PROJECT_ID is required."; \
	  echo "Usage: make setup-build-permissions PROJECT_ID=your-project-id"; \
	  exit 1; \
	fi
	@echo "[info] Setting up Cloud Build permissions (minimal required)"
	@PROJECT_NUMBER=$$(gcloud projects describe $(PROJECT_ID) --format="value(projectNumber)"); \
	echo "[info] Project Number: $$PROJECT_NUMBER"; \
	echo "[info] Cloud Build SA: $$PROJECT_NUMBER@cloudbuild.gserviceaccount.com"; \
	echo ""; \
	echo "[info] Granting minimal required roles..."; \
	echo "  1. artifactregistry.writer (for image push)"; \
	gcloud projects add-iam-policy-binding $(PROJECT_ID) \
	  --member="serviceAccount:$$PROJECT_NUMBER@cloudbuild.gserviceaccount.com" \
	  --role="roles/artifactregistry.writer" \
	  --condition=None && \
	echo "  2. run.admin (for Cloud Run deployment)"; \
	gcloud projects add-iam-policy-binding $(PROJECT_ID) \
	  --member="serviceAccount:$$PROJECT_NUMBER@cloudbuild.gserviceaccount.com" \
	  --role="roles/run.admin" \
	  --condition=None && \
	echo "  3. iam.serviceAccountUser (for SA usage)"; \
	gcloud projects add-iam-policy-binding $(PROJECT_ID) \
	  --member="serviceAccount:$$PROJECT_NUMBER@cloudbuild.gserviceaccount.com" \
	  --role="roles/iam.serviceAccountUser" \
	  --condition=None
	@echo ""
	@echo "[ok] âœ… Minimal permissions configured successfully"
	@echo "[info] â±ï¸  Permissions may take a few minutes to propagate"
	@echo ""
	@echo "Next step: make deploy PROJECT_ID=$(PROJECT_ID)"

## ============================================================
## Cloud Build ãƒ­ã‚°ç¢ºèªï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—æ™‚ï¼‰
## ä½¿ã„æ–¹:
##   make check-build-log PROJECT_ID=xxx BUILD_ID=<å¤±æ•—ã—ãŸãƒ“ãƒ«ãƒ‰ID>
## ============================================================
check-build-log:
	@if [ -z "$(PROJECT_ID)" ]; then \
	  echo "[error] PROJECT_ID is required."; \
	  exit 1; \
	fi
	@if [ -z "$(BUILD_ID)" ]; then \
	  echo "[info] BUILD_ID not specified, showing recent builds..."; \
	  echo ""; \
	  gcloud builds list \
	    --region=$(REGION) \
	    --project=$(PROJECT_ID) \
	    --limit=5 \
	    --format="table(id,status,logUrl)"; \
	  echo ""; \
	  echo "[info] To check specific build log:"; \
	  echo "       make check-build-log PROJECT_ID=$(PROJECT_ID) BUILD_ID=<build-id>"; \
	else \
	  echo "[info] Fetching build log for BUILD_ID=$(BUILD_ID)"; \
	  gcloud builds log $(BUILD_ID) \
	    --region=$(REGION) \
	    --project=$(PROJECT_ID) 2>&1 | tail -100; \
	fi

## å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã® alias
setup-cloudbuild-permissions: setup-build-permissions
	@echo "[warn] âš ï¸  'setup-cloudbuild-permissions' is deprecated."
	@echo "[warn] Please use 'setup-build-permissions' instead."

## ============================================================
## Cloud Run ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆCloud Build ä½¿ç”¨ï¼‰
## ============================================================
deploy:
	@if [ -z "$(PROJECT_ID)" ]; then \
	  echo "[error] PROJECT_ID is required."; \
	  echo "Usage: make deploy PROJECT_ID=your-project-id"; \
	  exit 1; \
	fi
	@echo "[info] Deploying maintenance page to Cloud Run"
	@echo "       Project: $(PROJECT_ID)"
	@echo "       Region: $(REGION)"
	@echo "       Service: $(SERVICE_NAME)"
	@echo ""
	@echo "[info] âš ï¸  First-time deployment? Run these first:"
	@echo "       1. make enable-apis PROJECT_ID=$(PROJECT_ID)"
	@echo "       2. make setup-build-permissions PROJECT_ID=$(PROJECT_ID)"
	@echo ""
	@echo "[info] ğŸ” If build fails, check logs:"
	@echo "       make check-build-log PROJECT_ID=$(PROJECT_ID)"
	@echo ""
	cd $(CLOUDRUN_DIR) && \
	gcloud run deploy $(SERVICE_NAME) \
	  --source . \
	  --platform managed \
	  --region $(REGION) \
	  --project $(PROJECT_ID) \
	  --no-allow-unauthenticated \
	  --min-instances $(MIN_INSTANCES) \
	  --max-instances $(MAX_INSTANCES) \
	  --cpu $(CPU) \
	  --memory $(MEMORY) \
	  --timeout $(TIMEOUT) \
	  --concurrency $(CONCURRENCY) \
	  --ingress internal-and-cloud-load-balancing
	@echo ""
	@echo "[ok] âœ… Deployment completed"
	@echo ""
	@echo "[info] ğŸ“‹ Next steps:"
	@echo "  1. Configure IAP Service Agent:"
	@echo "     make setup-iap PROJECT_ID=$(PROJECT_ID)"
	@echo ""
	@echo "  2. Verify deployment:"
	@echo "     make test PROJECT_ID=$(PROJECT_ID)"
	@echo ""
	@echo "  3. See cloudrun/README.md for LB configuration"

## ============================================================
## Cloud Run ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ«ãƒ‰ â†’ Artifact Registry â†’ Cloud Runï¼‰
## èª¬æ˜:
##   Cloud Build ãŒå¤±æ•—ã™ã‚‹å ´åˆã®å›é¿ç­–ã€‚
##   Docker ã§ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ«ãƒ‰ã—ã€Artifact Registry ã« push ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚
## å‰ææ¡ä»¶:
##   - Docker ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿
##   - gcloud auth configure-docker å®Ÿè¡Œæ¸ˆã¿
## ============================================================
deploy-local:
	@if [ -z "$(PROJECT_ID)" ]; then \
	  echo "[error] PROJECT_ID is required."; \
	  echo "Usage: make deploy-local PROJECT_ID=your-project-id"; \
	  exit 1; \
	fi
	@echo "[info] ğŸ—ï¸  Local build deployment (Docker â†’ Artifact Registry â†’ Cloud Run)"
	@echo "       Project: $(PROJECT_ID)"
	@echo "       Region: $(REGION)"
	@echo "       Service: $(SERVICE_NAME)"
	@echo ""
	@IMAGE_URL="$(REGION)-docker.pkg.dev/$(PROJECT_ID)/$(ARTIFACT_REPO)/$(SERVICE_NAME):latest"; \
	echo "[info] Step 1/3: Building Docker image locally..."; \
	cd $(CLOUDRUN_DIR) && docker build -t $$IMAGE_URL . || { \
	  echo "[error] âŒ Docker build failed"; \
	  exit 1; \
	}; \
	echo "[ok] âœ… Docker image built"; \
	echo ""; \
	echo "[info] Step 2/3: Pushing to Artifact Registry..."; \
	echo "       Image: $$IMAGE_URL"; \
	docker push $$IMAGE_URL || { \
	  echo "[error] âŒ Docker push failed"; \
	  echo "[info] Run: gcloud auth configure-docker $(REGION)-docker.pkg.dev"; \
	  exit 1; \
	}; \
	echo "[ok] âœ… Image pushed"; \
	echo ""; \
	echo "[info] Step 3/3: Deploying to Cloud Run..."; \
	gcloud run deploy $(SERVICE_NAME) \
	  --image $$IMAGE_URL \
	  --platform managed \
	  --region $(REGION) \
	  --project $(PROJECT_ID) \
	  --no-allow-unauthenticated \
	  --min-instances $(MIN_INSTANCES) \
	  --max-instances $(MAX_INSTANCES) \
	  --cpu $(CPU) \
	  --memory $(MEMORY) \
	  --timeout $(TIMEOUT) \
	  --concurrency $(CONCURRENCY) \
	  --ingress internal-and-cloud-load-balancing
	@echo ""
	@echo "[ok] âœ… Deployment completed (local build)"
	@echo ""
	@echo "[info] ğŸ“‹ Next steps:"
	@echo "  1. Verify deployment: make check PROJECT_ID=$(PROJECT_ID)"
	@echo "  2. Test: make test-direct PROJECT_ID=$(PROJECT_ID)"


## ============================================================
## å‹•ä½œç¢ºèªï¼ˆèªè¨¼ä»˜ããƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
## æ³¨æ„:
##   ingress=internal-and-cloud-load-balancing ã®å ´åˆã€
##   *.a.run.app ã¸ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã¯ 404 ã«ãªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
##   æœ¬ç•ªã§ã¯ LB çµŒç”±ï¼ˆhttps://sanbou-app.jp/ï¼‰ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚
##   ç›´æ¥ãƒ†ã‚¹ãƒˆã™ã‚‹å ´åˆã¯ 'make test-direct' ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚
## ============================================================
test:
	@if [ -z "$(PROJECT_ID)" ]; then \
	  echo "[error] PROJECT_ID is required."; \
	  echo "Usage: make test PROJECT_ID=your-project-id"; \
	  exit 1; \
	fi
	@echo "[info] âš ï¸  NOTE: This test may return 404 due to ingress restrictions."
	@echo "       For production testing, use LB URL (https://sanbou-app.jp/)"
	@echo "       For direct URL test, use: make test-direct PROJECT_ID=$(PROJECT_ID)"
	@echo ""
	@SERVICE_URL=$$(gcloud run services describe $(SERVICE_NAME) \
	  --region $(REGION) \
	  --project $(PROJECT_ID) \
	  --format="value(status.url)" 2>/dev/null); \
	if [ -z "$$SERVICE_URL" ]; then \
	  echo "[error] âŒ Service not found."; \
	  echo "Deploy first: make deploy PROJECT_ID=$(PROJECT_ID)"; \
	  exit 1; \
	fi; \
	echo "[info] Service URL: $$SERVICE_URL"; \
	TOKEN=$$(gcloud auth print-identity-token --audiences="$$SERVICE_URL" 2>/dev/null); \
	if [ -z "$$TOKEN" ]; then \
	  echo "[error] âŒ Failed to get identity token."; \
	  echo "Run: gcloud auth login"; \
	  exit 1; \
	fi; \
	echo "[info] Sending authenticated request..."; \
	echo ""; \
	RESPONSE=$$(curl -s -o /tmp/maintenance-test.html -w "%%{http_code}" -H "Authorization: Bearer $$TOKEN" "$$SERVICE_URL"); \
	if [ "$$RESPONSE" = "503" ]; then \
	  echo "[ok] âœ… HTTP 503 received - maintenance page is working!"; \
	  head -20 /tmp/maintenance-test.html | grep -q "ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­" && echo "[ok] âœ… HTML content verified"; \
	elif [ "$$RESPONSE" = "404" ]; then \
	  echo "[warn] âš ï¸  HTTP 404 - This is expected with ingress=internal-and-cloud-load-balancing"; \
	  echo "[info] The service is deployed but not accessible via direct URL."; \
	  echo "[info] Test via LB or use: make test-direct PROJECT_ID=$(PROJECT_ID)"; \
	else \
	  echo "[error] âŒ Unexpected response: HTTP $$RESPONSE"; \
	  curl -i -H "Authorization: Bearer $$TOKEN" "$$SERVICE_URL"; \
	fi; \
	rm -f /tmp/maintenance-test.html

## ============================================================
## ç›´æ¥URLå‹•ä½œç¢ºèªï¼ˆä¸€æ™‚çš„ã« ingress=all ã«å¤‰æ›´ã—ã¦ãƒ†ã‚¹ãƒˆï¼‰
## æ³¨æ„: çŸ­æ™‚é–“ã ã‘å…¬é–‹çŠ¶æ…‹ã«ãªã‚Šã¾ã™ã€‚ãƒ†ã‚¹ãƒˆå¾Œã™ãã«æˆ»ã—ã¾ã™ã€‚
## ============================================================
test-direct:
	@if [ -z "$(PROJECT_ID)" ]; then \
	  echo "[error] PROJECT_ID is required."; \
	  exit 1; \
	fi
	@echo "[warn] âš ï¸  This will temporarily change ingress to 'all'"
	@echo "[warn] Testing and reverting in 30 seconds..."
	@echo ""
	@SERVICE_URL=$$(gcloud run services describe $(SERVICE_NAME) \
	  --region $(REGION) \
	  --project $(PROJECT_ID) \
	  --format="value(status.url)" 2>/dev/null); \
	if [ -z "$$SERVICE_URL" ]; then \
	  echo "[error] âŒ Service not found."; \
	  exit 1; \
	fi; \
	echo "[info] Step 1/4: Setting ingress=all temporarily..."; \
	gcloud run services update $(SERVICE_NAME) \
	  --region=$(REGION) \
	  --project=$(PROJECT_ID) \
	  --ingress=all \
	  --quiet; \
	sleep 5; \
	echo ""; \
	echo "[info] Step 2/4: Allowing unauthenticated access temporarily..."; \
	gcloud run services add-iam-policy-binding $(SERVICE_NAME) \
	  --region=$(REGION) \
	  --project=$(PROJECT_ID) \
	  --member="allUsers" \
	  --role="roles/run.invoker" \
	  --quiet; \
	sleep 5; \
	echo ""; \
	echo "[info] Step 3/4: Testing direct URL (no auth)..."; \
	RESPONSE=$$(curl -s -o /tmp/maintenance-test-direct.html -w "%%{http_code}" "$$SERVICE_URL"); \
	if [ "$$RESPONSE" = "503" ]; then \
	  echo "[ok] âœ… HTTP 503 received - maintenance page is working!"; \
	  head -20 /tmp/maintenance-test-direct.html | grep -q "ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ä¸­" && echo "[ok] âœ… HTML content verified"; \
	else \
	  echo "[error] âŒ Unexpected response: HTTP $$RESPONSE"; \
	  curl -i "$$SERVICE_URL"; \
	fi; \
	rm -f /tmp/maintenance-test-direct.html; \
	echo ""; \
	echo "[info] Step 4/4: Reverting security settings..."; \
	gcloud run services remove-iam-policy-binding $(SERVICE_NAME) \
	  --region=$(REGION) \
	  --project=$(PROJECT_ID) \
	  --member="allUsers" \
	  --role="roles/run.invoker" \
	  --quiet; \
	gcloud run services update $(SERVICE_NAME) \
	  --region=$(REGION) \
	  --project=$(PROJECT_ID) \
	  --ingress=internal-and-cloud-load-balancing \
	  --quiet; \
	echo "[ok] âœ… Security settings reverted. Test completed."

## ============================================================
## ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª
## ============================================================
check:
	@if [ -z "$(PROJECT_ID)" ]; then \
	  echo "[error] PROJECT_ID is required."; \
	  echo "Usage: make check PROJECT_ID=your-project-id"; \
	  exit 1; \
	fi
	@echo "[info] Checking Cloud Run service status"
	@gcloud run services describe $(SERVICE_NAME) \
	  --region $(REGION) \
	  --project $(PROJECT_ID) \
	  --format="table(status.url,status.conditions[0].status,status.conditions[0].type)" 2>/dev/null || \
	  echo "[warn] âš ï¸  Service not deployed yet"

## ============================================================
## IAP Service Agent è¨­å®š
## ============================================================
setup-iap:
	@if [ -z "$(PROJECT_ID)" ]; then \
	  echo "[error] PROJECT_ID is required."; \
	  echo "Usage: make setup-iap PROJECT_ID=your-project-id"; \
	  exit 1; \
	fi
	@echo "[info] Setting up IAP Service Agent for Cloud Run invoker"
	@echo ""
	@echo "[info] Step 1/3: Create IAP service identity"
	@gcloud beta services identity create \
	  --service=iap.googleapis.com \
	  --project=$(PROJECT_ID) 2>/dev/null || echo "[info] Identity may already exist"
	@echo ""
	@echo "[info] Step 2/3: Get project number"
	@PROJECT_NUMBER=$$(gcloud projects describe $(PROJECT_ID) --format="value(projectNumber)"); \
	echo "[info] Project Number: $$PROJECT_NUMBER"; \
	echo ""; \
	echo "[info] Step 3/3: Grant roles/run.invoker to IAP Service Agent"; \
	gcloud run services add-iam-policy-binding $(SERVICE_NAME) \
	  --region=$(REGION) \
	  --project=$(PROJECT_ID) \
	  --member="serviceAccount:service-$$PROJECT_NUMBER@gcp-sa-iap.iam.gserviceaccount.com" \
	  --role="roles/run.invoker"
	@echo ""
	@echo "[ok] âœ… IAP setup completed"
	@echo ""
	@echo "[info] Now you can access the service via IAP + Load Balancer"

## ============================================================
## ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆã‚µãƒ¼ãƒ“ã‚¹å‰Šé™¤ï¼‰
## ============================================================
clean:
	@if [ -z "$(PROJECT_ID)" ]; then \
	  echo "[error] PROJECT_ID is required."; \
	  echo "Usage: make clean PROJECT_ID=your-project-id"; \
	  exit 1; \
	fi
	@echo "[warn] âš ï¸  This will DELETE the Cloud Run service: $(SERVICE_NAME)"
	@echo "[warn] Project: $(PROJECT_ID)"
	@echo "[warn] Region: $(REGION)"
	@echo ""
	@read -p "Are you sure? (yes/no): " confirm; \
	if [ "$$confirm" = "yes" ]; then \
	  echo "[info] Deleting service..."; \
	  gcloud run services delete $(SERVICE_NAME) \
	    --region $(REGION) \
	    --project $(PROJECT_ID) \
	    --quiet; \
	  echo "[ok] âœ… Service deleted"; \
	else \
	  echo "[info] Cancelled"; \
	fi

## ============================================================

## ============================================================
## ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ ONï¼ˆæœ¬ç•ª â†’ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒšãƒ¼ã‚¸ï¼‰
## ============================================================
maintenance-on:
	@if [ -z "$(PROJECT_ID)" ]; then \
	  echo "[error] PROJECT_ID is required."; \
	  echo "Usage: make maintenance-on PROJECT_ID=your-project-id"; \
	  exit 1; \
	fi
	@echo "[info] ğŸ”§ Switching to MAINTENANCE MODE"
	@echo "       URL Map: $(URL_MAP_NAME)"
	@echo "       Backend: $(PROD_BACKEND_SERVICE) â†’ $(MAINTENANCE_BACKEND_SERVICE)"
	@echo ""
	@CURRENT=$$(gcloud compute url-maps describe $(URL_MAP_NAME) \
	  --global \
	  --project=$(PROJECT_ID) \
	  --format="value(defaultService)" 2>/dev/null | grep -o '[^/]*$$'); \
	if [ "$$CURRENT" = "$(MAINTENANCE_BACKEND_SERVICE)" ]; then \
	  echo "[warn] âš ï¸  Already in maintenance mode"; \
	  exit 0; \
	fi; \
	gcloud compute url-maps set-default-service $(URL_MAP_NAME) \
	  --default-service $(MAINTENANCE_BACKEND_SERVICE) \
	  --global \
	  --project=$(PROJECT_ID)
	@echo ""
	@echo "[ok] âœ… Maintenance mode ON"
	@echo "[info] Access: https://honest.sanbou-app.jp/"
	@echo "[info] Users will see HTTP 503 maintenance page"
	@echo ""
	@echo "[info] To exit maintenance mode:"
	@echo "       make maintenance-off PROJECT_ID=$(PROJECT_ID)"

## ============================================================
## ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ OFFï¼ˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒšãƒ¼ã‚¸ â†’ æœ¬ç•ªï¼‰
## ============================================================
maintenance-off:
	@if [ -z "$(PROJECT_ID)" ]; then \
	  echo "[error] PROJECT_ID is required."; \
	  echo "Usage: make maintenance-off PROJECT_ID=your-project-id"; \
	  exit 1; \
	fi
	@echo "[info] âœ… Switching to PRODUCTION MODE"
	@echo "       URL Map: $(URL_MAP_NAME)"
	@echo "       Backend: $(MAINTENANCE_BACKEND_SERVICE) â†’ $(PROD_BACKEND_SERVICE)"
	@echo ""
	@CURRENT=$$(gcloud compute url-maps describe $(URL_MAP_NAME) \
	  --global \
	  --project=$(PROJECT_ID) \
	  --format="value(defaultService)" 2>/dev/null | grep -o '[^/]*$$'); \
	if [ "$$CURRENT" = "$(PROD_BACKEND_SERVICE)" ]; then \
	  echo "[warn] âš ï¸  Already in production mode"; \
	  exit 0; \
	fi; \
	gcloud compute url-maps set-default-service $(URL_MAP_NAME) \
	  --default-service $(PROD_BACKEND_SERVICE) \
	  --global \
	  --project=$(PROJECT_ID)
	@echo ""
	@echo "[ok] âœ… Production mode ON"
	@echo "[info] Access: https://honest.sanbou-app.jp/"
	@echo "[info] Application is now serving normally"

## ============================================================
## ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰çŠ¶æ…‹ç¢ºèª
## ============================================================
maintenance-status:
	@if [ -z "$(PROJECT_ID)" ]; then \
	  echo "[error] PROJECT_ID is required."; \
	  echo "Usage: make maintenance-status PROJECT_ID=your-project-id"; \
	  exit 1; \
	fi
	@echo "[info] Checking maintenance mode status..."
	@echo ""
	@CURRENT=$$(gcloud compute url-maps describe $(URL_MAP_NAME) \
	  --global \
	  --project=$(PROJECT_ID) \
	  --format="value(defaultService)" 2>/dev/null | grep -o '[^/]*$$'); \
	echo "[info] URL Map: $(URL_MAP_NAME)"; \
	echo "[info] Current Backend: $$CURRENT"; \
	echo ""; \
	if [ "$$CURRENT" = "$(MAINTENANCE_BACKEND_SERVICE)" ]; then \
	  echo "[status] ğŸ”§ MAINTENANCE MODE (503 page active)"; \
	elif [ "$$CURRENT" = "$(PROD_BACKEND_SERVICE)" ]; then \
	  echo "[status] âœ… PRODUCTION MODE (app running)"; \
	else \
	  echo "[status] âš ï¸  UNKNOWN MODE ($$CURRENT)"; \
	fi
