## =============================================================
## Makefile : „É°„É≥„ÉÜ„Éä„É≥„ÇπÈÅãÁî®„ÉÑ„Éº„É´Ôºàops/maintenance/Ôºâ
## =============================================================
##
## ÁõÆÁöÑ:
##   - Cloud Run „É°„É≥„ÉÜ„Éä„É≥„Çπ„Éö„Éº„Ç∏„ÅÆÁÆ°ÁêÜ
##   - „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥Êú¨‰Ωì„Å®„ÅØÁã¨Á´ã„Åó„ÅüÈÅãÁî®„ÉÑ„Éº„É´
##
## ‰Ωø„ÅÑÊñπ:
##   cd ops/maintenance
##   make deploy PROJECT_ID=honest-sanbou-app-prod
##   make test PROJECT_ID=honest-sanbou-app-prod
##   make setup-iap PROJECT_ID=honest-sanbou-app-prod
##
## „Åæ„Åü„ÅØ„ÄÅ„É´„Éº„Éà„Éá„Ç£„É¨„ÇØ„Éà„É™„Åã„Çâ:
##   make -C ops/maintenance deploy PROJECT_ID=honest-sanbou-app-prod
##
## =============================================================

## „Éá„Éï„Ç©„É´„ÉàË®≠ÂÆö
SERVICE_NAME ?= maintenance-page
REGION ?= asia-northeast1
PROJECT_ID ?=

# Cloud Run „ÅÆË®≠ÂÆö
MIN_INSTANCES ?= 0
MAX_INSTANCES ?= 10
CPU ?= 1
MEMORY ?= 256Mi
TIMEOUT ?= 10s
CONCURRENCY ?= 80

# „Éá„Ç£„É¨„ÇØ„Éà„É™
CLOUDRUN_DIR := cloudrun

.PHONY: help deploy test check setup-iap setup-cloudbuild-permissions clean

## ============================================================
## „Éò„É´„Éó
## ============================================================
help:
	@echo "=== „É°„É≥„ÉÜ„Éä„É≥„ÇπÈÅãÁî® Makefile ==="
	@echo ""
	@echo "ÂâçÊèêÊù°‰ª∂:"
	@echo "  PROJECT_ID=xxx „ÇíÊåáÂÆö„Åó„Å¶ÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
	@echo ""
	@echo "ÂàùÂõû„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó:"
	@echo "  make setup-cloudbuild-permissions PROJECT_ID=xxx"
	@echo "  make deploy PROJECT_ID=xxx"
	@echo "  make setup-iap PROJECT_ID=xxx"
	@echo ""
	@echo "„Çà„Åè‰Ωø„ÅÜ„Ç≥„Éû„É≥„Éâ:"
	@echo "  make deploy PROJECT_ID=xxx     - Cloud Run „Å´„Éá„Éó„É≠„Ç§"
	@echo "  make test PROJECT_ID=xxx       - Âãï‰ΩúÁ¢∫Ë™çÔºàË™çË®º‰ªò„Åç„É™„ÇØ„Ç®„Çπ„ÉàÔºâ"
	@echo "  make check PROJECT_ID=xxx      - „Çµ„Éº„Éì„ÇπÁä∂ÊÖãÁ¢∫Ë™ç"
	@echo ""
	@echo "„Éà„É©„Éñ„É´„Ç∑„É•„Éº„ÉÜ„Ç£„É≥„Ç∞:"
	@echo "  make setup-cloudbuild-permissions PROJECT_ID=xxx"
	@echo ""
	@echo "Ë®≠ÂÆö:"
	@echo "  SERVICE_NAME = $(SERVICE_NAME)"
	@echo "  REGION       = $(REGION)"
	@echo "  MIN_INSTANCES= $(MIN_INSTANCES)"
	@echo "  MAX_INSTANCES= $(MAX_INSTANCES)"
	@echo "  CPU          = $(CPU)"
	@echo "  MEMORY       = $(MEMORY)"
	@echo ""

## ============================================================
## Cloud Build Ê®©ÈôêË®≠ÂÆöÔºàÂàùÂõû„Éá„Éó„É≠„Ç§Ââç„Å´ÂøÖÈ†àÔºâ
## ============================================================
setup-cloudbuild-permissions:
	@if [ -z "$(PROJECT_ID)" ]; then \
	  echo "[error] PROJECT_ID is required."; \
	  echo "Usage: make setup-cloudbuild-permissions PROJECT_ID=your-project-id"; \
	  exit 1; \
	fi
	@echo "[info] Setting up Cloud Build permissions for project $(PROJECT_ID)"
	@PROJECT_NUMBER=$$(gcloud projects describe $(PROJECT_ID) --format="value(projectNumber)"); \
	echo "[info] Project Number: $$PROJECT_NUMBER"; \
	echo ""; \
	echo "[info] Granting required roles to service accounts..."; \
	echo "  1. Storage Admin to Compute Engine default SA"; \
	gcloud projects add-iam-policy-binding $(PROJECT_ID) \
	  --member="serviceAccount:$$PROJECT_NUMBER-compute@developer.gserviceaccount.com" \
	  --role="roles/storage.admin" \
	  --condition=None && \
	echo "  2. Cloud Run Admin to Cloud Build SA"; \
	gcloud projects add-iam-policy-binding $(PROJECT_ID) \
	  --member="serviceAccount:$$PROJECT_NUMBER@cloudbuild.gserviceaccount.com" \
	  --role="roles/run.admin" \
	  --condition=None && \
	echo "  3. Service Account User to Cloud Build SA"; \
	gcloud projects add-iam-policy-binding $(PROJECT_ID) \
	  --member="serviceAccount:$$PROJECT_NUMBER@cloudbuild.gserviceaccount.com" \
	  --role="roles/iam.serviceAccountUser" \
	  --condition=None
	@echo ""
	@echo "[ok] ‚úÖ Cloud Build permissions configured successfully"
	@echo "[info] ‚è±Ô∏è  Permissions may take a few minutes to propagate"
	@echo ""
	@echo "Next step: make deploy PROJECT_ID=$(PROJECT_ID)"

## ============================================================
## Cloud Run „Éá„Éó„É≠„Ç§
## ============================================================
deploy:
	@if [ -z "$(PROJECT_ID)" ]; then \
	  echo "[error] PROJECT_ID is required."; \
	  echo "Usage: make deploy PROJECT_ID=your-project-id"; \
	  exit 1; \
	fi
	@echo "[info] Deploying maintenance page to Cloud Run"
	@echo "       Project: $(PROJECT_ID)"
	@echo "       Region: $(REGION)"
	@echo "       Service: $(SERVICE_NAME)"
	@echo ""
	@echo "[info] ‚ö†Ô∏è  First-time deployment?"
	@echo "       If you get permission errors, run:"
	@echo "       make setup-cloudbuild-permissions PROJECT_ID=$(PROJECT_ID)"
	@echo ""
	cd $(CLOUDRUN_DIR) && \
	gcloud run deploy $(SERVICE_NAME) \
	  --source . \
	  --platform managed \
	  --region $(REGION) \
	  --project $(PROJECT_ID) \
	  --no-allow-unauthenticated \
	  --min-instances $(MIN_INSTANCES) \
	  --max-instances $(MAX_INSTANCES) \
	  --cpu $(CPU) \
	  --memory $(MEMORY) \
	  --timeout $(TIMEOUT) \
	  --concurrency $(CONCURRENCY) \
	  --ingress internal-and-cloud-load-balancing
	@echo ""
	@echo "[ok] ‚úÖ Deployment completed"
	@echo ""
	@echo "[info] üìã Next steps:"
	@echo "  1. Configure IAP Service Agent:"
	@echo "     make setup-iap PROJECT_ID=$(PROJECT_ID)"
	@echo ""
	@echo "  2. Verify deployment:"
	@echo "     make test PROJECT_ID=$(PROJECT_ID)"
	@echo ""
	@echo "  3. See cloudrun/README.md for LB configuration"

## ============================================================
## Âãï‰ΩúÁ¢∫Ë™çÔºàË™çË®º‰ªò„Åç„É™„ÇØ„Ç®„Çπ„ÉàÔºâ
## ============================================================
test:
	@if [ -z "$(PROJECT_ID)" ]; then \
	  echo "[error] PROJECT_ID is required."; \
	  echo "Usage: make test PROJECT_ID=your-project-id"; \
	  exit 1; \
	fi
	@echo "[info] Testing maintenance page (authenticated request)"
	@SERVICE_URL=$$(gcloud run services describe $(SERVICE_NAME) \
	  --region $(REGION) \
	  --project $(PROJECT_ID) \
	  --format="value(status.url)" 2>/dev/null); \
	if [ -z "$$SERVICE_URL" ]; then \
	  echo "[error] ‚ùå Service not found."; \
	  echo "Deploy first: make deploy PROJECT_ID=$(PROJECT_ID)"; \
	  exit 1; \
	fi; \
	TOKEN=$$(gcloud auth print-identity-token 2>/dev/null); \
	if [ -z "$$TOKEN" ]; then \
	  echo "[error] ‚ùå Failed to get identity token."; \
	  echo "Run: gcloud auth login"; \
	  exit 1; \
	fi; \
	echo "[info] Service URL: $$SERVICE_URL"; \
	echo "[info] Sending authenticated request..."; \
	echo ""; \
	curl -i -H "Authorization: Bearer $$TOKEN" "$$SERVICE_URL" || true
	@echo ""
	@echo "[info] ‚úÖ If you see HTTP 503 with maintenance page HTML, it's working!"

## ============================================================
## „Çµ„Éº„Éì„ÇπÁä∂ÊÖãÁ¢∫Ë™ç
## ============================================================
check:
	@if [ -z "$(PROJECT_ID)" ]; then \
	  echo "[error] PROJECT_ID is required."; \
	  echo "Usage: make check PROJECT_ID=your-project-id"; \
	  exit 1; \
	fi
	@echo "[info] Checking Cloud Run service status"
	@gcloud run services describe $(SERVICE_NAME) \
	  --region $(REGION) \
	  --project $(PROJECT_ID) \
	  --format="table(status.url,status.conditions[0].status,status.conditions[0].type)" 2>/dev/null || \
	  echo "[warn] ‚ö†Ô∏è  Service not deployed yet"

## ============================================================
## IAP Service Agent Ë®≠ÂÆö
## ============================================================
setup-iap:
	@if [ -z "$(PROJECT_ID)" ]; then \
	  echo "[error] PROJECT_ID is required."; \
	  echo "Usage: make setup-iap PROJECT_ID=your-project-id"; \
	  exit 1; \
	fi
	@echo "[info] Setting up IAP Service Agent for Cloud Run invoker"
	@echo ""
	@echo "[info] Step 1/3: Create IAP service identity"
	@gcloud beta services identity create \
	  --service=iap.googleapis.com \
	  --project=$(PROJECT_ID) 2>/dev/null || echo "[info] Identity may already exist"
	@echo ""
	@echo "[info] Step 2/3: Get project number"
	@PROJECT_NUMBER=$$(gcloud projects describe $(PROJECT_ID) --format="value(projectNumber)"); \
	echo "[info] Project Number: $$PROJECT_NUMBER"; \
	echo ""; \
	echo "[info] Step 3/3: Grant roles/run.invoker to IAP Service Agent"; \
	gcloud run services add-iam-policy-binding $(SERVICE_NAME) \
	  --region=$(REGION) \
	  --project=$(PROJECT_ID) \
	  --member="serviceAccount:service-$$PROJECT_NUMBER@gcp-sa-iap.iam.gserviceaccount.com" \
	  --role="roles/run.invoker"
	@echo ""
	@echo "[ok] ‚úÖ IAP setup completed"
	@echo ""
	@echo "[info] Now you can access the service via IAP + Load Balancer"

## ============================================================
## „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÔºà„Çµ„Éº„Éì„ÇπÂâäÈô§Ôºâ
## ============================================================
clean:
	@if [ -z "$(PROJECT_ID)" ]; then \
	  echo "[error] PROJECT_ID is required."; \
	  echo "Usage: make clean PROJECT_ID=your-project-id"; \
	  exit 1; \
	fi
	@echo "[warn] ‚ö†Ô∏è  This will DELETE the Cloud Run service: $(SERVICE_NAME)"
	@echo "[warn] Project: $(PROJECT_ID)"
	@echo "[warn] Region: $(REGION)"
	@echo ""
	@read -p "Are you sure? (yes/no): " confirm; \
	if [ "$$confirm" = "yes" ]; then \
	  echo "[info] Deleting service..."; \
	  gcloud run services delete $(SERVICE_NAME) \
	    --region $(REGION) \
	    --project $(PROJECT_ID) \
	    --quiet; \
	  echo "[ok] ‚úÖ Service deleted"; \
	else \
	  echo "[info] Cancelled"; \
	fi
