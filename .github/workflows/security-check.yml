name: Security Check - Prevent Secrets Leak

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # å…¨å±¥æ­´ã‚’å–å¾—

      - name: Check for forbidden files
        run: |
          echo "ğŸ” æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚§ãƒƒã‚¯..."

          # Git è¿½è·¡å¯¾è±¡ã«æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯
          FORBIDDEN_FILES=$(git ls-tree -r HEAD --name-only | grep -E '^(env/\.env\.|secrets/\.env\..*\.secrets$|secrets/gcp-sa.*\.json$|.*\.pem$|.*\.key$)' | grep -v -E '\.(example|template)$' || true)

          if [ -n "$FORBIDDEN_FILES" ]; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "$FORBIDDEN_FILES"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          fi

          echo "âœ… æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"

      - name: Check for secrets in code
        run: |
          echo "ğŸ” æ©Ÿå¯†æƒ…å ±ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒã‚§ãƒƒã‚¯..."

          # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚„ API ã‚­ãƒ¼ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œç´¢
          if git grep -E 'POSTGRES_PASSWORD\s*=\s*['\''"][^$][^'\''"]+['\''"]' HEAD -- '*.py' '*.sh' '*.yml' '*.yaml' '*.json' '*.ts' '*.js' 2>/dev/null; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            exit 1
          fi

          if git grep -E '-----BEGIN.*PRIVATE KEY-----' HEAD 2>/dev/null; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: ç§˜å¯†éµãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            exit 1
          fi

          if git grep -E '(api|secret|token).*[kK]ey\s*[:=]\s*['\''"][A-Za-z0-9+/]{40,}' HEAD -- '*.py' '*.sh' '*.yml' '*.yaml' '*.json' '*.ts' '*.js' 2>/dev/null; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: API ã‚­ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            exit 1
          fi

          echo "âœ… æ©Ÿå¯†æƒ…å ±ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"

      - name: Verify .gitignore
        run: |
          echo "ğŸ” .gitignore ã®æ¤œè¨¼..."

          if ! grep -q '^/env/' .gitignore; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: .gitignore ã« '/env/' ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi

          if ! grep -q '^/secrets/' .gitignore; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: .gitignore ã« '/secrets/' ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 1
          fi

          echo "âœ… .gitignore ã¯æ­£å¸¸ã§ã™"

      - name: Check Git history
        if: github.event_name == 'push'
        run: |
          echo "ğŸ” Git å±¥æ­´ã®ãƒã‚§ãƒƒã‚¯..."

          # ç›´è¿‘ã®ã‚³ãƒŸãƒƒãƒˆã§æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¿½åŠ ã•ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
          if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }}..${{ github.sha }} | grep -E '^(env/\.env\.|secrets/)' | grep -v -E '\.(example|template)$' || true)

            if [ -n "$CHANGED_FILES" ]; then
              echo "âŒ è­¦å‘Š: æ©Ÿå¯†ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™"
              echo "$CHANGED_FILES"
              exit 1
            fi
          fi

          echo "âœ… å±¥æ­´ãƒã‚§ãƒƒã‚¯å®Œäº†"

      - name: Security summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… ã™ã¹ã¦ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã«åˆæ ¼ã—ã¾ã—ãŸ"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
