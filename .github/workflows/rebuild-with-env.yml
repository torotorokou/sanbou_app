# Workflow: Build (make rebuild) using Environment-scoped Secrets
# - ブランチ/dev, stg, prod か、手動入力の env に応じて ENV_NAME を決定
# - Environment Secrets から env/.env.common を生成し、make rebuild 実行

name: Rebuild with env secrets

on:
  push:
    branches: [dev, stg, prod]
  workflow_dispatch:
    inputs:
      env:
        description: "Environment to use (dev/stg/prod)"
        required: true
        type: choice
        options: [dev, stg, prod]

jobs:
  rebuild:
    runs-on: ubuntu-latest
    name: rebuild (${{ github.event_name == 'workflow_dispatch' && inputs.env || github.ref_name }})

    steps:
      # 1) Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Determine ENV_NAME
      - name: Determine ENV_NAME
        id: set-env
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV_NAME="${{ inputs.env }}"
          else
            ENV_NAME="${{ github.ref_name }}"
          fi
          echo "ENV_NAME=${ENV_NAME}" >> "$GITHUB_ENV"
          echo "Using ENV_NAME=${ENV_NAME}"

      # 3) Create env/.env.common from Environment secrets
      - name: Create env/.env.common from Environment secrets
        env:
          ENV_COMMON: ${{ secrets.ENV_COMMON }}
          ENV_SPECIFIC: ${{ secrets.ENV_SPECIFIC }}
        shell: bash
        run: |
          mkdir -p env
          printf "%s\n" "$ENV_COMMON" > env/.env.common
          if [ -n "${ENV_SPECIFIC:-}" ]; then
            printf "\n%s\n" "$ENV_SPECIFIC" >> env/.env.common
          fi
          if [ ! -s env/.env.common ]; then
            echo "env/.env.common was not created or is empty"
            exit 1
          fi

      # 4) Verify file exists (no contents shown)
      - name: Verify env/.env.common exists (no contents shown)
        shell: bash
        run: |
          ls -l env
          echo "env/.env.common size (bytes): $(wc -c < env/.env.common)"

      # 5) make rebuild
      - name: Run make rebuild
        shell: bash
        run: |
          make rebuild ENV="$ENV_NAME"
