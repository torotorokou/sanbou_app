name: Production Compose Config & Rebuild

# Security hardening:
# - Skip on forked PRs (compose may touch env/secrets).
# - Do not use pull_request_target.
# - Minimal token perms.
permissions:
  contents: read

on:
  push:
    branches: [ feat_stgenv ]
  pull_request:
    branches: [ feat_stgenv ]

env:
  STAGE: ${{ vars.STAGE || 'prod' }}
  REGION: ${{ vars.REGION || 'asia-northeast1' }}

jobs:
  compose-prod:
    if: ${{ github.event_name == 'pull_request' ? (github.event.pull_request.head.repo.fork == false) : true }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
    - name: Show compose config (${{ env.STAGE }})
        run: |
      make config ENV=${STAGE} | sed -n '1,160p'
        # Do not dump secrets to logs. Keep output minimal.
    - name: Build & Up (${{ env.STAGE }})
        run: |
      make rebuild ENV=${STAGE} || (echo "${STAGE} rebuild failed" && exit 1)
      - name: Show ps
        run: docker compose -p ${STAGE} ps
      - name: Down
        if: always()
        run: make down ENV=${STAGE}

      # Best practices:
      # - Temporary .env files must live in $RUNNER_TEMP and be deleted.
      # - Never upload secrets or config files as artifacts or cache.
      # - Use vars for public config; secrets only for credentials.
