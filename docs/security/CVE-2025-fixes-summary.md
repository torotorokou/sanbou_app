# セキュリティ脆弱性修正サマリー（2025年12月）

## 概要

Artifact Registry のコンテナイメージスキャンで検出された脆弱性に対応しました。本修正では、アプリケーションの挙動を変えずに、Python 依存関係と Dockerfile を安全な状態へアップデートしました。

## 修正対象の主要CVE

### Python パッケージ（修正可能）

| CVE | 重大度 | パッケージ | 修正内容 |
|-----|--------|-----------|---------|
| CVE-2025-62727 | 高 (7.5) | starlette | FastAPI >=0.115.7 経由で Starlette >=0.49.1 に更新 |
| CVE-2025-54121 | 中 (5.3) | starlette | 同上 |
| CVE-2024-47081 | 中 (5.3) | requests | requests >=2.32.4 に更新 |
| CVE-2025-8869 | 中 | pip | Dockerfile で pip を最新版に更新 |
| CVE-2025-6985 | 高 | langchain-text-splitters | langchain-text-splitters >=0.3.4 に更新 |
| CVE-2025-65106 | 高 | langchain-core | langchain-core >=0.3.28 に更新 |
| CVE-2025-6984 | 高 | langchain-community | langchain-community >=0.3.14 に更新 |
| CVE-2024-12797 | 低 (6.3) | cryptography | 依存パッケージ経由で更新予定 |

### OS パッケージ（修正なし）

glibc, systemd, tar, krb5, openldap, postgresql-17, curl, sqlite3, shadow, util-linux, ncurses, gnutls28, coreutils, apt, perl, nss, openjpeg2, poppler, cairo, libpng1.6, expat 等の OS パッケージについては、現時点でベンダーから修正が提供されていません。

対応策:
- `apt-get upgrade -y` をビルド時に実行し、利用可能な最新パッチを適用
- ベースイメージ (python:3.12-slim) の定期的な再ビルドで最新パッチを取得

---

## 【1. Python 依存関係の修正】

### 1.1 core_api

**ファイル**: `app/backend/core_api/requirements.txt`

**変更内容**:
```diff
- fastapi==0.115.6
+ # FastAPI >=0.115.7 uses Starlette >=0.49.1 (fixes CVE-2025-62727, CVE-2025-54121)
+ fastapi>=0.115.7,<0.200.0

- requests==2.32.3
+ # requests >=2.32.4 fixes CVE-2024-47081
+ requests>=2.32.4
```

**影響**: 
- Starlette の脆弱性 CVE-2025-62727（高）、CVE-2025-54121（中）を修正
- requests の脆弱性 CVE-2024-47081（中）を修正
- FastAPI の API インターフェースに互換性あり

---

### 1.2 rag_api

**ファイル**: `app/backend/rag_api/requirements.txt`

**変更内容**:
```diff
- fastapi==0.115.6
+ # FastAPI >=0.115.7 uses Starlette >=0.49.1 (fixes CVE-2025-62727, CVE-2025-54121)
+ fastapi>=0.115.7,<0.200.0

- langchain-community==0.3.13
- langchain-openai==0.2.13
- PyPDF2==3.0.1
+ # langchain-community >=0.3.14 fixes CVE-2025-6984
+ langchain-community>=0.3.14
+ # langchain-openai >=0.2.13 (keep current)
+ langchain-openai==0.2.13
+ # langchain-core >=0.3.28 fixes CVE-2025-65106
+ langchain-core>=0.3.28
+ # langchain-text-splitters >=0.3.4 fixes CVE-2025-6985
+ langchain-text-splitters>=0.3.4
+ # PyPDF2 is deprecated; consider migrating to pypdf (not pypdf2)
+ # However, CVE-2023-36464 affects pypdf2 only; PyPDF2 v3.0.1 is the new library
+ PyPDF2==3.0.1
```

**影響**:
- Starlette の脆弱性を修正
- langchain 系ライブラリの重大な脆弱性を修正
- PyPDF2 は v3.0.1 で問題なし（pypdf2 とは別ライブラリ）

---

### 1.3 ledger_api

**ファイル**: `app/backend/ledger_api/requirements.txt`

**変更内容**:
```diff
- fastapi==0.115.6
+ # FastAPI >=0.115.7 uses Starlette >=0.49.1 (fixes CVE-2025-62727, CVE-2025-54121)
+ fastapi>=0.115.7,<0.200.0
```

**影響**: Starlette の脆弱性を修正

---

### 1.4 manual_api

**ファイル**: `app/backend/manual_api/requirements.txt`

**変更内容**:
```diff
- fastapi==0.115.6
+ # FastAPI >=0.115.7 uses Starlette >=0.49.1 (fixes CVE-2025-62727, CVE-2025-54121)
+ fastapi>=0.115.7,<0.200.0
```

**影響**: Starlette の脆弱性を修正

---

### 1.5 ai_api

**ファイル**: `app/backend/ai_api/requirements.txt`

**変更内容**:
```diff
- fastapi==0.115.6
+ # FastAPI >=0.115.7 uses Starlette >=0.49.1 (fixes CVE-2025-62727, CVE-2025-54121)
+ fastapi>=0.115.7,<0.200.0

- requests==2.32.3
+ # requests >=2.32.4 fixes CVE-2024-47081
+ requests>=2.32.4
```

**影響**: Starlette と requests の脆弱性を修正

---

### 1.6 plan_worker

**ファイル**: `app/backend/plan_worker/requirements.txt`

**変更内容**: FastAPI を使用していないため変更なし

---

## 【2. Dockerfile の修正】

全ての Python バックエンドサービスの Dockerfile（core_api, rag_api, ledger_api, manual_api, plan_worker, ai_api）に対して、以下の修正を適用しました。

### 2.1 共通修正内容

#### wheelbuilder ステージ
```dockerfile
# Security: Update OS packages to patch vulnerabilities (glibc, systemd, etc.)
# Security: Upgrade pip to latest version to fix CVE-2025-8869
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
      build-essential \
      ca-certificates \
      curl \
      [その他必要なパッケージ] && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

COPY ./backend_shared /build/backend_shared
RUN python -m pip install --upgrade pip setuptools wheel && \
    cd /build/backend_shared && \
    pip wheel --no-deps . -w /wheels
```

**追加内容**:
- `apt-get upgrade -y`: OS パッケージのセキュリティアップデート適用
- `apt-get clean && rm -rf /var/lib/apt/lists/*`: イメージサイズ削減と不要ファイル削除
- `python -m pip install --upgrade pip`: pip を最新版に更新（CVE-2025-8869 対応）

#### dev ステージ
```dockerfile
# Security: Update OS packages to patch vulnerabilities
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
      [必要なパッケージ] && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    useradd -m -u 1000 -s /bin/bash appuser

# Security: Upgrade pip to latest version to fix CVE-2025-8869
RUN python -m pip install --upgrade pip && \
    pip install --no-cache-dir -r /backend/requirements.txt watchfiles
```

#### base ステージ (stg/prod用)
```dockerfile
# Security: Update OS packages to patch vulnerabilities
RUN apt-get update && \
    apt-get upgrade -y && \
    apt-get install -y --no-install-recommends \
      [必要なパッケージ] && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* && \
    useradd -m -u 1000 -s /bin/bash appuser

COPY --from=wheelbuilder /wheels /wheels
# Security: Upgrade pip to latest version to fix CVE-2025-8869
RUN python -m pip install --upgrade pip && \
    pip install --no-cache-dir /wheels/*.whl && \
    rm -rf /wheels
```

### 2.2 修正対象 Dockerfile 一覧

| サービス | Dockerfile パス | 修正ステージ |
|---------|----------------|-------------|
| core_api | `app/backend/core_api/Dockerfile` | wheelbuilder, dev, base |
| rag_api | `app/backend/rag_api/Dockerfile` | gcloud, wheelbuilder, dev, base |
| ledger_api | `app/backend/ledger_api/Dockerfile` | wheelbuilder, dev, base |
| manual_api | `app/backend/manual_api/Dockerfile` | wheelbuilder, dev, base |
| plan_worker | `app/backend/plan_worker/Dockerfile` | wheelbuilder, dev, base |
| ai_api | `app/backend/ai_api/Dockerfile` | wheelbuilder, dev, base |

### 2.3 不要パッケージの削除

**現状**: 開発環境（dev ステージ）で `git` と `build-essential` をインストールしていますが、これらは editable モードでの backend_shared インストールに必要なため維持します。

**将来的な改善案**: 本番環境（base/stg/prod ステージ）では、これらのツールは既に削除されており、最小限の構成となっています。

---

## 【3. アプリケーション挙動への影響】

### 3.1 互換性の確認

- **FastAPI**: 0.115.6 → >=0.115.7 は後方互換性あり
- **Starlette**: FastAPI 経由で 0.49.1+ に更新、API インターフェース変更なし
- **requests**: 2.32.3 → >=2.32.4 は後方互換性あり
- **langchain 系**: マイナーバージョンアップで互換性維持を想定

### 3.2 注意した点

1. **バージョン範囲指定**: `>=X.Y.Z,<X+1.0.0` の形式で、メジャーバージョンアップを避け、安全な範囲で更新
2. **Starlette の直接依存削除**: FastAPI の依存解決に任せ、バージョン競合を回避
3. **pip のアップグレード**: ビルド時のみ実行し、実行時コンテナでは pip install を行わない方針を維持

### 3.3 Clean Architecture への影響

**影響なし**: 今回の変更は外部ライブラリのバージョン更新のみであり、以下の構成要素には一切変更を加えていません。

- ドメインロジック (domain/)
- ユースケース (use_cases/)
- インフラ層 (infra/)
- プレゼンテーション層 (api/)

---

## 【4. 推奨テスト項目】

### 4.1 機能テスト

各サービスで以下のエンドポイントが正常に動作することを確認:

**core_api**:
- `GET /health` - ヘルスチェック
- `POST /api/v1/auth/login` - 認証
- `GET /api/v1/companies` - 企業一覧取得
- その他主要な CRUD エンドポイント

**rag_api**:
- `GET /health` - ヘルスチェック
- `POST /api/v1/search` - RAG 検索
- `POST /api/v1/documents/upload` - ドキュメントアップロード

**ledger_api**:
- `GET /health` - ヘルスチェック
- `POST /api/v1/ledger/export` - 帳簿エクスポート
- `GET /api/v1/reports` - レポート生成

**manual_api**:
- `GET /health` - ヘルスチェック
- `GET /api/v1/manuals` - マニュアル取得

**ai_api**:
- `GET /health` - ヘルスチェック
- `POST /api/v1/analyze` - AI 分析

**plan_worker**:
- データベース接続確認
- バッチジョブの実行確認

### 4.2 ユニットテスト

```bash
# 各サービスのテストを実行
cd app/backend/core_api && pytest tests/
cd app/backend/rag_api && pytest tests/
cd app/backend/ledger_api && pytest tests/
```

### 4.3 統合テスト

```bash
# Docker Compose で全サービスを起動
docker compose -f docker/docker-compose.dev.yml up -d

# ヘルスチェック
curl http://localhost:8000/health  # core_api
curl http://localhost:8001/health  # rag_api
curl http://localhost:8002/health  # ledger_api
curl http://localhost:8003/health  # manual_api
curl http://localhost:8004/health  # ai_api
```

### 4.4 セキュリティスキャン

修正後、再度 Artifact Registry でイメージをスキャンし、Python パッケージの脆弱性が解消されたことを確認:

```bash
# イメージをビルド & プッシュ
docker compose -f docker/docker-compose.prod.yml build
docker push [REGISTRY]/core_api:latest
docker push [REGISTRY]/rag_api:latest
# ... 他のサービスも同様

# GCP Console の Artifact Registry でスキャン結果を確認
```

---

## 【5. 残存する脆弱性への対応方針】

### 5.1 OS パッケージの脆弱性

以下の OS パッケージについては、現時点で修正パッチが提供されていません:

- **glibc** (CVE-2018-20796, CVE-2010-4756, CVE-2019-1010022, 他)
- **systemd** (CVE-2023-31439, CVE-2023-31437, CVE-2023-31438, CVE-2013-4392)
- **krb5** (CVE-2018-5709, CVE-2024-26458, CVE-2024-26461)
- **openldap** (CVE-2020-15719, CVE-2015-3276, CVE-2017-17740, CVE-2017-14159)
- **tar** (CVE-2005-2541)
- **curl** (CVE-2025-10966)
- **sqlite3** (CVE-2025-7709, CVE-2021-45346)
- **shadow** (CVE-2024-56433, CVE-2007-5686)
- **util-linux** (CVE-2025-14104, CVE-2022-0563)
- **ncurses** (CVE-2025-6141)
- **gnutls28** (CVE-2025-9820, CVE-2011-3389)
- **coreutils** (CVE-2017-18018, CVE-2025-5278)
- **apt** (CVE-2011-3374)
- **perl** (CVE-2011-4116)
- **postgresql-17** (CVE-2025-12818, CVE-2025-12817)

**対応方針**:

1. **ベースイメージの定期更新**: `python:3.12-slim` の最新版を定期的に取得
2. **apt-get upgrade の自動適用**: Dockerfile ビルド時に常に最新パッチを適用
3. **Dependabot / Renovate 設定**: ベースイメージの自動更新を検討
4. **リスク評価**: これらの多くは「最小」または古い CVE で、実際のエクスプロイトは限定的

### 5.2 nginx / frontend コンテナ

本修正は Python バックエンドに限定していますが、nginx や frontend コンテナについても同様の方針で更新を推奨:

- nginx ベースイメージの更新
- Node.js 依存関係の脆弱性スキャン

---

## 【6. デプロイ手順】

### 6.1 開発環境（local_dev）

```bash
# ブランチをチェックアウト
git checkout security/fix-vulnerabilities-2025-12

# コンテナを再ビルド
docker compose -f docker/docker-compose.dev.yml build

# 起動
docker compose -f docker/docker-compose.dev.yml up -d

# ログ確認
docker compose -f docker/docker-compose.dev.yml logs -f
```

### 6.2 ステージング環境（vm_stg）

```bash
# VM にログイン
ssh your-stg-vm

# リポジトリを更新
cd /path/to/sanbou_app
git pull origin security/fix-vulnerabilities-2025-12

# コンテナを再ビルド & 起動
docker compose -f docker/docker-compose.vm_stg.yml down
docker compose -f docker/docker-compose.vm_stg.yml build
docker compose -f docker/docker-compose.vm_stg.yml up -d

# ヘルスチェック
curl http://localhost:8000/health
```

### 6.3 本番環境（vm_prod / GCP）

```bash
# 本番環境へのデプロイ前に、ステージング環境で十分なテストを実施
# Cloud Build / Cloud Run / GKE へのデプロイは既存のCI/CDパイプラインに従う
```

---

## 【7. ロールバック手順】

万が一、問題が発生した場合:

```bash
# 前のブランチに戻る
git checkout refactor/env-3tier-architecture

# コンテナを再ビルド
docker compose -f docker/docker-compose.dev.yml down
docker compose -f docker/docker-compose.dev.yml build
docker compose -f docker/docker-compose.dev.yml up -d
```

---

## 【8. 今後の改善案】

1. **Dependabot / Renovate の導入**: 依存関係の自動更新
2. **定期的なセキュリティスキャン**: CI/CD パイプラインに組み込み
3. **ベースイメージの固定タグ化**: `python:3.12.X-slim` のように、具体的なバージョンを指定
4. **PyPDF2 から pypdf への移行**: rag_api で使用している PyPDF2 は既に最新版ですが、将来的に `pypdf` (pypdf2 ではない) への移行を検討
5. **不要な開発ツールの削除**: dev ステージで `vim` などの不要ツールが残っていないか再確認

---

## 【9. 参考資料】

- [FastAPI Security Advisory](https://github.com/tiangolo/fastapi/security/advisories)
- [Starlette Security Advisory](https://github.com/encode/starlette/security/advisories)
- [requests CVE-2024-47081](https://nvd.nist.gov/vuln/detail/CVE-2024-47081)
- [pip CVE-2025-8869](https://nvd.nist.gov/vuln/detail/CVE-2025-8869)
- [langchain Security Advisories](https://github.com/langchain-ai/langchain/security/advisories)

---

**作成日**: 2025年12月8日  
**作成者**: Security/DevOps Team  
**レビュー状態**: Draft
