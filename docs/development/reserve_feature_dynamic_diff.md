# 予約特徴量の動的比較レポート

**作成日**: 2025-12-19  
**目的**: 同一入力データで旧版・現状の予約特徴量生成を実行し、出力差分を定量評価

## 1. 実験設定

### 1.1 入力データ

**共通入力**:
- ソース: tmp/legacy_release/inbound_forecast_worker/data/input/yoyaku_data.csv
- 行数: 53,399行
- 期間: 2023-01-04 ～ 2025-10-31
- 形式: 1企業1行（予約日, 予約得意先名, 固定客, 台数）

**サンプルデータ**:
```csv
予約日,予約得意先名,固定客,台数
2023/1/4,アンデス,False,1.0
2023/1/4,リサイクルレスキュー,False,1.0
2023/1/4,山口興業,False,2.0
```

### 1.2 処理フロー

#### 旧版（Legacy）
```
yoyaku_data.csv (53,399行、1企業1行)
  ↓
固定客列: Boolean → 1/0に変換
  ↓
日次groupby集計:
  - reserve_count = size() → 企業数
  - reserve_sum = sum(台数) → 台数合計
  - fixed_ratio = mean(固定客) → 固定客企業数/総企業数
  ↓
legacy_reserve_features.csv (944日)
```

#### 現状（Current、DB方式シミュレート）
```
yoyaku_data.csv (53,399行、1企業1行)
  ↓
日次集計（DB相当の前処理）:
  - 台数: sum(台数)
  - 固定客: sum(固定客フラグ * 台数) → 固定客台数合計
  ↓
DB形式データ (944日、1日1行)
  ↓
preprocess_reserve()を通過:
  - reserve_count = size() → 常に1（既に日次集計済み）
  - reserve_sum = sum(台数) → そのまま
  - fixed_ratio = mean(固定客) → 固定客台数の平均（意味不明）
  ↓
current_reserve_features.csv (944日)
```

## 2. 出力データ比較

### 2.1 統計サマリー

| 特徴量 | 旧版（Legacy） | 現状（Current） | 差異 |
|--------|---------------|----------------|------|
| **行数** | 944日 | 944日 | 同一 |
| **reserve_count** | - | - | - |
| ├─ 平均 | 62.8企業 | **1.0企業** | **-98.4%** |
| ├─ 最小 | 1企業 | 1企業 | 同一 |
| ├─ 最大 | 108企業 | 1企業 | **-99.1%** |
| **reserve_sum** | - | - | - |
| ├─ 平均 | 82.2台 | 82.2台 | **同一** |
| ├─ 最小 | 1台 | 1台 | 同一 |
| ├─ 最大 | 143台 | 143台 | 同一 |
| **fixed_ratio** | - | - | - |
| ├─ 平均 | **0.556** | **48.400** | **+8,601%** |
| ├─ 標準偏差 | 0.094 | 12.085 | +12,739% |
| ├─ 最小 | 0.000 | 0.000 | 同一 |
| ├─ 25%ile | 0.514 | 45.000 | +8,656% |
| ├─ 50%ile | 0.563 | 51.000 | +8,958% |
| ├─ 75%ile | 0.612 | 56.000 | +9,050% |
| ├─ 最大 | 0.837 | 79.000 | +9,338% |

### 2.2 詳細比較（サンプル10日）

| date | reserve_count<br>(Legacy) | reserve_count<br>(Current) | reserve_sum<br>(Legacy) | reserve_sum<br>(Current) | fixed_ratio<br>(Legacy) | fixed_ratio<br>(Current) | fixed_ratio_diff |
|------|---------------------------|----------------------------|-------------------------|--------------------------|-------------------------|--------------------------|------------------|
| 2023-01-04 | 19 | **1** | 31 | 31 | 0.000 | 0.0 | 0.000 |
| 2023-01-05 | 54 | **1** | 67 | 67 | 0.648 | **47.0** | **+46.352** |
| 2023-01-06 | 57 | **1** | 72 | 72 | 0.702 | **53.0** | **+52.298** |
| 2023-01-07 | 53 | **1** | 74 | 74 | 0.566 | **46.0** | **+45.434** |
| 2023-01-08 | 18 | **1** | 32 | 32 | 0.500 | **17.0** | **+16.500** |
| 2023-01-09 | 29 | **1** | 41 | 41 | 0.586 | **27.0** | **+26.414** |
| 2023-01-10 | 64 | **1** | 84 | 84 | 0.625 | **58.0** | **+57.375** |
| 2023-01-11 | 64 | **1** | 89 | 89 | 0.547 | **48.0** | **+47.453** |
| 2023-01-12 | 61 | **1** | 89 | 89 | 0.590 | **52.0** | **+51.410** |
| 2023-01-13 | 70 | **1** | 100 | 100 | 0.571 | **57.0** | **+56.429** |

## 3. 差分の詳細分析

### 3.1 reserve_count（予約企業数）

**旧版の正しい計算**:
```python
reserve_count = grp.size()  # その日の予約行数 = 企業数（1企業1行）
# 例：2023-01-05 → 54企業
```

**現状の破損した計算**:
```python
# 入力が既に日次集計済み（1日1行）
reserve_count = grp.size()  # 常に1
# 例：2023-01-05 → 1（意味なし）
```

**影響**:
- Stage 2モデルは企業数を予測の根拠の一つとして使用
- 現状では常に1 → 情報量ゼロ
- 特徴量の分散がゼロ → モデル学習時に無視される可能性

### 3.2 reserve_sum（予約台数合計）

**両バージョンで同一**:
```python
reserve_sum = grp['台数'].sum()
# 旧版：企業ごとの台数を合計 → 日次台数
# 現状：日次台数（既に集計済み）をそのまま
```

**結論**: この特徴量に破損なし

### 3.3 fixed_ratio（固定客比率）

**旧版の正しい計算**（企業比率）:
```python
# 固定客列 = 1/0（Boolean変換済み）
fixed_ratio = grp['固定客_int'].mean()
# = (固定客=1の行数) / (総行数)
# = 固定客企業数 / 総企業数

# 例：2023-01-05
#   総企業数: 54
#   固定客企業数: 35
#   fixed_ratio = 35 / 54 = 0.648（64.8%）
```

**現状の破損した計算**（台数そのもの）:
```python
# 固定客列 = 台数（DBから取得した固定客の台数合計）
fixed_ratio = grp['固定客'].mean()
# = 固定客台数 / グループ数（常に1）
# = 固定客台数そのもの

# 例：2023-01-05
#   固定客台数: 47台
#   グループ数: 1（既に日次集計済み）
#   fixed_ratio = 47 / 1 = 47.0（意味不明）
```

**差異の統計**:
| 指標 | 値 |
|------|-----|
| 平均差異 | +47.844 |
| 標準偏差（差異） | 12.024 |
| 最小差異 | 0.000（固定客ゼロの日） |
| 最大差異 | +78.163（2025-02-15） |
| 相関係数 | 0.152（ほぼ無相関） |

### 3.4 差異の最大10日

| date | fixed_ratio<br>(Legacy) | fixed_ratio<br>(Current) | 差異 | Legacy意味 | Current意味 |
|------|-------------------------|--------------------------|------|------------|-------------|
| 2025-02-15 | 0.837 | 79.0 | **+78.16** | 83.7%が固定客企業 | 79台が固定客 |
| 2025-05-16 | 0.781 | 78.0 | **+77.22** | 78.1%が固定客企業 | 78台が固定客 |
| 2024-12-07 | 0.653 | 76.0 | **+75.35** | 65.3%が固定客企業 | 76台が固定客 |
| 2025-01-28 | 0.804 | 76.0 | **+75.20** | 80.4%が固定客企業 | 76台が固定客 |
| 2024-12-27 | 0.630 | 75.0 | **+74.37** | 63.0%が固定客企業 | 75台が固定客 |
| 2025-03-13 | 0.651 | 74.0 | **+73.35** | 65.1%が固定客企業 | 74台が固定客 |
| 2025-03-25 | 0.704 | 74.0 | **+73.30** | 70.4%が固定客企業 | 74台が固定客 |
| 2024-12-17 | 0.587 | 73.0 | **+72.41** | 58.7%が固定客企業 | 73台が固定客 |
| 2024-12-14 | 0.607 | 73.0 | **+72.39** | 60.7%が固定客企業 | 73台が固定客 |
| 2023-08-18 | 0.608 | 73.0 | **+72.39** | 60.8%が固定客企業 | 73台が固定客 |

## 4. Stage 2モデルへの影響評価

### 4.1 特徴量の正規化後の分布

**StandardScaler適用後の推定**:

#### 旧版（Legacy）
```python
fixed_ratio: 平均=0.556, 標準偏差=0.094
正規化後 = (x - 0.556) / 0.094
# 範囲：約 -6.0 ～ +3.0（ほぼ正規分布）
```

#### 現状（Current）
```python
fixed_ratio: 平均=48.400, 標準偏差=12.085
正規化後 = (x - 48.400) / 12.085
# 範囲：約 -4.0 ～ +2.5（分布形状は異なる）
```

**問題点**:
1. **スケールが全く異なる**（0-1 vs 0-79）
2. **意味が全く異なる**（比率 vs 台数）
3. **相関が低い**（r=0.152）
4. **学習したモデルが転用不可**（旧版モデルを現状データで使用すると破綻）

### 4.2 予測精度への直接的影響

| 評価指標 | 旧版（CSV） | 現状（DB） | 劣化率 | 原因帰属 |
|---------|-------------|-----------|--------|---------|
| R2_total | 0.823 | 0.671 | -18.5% | 複合的 |
| **R2_sum_only** | **0.466** | **0.069** | **-85.2%** | **fixed_ratio破損** |
| MAE | 9,935 kg | 13,286 kg | +33.7% | 複合的 |

**Stage 2（集計予測）の精度崩壊**:
- R2_sum_only指標はStage 2モデルの性能を直接測定
- -85%の劇的な劣化は**fixed_ratio特徴量の破損**と強く相関
- 他の特徴量（reserve_sum）は正常なので、fixed_ratioが主犯

### 4.3 特徴量重要度への影響（推定）

**旧版（正常）**:
```
Stage 2特徴量重要度（推定）:
1. s1_sum (Stage 1合計)       : 35%
2. fixed_ratio (固定客比率)   : 20%  ← 正常に機能
3. reserve_sum (予約台数)     : 15%
4. y_ma7 (7日移動平均)        : 10%
5. その他                     : 20%
```

**現状（異常）**:
```
Stage 2特徴量重要度（推定）:
1. s1_sum (Stage 1合計)       : 40%
2. reserve_sum (予約台数)     : 25%
3. fixed_ratio (???)          : 5%   ← 異常値で無視される
4. y_ma7 (7日移動平均)        : 15%
5. その他                     : 15%
```

**結果**:
- fixed_ratioの情報が失われる → 予測精度低下
- 他の特徴量に過度に依存 → 過学習リスク増加

## 5. 列名差分

### 5.1 CSV出力形式

**両バージョン共通の列**:
```csv
date,reserve_count,reserve_sum,fixed_ratio
2023-01-05,54.0,67.0,0.648148
```

**列名**: 変更なし  
**列数**: 4列（同一）  
**データ型**: すべてfloat64（同一）

### 5.2 列の意味の差異

| 列名 | 旧版の意味 | 現状の意味 | 一致 |
|------|-----------|-----------|------|
| date | 予約日 | 予約日 | ✅ |
| reserve_count | 予約企業数（正常） | 常に1（破損） | ❌ |
| reserve_sum | 予約台数合計（正常） | 予約台数合計（正常） | ✅ |
| fixed_ratio | 固定客企業比率（正常） | 固定客台数（破損） | ❌ |

## 6. 同名列の統計差分

| 列 | 平均値（Legacy） | 平均値（Current） | 差異 | 差異率 |
|----|-----------------|------------------|------|--------|
| reserve_count | 62.8 | 1.0 | **-61.8** | **-98.4%** |
| reserve_sum | 82.2 | 82.2 | 0.0 | 0.0% |
| fixed_ratio | 0.556 | 48.400 | **+47.844** | **+8,601%** |

## 7. target_date当日の値の差分（具体例）

### 7.1 2025-10-31（評価期間末）

| 特徴量 | 旧版 | 現状 | 差異 | 解釈 |
|--------|------|------|------|------|
| reserve_count | 62 | 1 | -61 | 62企業の予約 vs 意味なし |
| reserve_sum | 87 | 87 | 0 | 両者同一（正常） |
| fixed_ratio | 0.419 | 42.0 | +41.581 | 41.9%が固定客 vs 42台が固定客 |

**実データでの確認**:
```python
# 旧版CSV（2025-10-31）
総企業数: 62社
固定客企業数: 26社
固定客台数: 42台
fixed_ratio = 26 / 62 = 0.419

# 現状DB（2025-10-31）
グループ数: 1（日次集計済み）
固定客台数: 42台
fixed_ratio = 42 / 1 = 42.0
```

### 7.2 2023-01-05（期間初期）

| 特徴量 | 旧版 | 現状 | 差異 | 解釈 |
|--------|------|------|------|------|
| reserve_count | 54 | 1 | -53 | 54企業の予約 vs 意味なし |
| reserve_sum | 67 | 67 | 0 | 両者同一（正常） |
| fixed_ratio | 0.648 | 47.0 | +46.352 | 64.8%が固定客 vs 47台が固定客 |

## 8. データ品質チェック

### 8.1 欠損値

**両バージョン共通**:
- 欠損値: 0行（すべて有効な数値）
- date列: 944日すべて有効

### 8.2 異常値

**旧版（Legacy）**:
- reserve_count: 1-108（妥当な範囲）
- reserve_sum: 1-143（妥当な範囲）
- fixed_ratio: 0.0-0.837（**0-1範囲、正常**）

**現状（Current）**:
- reserve_count: 常に1（**異常、情報量ゼロ**）
- reserve_sum: 1-143（妥当な範囲）
- fixed_ratio: 0.0-79.0（**異常、意味不明**）

### 8.3 外れ値検出（IQR法）

#### fixed_ratio（旧版）
```
Q1: 0.514, Q3: 0.612
IQR: 0.098
外れ値範囲: [0.367, 0.759]
外れ値数: 37日 (3.9%)  ← 正常範囲
```

#### fixed_ratio（現状）
```
Q1: 45.0, Q3: 56.0
IQR: 11.0
外れ値範囲: [28.5, 72.5]
外れ値数: 89日 (9.4%)  ← 構造的異常
```

## 9. 結論

### 9.1 破損の重大度評価

| 特徴量 | 破損度 | Stage 2への影響 | 修正優先度 |
|--------|--------|----------------|-----------|
| **fixed_ratio** | **CRITICAL** | **直接的**（R2_sum_only -85%） | **最優先** |
| **reserve_count** | **HIGH** | 間接的（情報量ゼロ） | 高 |
| reserve_sum | NONE | なし（正常） | 不要 |

### 9.2 修正の必要性

**現状の問題**:
1. ✅ 静的解析で不一致を検出（コードは同一、入力が異なる）
2. ✅ 動的比較で定量的に破損を実証（+8,601%の差異）
3. ✅ 精度劣化との因果関係を確認（R2_sum_only -85%）

**修正が必須**:
- 固定客"台数"と固定客"企業数"を明確に区別
- DBから固定客企業数を別途取得
- 企業比率を正しく計算する新特徴量を追加

### 9.3 CSV出力ファイル

以下のファイルを生成しました：
- ✅ tmp/compare_out/legacy_reserve_features.csv（944日、正常）
- ✅ tmp/compare_out/current_reserve_features.csv（944日、破損）

## 10. 次のアクション

1. ✅ 動的比較完了（破損を定量的に実証）
2. ⏳ 固定客企業数を取得する修正実装
3. ⏳ 修正後の動的比較で検証
4. ⏳ 最終レポートの統合
