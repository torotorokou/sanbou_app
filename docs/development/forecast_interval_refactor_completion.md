# äºˆæ¸¬åŒºé–“ã‚«ãƒ©ãƒ ã®ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å®Œäº†å ±å‘Š

**å®Ÿæ–½æ—¥**: 2025-12-18  
**æ‹…å½“**: AI Assistant  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… Phase 2å®Œäº†ï¼ˆä¿å­˜å‡¦ç†ä¿®æ­£æ¸ˆã¿ï¼‰

---

## å®Ÿæ–½å†…å®¹ã‚µãƒãƒªãƒ¼

### å•é¡Œ
- `p10/p90` ã‚«ãƒ©ãƒ ãŒçµ±è¨ˆçš„ã«èª¤è§£ã‚’æ‹›ãå‘½å
- `p10` ã¯å®Ÿéš›ã«ã¯ã€Œ10%åˆ†ä½ç‚¹ã€ã§ã¯ãªãã€Œmedian - 1.28Ïƒã€ï¼ˆæ­£è¦åˆ†å¸ƒä»®å®šï¼‰
- UI/ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã€ŒP10-P90åŒºé–“ã€ã¨è¡¨è¨˜ã•ã‚Œã¦ãŠã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’èª¤å°

### è§£æ±ºç­–
- çµ±è¨ˆçš„ã«æ­£ç¢ºãªæ–°ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ï¼š`median`, `lower_1sigma`, `upper_quantile_90`
- æ—§ã‚«ãƒ©ãƒ ï¼ˆ`p10/p50/p90`ï¼‰ã¯äº’æ›æ€§ã®ãŸã‚æ®‹å­˜ï¼ˆPhase 4ã§å‰Šé™¤äºˆå®šï¼‰
- ãƒ‡ãƒ¼ã‚¿å¥‘ç´„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ•´å‚™

---

## å®Œäº†ã—ãŸä½œæ¥­

### 1. èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ âœ…
**ãƒ•ã‚¡ã‚¤ãƒ«**: [docs/development/forecast_interval_refactor_investigation.md](./forecast_interval_refactor_investigation.md)

**å†…å®¹**:
- p10/p90ã®ç”Ÿæˆæ–¹æ³•ã‚’è¿½è·¡
- çµ±è¨ˆçš„å®šç¾©ã‚’æ˜ç¢ºåŒ–
- p25/p75ãŒç¾çŠ¶ç”Ÿæˆä¸å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª

### 2. ãƒ‡ãƒ¼ã‚¿å¥‘ç´„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ âœ…
**ãƒ•ã‚¡ã‚¤ãƒ«**: [docs/development/forecast_interval_data_contract.md](./forecast_interval_data_contract.md)

**å†…å®¹**:
- æ–°æ—§ã‚«ãƒ©ãƒ ã®å®šç¾©
- çµ±è¨ˆçš„æ„å‘³ã®æ˜ç¤º
- ä½¿ç”¨ä¾‹ã¨UIè¡¨ç¤ºã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
- ç§»è¡Œè¨ˆç”»

### 3. DBãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ âœ…
**ãƒ•ã‚¡ã‚¤ãƒ«**: [app/backend/core_api/migrations_v2/alembic/versions/20251218_002_add_semantic_interval_columns.py](../../app/backend/core_api/migrations_v2/alembic/versions/20251218_002_add_semantic_interval_columns.py)

**å®Ÿæ–½å†…å®¹**:
- æ–°ã‚«ãƒ©ãƒ è¿½åŠ ï¼ˆ`median`, `lower_1sigma`, `upper_quantile_90`ï¼‰
- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ç§»è¡Œï¼ˆ`median = p50`, `lower_1sigma = p10`, `upper_quantile_90 = p90`ï¼‰
- ã‚«ãƒ©ãƒ ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ ï¼ˆçµ±è¨ˆçš„æ„å‘³ã‚’æ˜ç¤ºï¼‰

### 4. ã‚³ãƒ¼ãƒ‰ä¿®æ­£ âœ…
**ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«**:
- [app/backend/inbound_forecast_worker/app/ports/forecast_result_repository.py](../../app/backend/inbound_forecast_worker/app/ports/forecast_result_repository.py)
  - DailyForecastResultãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã®docstringæ›´æ–°
- [app/backend/inbound_forecast_worker/app/adapters/forecast/daily_forecast_result_repository.py](../../app/backend/inbound_forecast_worker/app/adapters/forecast/daily_forecast_result_repository.py)
  - save_resultãƒ¡ã‚½ãƒƒãƒ‰ã®docstringæ›´æ–°ï¼ˆçµ±è¨ˆçš„å®šç¾©ã‚’æ˜è¨˜ï¼‰
- [app/backend/inbound_forecast_worker/app/application/run_daily_tplus1_forecast_with_training.py](../../app/backend/inbound_forecast_worker/app/application/run_daily_tplus1_forecast_with_training.py)
  - p10è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã®ã‚³ãƒ¡ãƒ³ãƒˆæ›´æ–°

**å¤‰æ›´å†…å®¹**:
- ãƒªãƒã‚¸ãƒˆãƒªã¯æ—¢ã«æ–°æ—§ä¸¡ã‚«ãƒ©ãƒ ã«ä¿å­˜ã™ã‚‹ã‚ˆã†å®Ÿè£…æ¸ˆã¿ï¼ˆäº’æ›æ€§ç¶­æŒï¼‰
- docstringã‚’çµ±è¨ˆçš„ã«æ­£ç¢ºãªè¡¨ç¾ã«ä¿®æ­£

### 5. æ•´åˆæ€§ç¢ºèª âœ…
**å®Ÿæ–½å†…å®¹**:
```sql
SELECT
    COUNT(*) AS total_records,
    COUNT(*) FILTER (WHERE median = p50) AS median_p50_match,
    COUNT(*) FILTER (WHERE lower_1sigma = p10) AS lower_1sigma_p10_match,
    COUNT(*) FILTER (WHERE upper_quantile_90 = p90) AS upper_quantile_90_p90_match
FROM forecast.daily_forecast_results;
```

**çµæœ**:
- å…¨7ãƒ¬ã‚³ãƒ¼ãƒ‰ä¸­ã€7ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒæ–°æ—§ã‚«ãƒ©ãƒ ã§ä¸€è‡´
- âœ… ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ç¢ºèªå®Œäº†

---

## çµ±è¨ˆçš„å®šç¾©ï¼ˆæœ€çµ‚ç‰ˆï¼‰

| ã‚«ãƒ©ãƒ å | å‹ | çµ±è¨ˆçš„æ„å‘³ | è¨ˆç®—æ–¹æ³• |
|---------|----|-----------|---------| 
| `median` | NUMERIC(18,3) | ä¸­å¤®å€¤ï¼ˆ50%åˆ†ä½ç‚¹ï¼‰ | Quantileå›å¸°ï¼ˆalpha=0.5ï¼‰ |
| `lower_1sigma` | NUMERIC(18,3) | ä¸‹å´åŒºé–“ï¼ˆmedian - 1.28Ïƒï¼‰ | `sigma = (upper_quantile_90 - median) / 1.28` â†’ `median - 1.28*sigma` |
| `upper_quantile_90` | NUMERIC(18,3) | ä¸Šå´90%åˆ†ä½ç‚¹ | Quantileå›å¸°ï¼ˆalpha=0.9ï¼‰ |

âš ï¸ **é‡è¦**: `lower_1sigma` ã¯å³å¯†ãª10%åˆ†ä½ç‚¹ã§ã¯ãªã„ã€‚æ­£è¦åˆ†å¸ƒã‚’ä»®å®šã—ãŸæ¨å®šå€¤ã€‚

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆPhase 3ä»¥é™ï¼‰

### Phase 3: API/UIç§»è¡Œï¼ˆ2026å¹´1-2æœˆäºˆå®šï¼‰
- [ ] APIå¿œç­”ã‚’æ–°ã‚«ãƒ©ãƒ å„ªå…ˆã«å¤‰æ›´
- [ ] UIè¡¨ç¤ºã‚’ã€ŒP10-P90ã€ã‹ã‚‰ã€Œ-1Ïƒ ~ 90%ileã€ã«å¤‰æ›´
- [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å®Œå…¨ç§»è¡Œ

### Phase 4: æ—§ã‚«ãƒ©ãƒ å‰Šé™¤ï¼ˆ2026å¹´2æœˆä»¥é™ï¼‰
- [ ] å…¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ç§»è¡Œç¢ºèª
- [ ] æ—§ã‚«ãƒ©ãƒ ï¼ˆ`p50`, `p10`, `p90`ï¼‰ã®å‰Šé™¤
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæœ€çµ‚æ›´æ–°

### å°†æ¥å¯¾å¿œ: p25/p75è¿½åŠ ï¼ˆåˆ¥ãƒã‚±ãƒƒãƒˆï¼‰
- [ ] Quantileå›å¸°ã§alpha=0.25, 0.75ã®ãƒ¢ãƒ‡ãƒ«è¿½åŠ è¨“ç·´
- [ ] ã¾ãŸã¯ã€Bootstrapäºˆæ¸¬ã®å®Ÿè£…

---

## å—ã‘å…¥ã‚Œæ¡ä»¶

### å¿…é ˆæ¡ä»¶
- [x] æ–°ã‚«ãƒ©ãƒ ï¼ˆ`median`, `lower_1sigma`, `upper_quantile_90`ï¼‰ãŒDBã«å­˜åœ¨ã™ã‚‹
- [x] æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒæ–°ã‚«ãƒ©ãƒ ã«ç§»è¡Œã•ã‚Œã¦ã„ã‚‹
- [x] ãƒªãƒã‚¸ãƒˆãƒªã®ä¿å­˜å‡¦ç†ãŒæ–°ã‚«ãƒ©ãƒ ã«å¯¾å¿œã—ã¦ã„ã‚‹
- [x] ãƒ‡ãƒ¼ã‚¿å¥‘ç´„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [x] æ—¢å­˜ã®æ—§ã‚«ãƒ©ãƒ ä¾å­˜å‡¦ç†ãŒå£Šã‚Œã¦ã„ãªã„

### Phase 3ä»¥é™
- [ ] UI/APIãŒæ–°ã‚«ãƒ©ãƒ ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨
- [ ] æ—§ã‚«ãƒ©ãƒ å‰Šé™¤ï¼ˆå…¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç§»è¡Œå¾Œï¼‰

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

1. [èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆ](./forecast_interval_refactor_investigation.md): p10/p90ã®å®Ÿæ…‹èª¿æŸ»
2. [ãƒ‡ãƒ¼ã‚¿å¥‘ç´„](./forecast_interval_data_contract.md): ã‚«ãƒ©ãƒ å®šç¾©ã¨ä½¿ç”¨ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
3. [ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³](../../app/backend/core_api/migrations_v2/alembic/versions/20251218_002_add_semantic_interval_columns.py): Phase 1ã®å®Ÿè£…

---

## å½±éŸ¿ç¯„å›²

### å¤‰æ›´ãªã—ï¼ˆäº’æ›æ€§ç¶­æŒï¼‰
- âœ… æ—¢å­˜ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- âœ… æ—¢å­˜ã®UIè¡¨ç¤º
- âœ… æ—¢å­˜ã®DBä¿å­˜å‡¦ç†ï¼ˆæ–°æ—§ä¸¡ã‚«ãƒ©ãƒ ã«ä¿å­˜ï¼‰

### å°†æ¥å¤‰æ›´äºˆå®šï¼ˆPhase 3ä»¥é™ï¼‰
- â³ APIå¿œç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆæ–°ã‚«ãƒ©ãƒ å„ªå…ˆï¼‰
- â³ UIè¡¨ç¤ºï¼ˆã€ŒP10-P90ã€â†’ã€Œ-1Ïƒ ~ 90%ileã€ï¼‰

---

## ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»æ‰¿èª

**æŠ€è¡“ãƒ¬ãƒ“ãƒ¥ãƒ¼**: âœ… å®Œäº†  
**ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ã‚¹ãƒ¬ãƒ“ãƒ¥ãƒ¼**: ğŸ“… å¾…ã¡  
**ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼æ‰¿èª**: ğŸ“… å¾…ã¡

---

**å®Œäº†æ—¥**: 2025-12-18  
**æ¬¡å›ãƒ¬ãƒ“ãƒ¥ãƒ¼**: Phase 3é–‹å§‹å‰ï¼ˆ2026å¹´1æœˆåˆæ—¬ï¼‰
