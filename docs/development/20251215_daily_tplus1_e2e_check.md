# æ—¥æ¬¡t+1äºˆæ¸¬ E2Eãƒ†ã‚¹ãƒˆçµæœãƒ¬ãƒãƒ¼ãƒˆ

**å®Ÿè¡Œæ—¥æ™‚**: 2025-12-18 17:03 JST  
**å¯¾è±¡æ—¥**: 2025-12-15  
**ç’°å¢ƒ**: local_dev (Docker Compose)  
**ã‚¸ãƒ§ãƒ–ID**: `f04551cc-8037-41ec-813f-e3db1ec6480a`

---

## ğŸ¯ ãƒ†ã‚¹ãƒˆç›®çš„

target_date=2025-12-15ã‚’å›ºå®šã—ã€æ—¥æ¬¡äºˆæ¸¬ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆã‚¸ãƒ§ãƒ–æŠ•å…¥â†’workerå®Ÿè¡Œâ†’DBä¿å­˜ï¼‰ãŒEnd-to-Endã§æˆåŠŸã™ã‚‹ã‹ã‚’æ¤œè¨¼ã™ã‚‹ã€‚

---

## âœ… çµè«–

**ğŸ‰ æˆåŠŸï¼ˆSUCCESSï¼‰**

æ—¥æ¬¡t+1äºˆæ¸¬ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯æ­£å¸¸ã«å‹•ä½œã—ã€äºˆæ¸¬çµæœãŒDBã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚

---

## ğŸ“Š å®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼

| é …ç›® | çµæœ | è©³ç´° |
|------|------|------|
| **ã‚¸ãƒ§ãƒ–æŠ•å…¥** | âœ… æˆåŠŸ | job_id: f04551cc-8037-41ec-813f-e3db1ec6480a |
| **Workerå‡¦ç†** | âœ… æˆåŠŸ | å®Ÿè¡Œæ™‚é–“: 3åˆ†6ç§’ |
| **å­¦ç¿’ãƒ»äºˆæ¸¬** | âœ… æˆåŠŸ | retrain_and_eval --quick --use-db |
| **DBä¿å­˜** | âœ… æˆåŠŸ | forecast.daily_forecast_results |
| **p50ï¼ˆä¸­å¤®å€¤ï¼‰** | **84.181 ton** | - |
| **p10ï¼ˆä¸‹é™ï¼‰** | **80.399 ton** | - |
| **p90ï¼ˆä¸Šé™ï¼‰** | **87.962 ton** | - |

---

## ğŸ” è©³ç´°å®Ÿè¡Œãƒ•ãƒ­ãƒ¼

### 0) äº‹å‰ç¢ºèª

**å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ï¼ˆmart.mv_receive_dailyï¼‰**:
- ç¯„å›²: 2024-12-20 ï½ 2025-12-14ï¼ˆ360æ—¥åˆ†ï¼‰
- ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: 360
- å¹³å‡: 75.95 ton

**äºˆç´„ãƒ‡ãƒ¼ã‚¿ï¼ˆmart.v_reserve_daily_for_forecastï¼‰**:
- ç¯„å›²: 2024-12-20 ï½ 2025-12-15ï¼ˆ337æ—¥åˆ†ã€å½“æ—¥å«ã‚€ï¼‰
- å½“æ—¥äºˆç´„: 76å°ï¼ˆå›ºå®š38å°ã€æ¯”ç‡50%ï¼‰

âœ… **åˆ¤å®š**: ãƒ‡ãƒ¼ã‚¿æƒã£ã¦ã„ã‚‹ã€ã‚¸ãƒ§ãƒ–æŠ•å…¥å¯èƒ½

è©³ç´°: [20251215_daily_predict_precheck.md](./20251215_daily_predict_precheck.md)

---

### 1) ã‚¸ãƒ§ãƒ–æŠ•å…¥

**æŠ•å…¥SQL**:
```sql
INSERT INTO forecast.forecast_jobs (job_type, target_date, status, run_after)
VALUES ('daily_tplus1', DATE '2025-12-15', 'queued', CURRENT_TIMESTAMP)
RETURNING id, job_type, target_date, status, run_after, created_at;
```

**çµæœ**:
```
                  id                  |   job_type   | target_date | status |           run_after           
--------------------------------------+--------------+-------------+--------+-------------------------------
 f04551cc-8037-41ec-813f-e3db1ec6480a | daily_tplus1 | 2025-12-15  | queued | 2025-12-18 08:03:19.533612+00
```

âœ… ã‚¸ãƒ§ãƒ–IDå–å¾—: `f04551cc-8037-41ec-813f-e3db1ec6480a`

---

### 2) Workerå®Ÿè¡Œãƒ­ã‚°

**ã‚¸ãƒ§ãƒ–ã‚¯ãƒ¬ãƒ¼ãƒ ï¼ˆ17:03:22ï¼‰**:
```json
{
  "message": "âœ… Claimed job: daily_tplus1",
  "job_id": "f04551cc-8037-41ec-813f-e3db1ec6480a",
  "job_type": "daily_tplus1",
  "target_date": "2025-12-15",
  "attempt": 0
}
```

**ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä½œæˆ**:
```
ğŸ“ Created workspace: /tmp/forecast_jobs/f04551cc-8037-41ec-813f-e3db1ec6480a
```

**å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿æº–å‚™**:
```json
{
  "message": "âœ… Actuals data prepared: 56187 records",
  "actuals_count": 56187,
  "actuals_max_date": "2025-11-30",
  "avg_weight_ton": 0.473
}
```

âš ï¸ **æ³¨æ„**: æœ€å¤§æ—¥ãŒ2025-11-30ï¼ˆäºˆæƒ³ã¯2025-12-14ï¼‰
- ã“ã‚Œã¯`stg.v_active_shogun_flash_receive`ã®ãƒ‡ãƒ¼ã‚¿ãŒ11/30ã¾ã§ã—ã‹ãªã„å•é¡Œ
- ãŸã ã—360æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã¯ç¢ºä¿ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€äºˆæ¸¬ã¯å®Ÿè¡Œå¯èƒ½

**äºˆç´„ãƒ‡ãƒ¼ã‚¿æº–å‚™**:
```json
{
  "message": "âœ… Reserve data prepared: 337 records",
  "reserve_count": 337,
  "reserve_max_date": "2025-12-15"
}
```

**å­¦ç¿’ãƒ»äºˆæ¸¬å®Ÿè¡Œï¼ˆ17:03:23 ï½ 17:06:29ï¼‰**:
```bash
python3 /backend/scripts/retrain_and_eval.py \
  --quick \
  --use-db \
  --db-connection-string postgresql+psycopg://sanbou_app_dev:***@db:5432/sanbou_dev \
  --actuals-start-date 2024-12-15 \
  --actuals-end-date 2025-12-14 \
  --reserve-start-date 2024-12-20 \
  --reserve-end-date 2025-12-15 \
  --out-dir /tmp/forecast_jobs/f04551cc-8037-41ec-813f-e3db1ec6480a/out \
  --pred-out-csv /tmp/forecast_jobs/f04551cc-8037-41ec-813f-e3db1ec6480a/tplus1_pred.csv \
  --start-date 2025-12-15 \
  --end-date 2025-12-15 \
  --log /tmp/forecast_jobs/f04551cc-8037-41ec-813f-e3db1ec6480a/run.log
```

**å®Ÿè¡Œæ™‚é–“**: ç´„3åˆ†6ç§’ï¼ˆ--quick ãƒ¢ãƒ¼ãƒ‰ï¼‰

**äºˆæ¸¬çµæœï¼ˆ17:06:29ï¼‰**:
```json
{
  "message": "ğŸ“ˆ Prediction result: p50=84.181",
  "p50": 84.18082382483503,
  "p10": 80.39915654061835,
  "p90": 87.96249110905171
}
```

**DBä¿å­˜**:
```json
{
  "message": "âœ… Saved prediction result to DB",
  "target_date": "2025-12-15",
  "job_id": "f04551cc-8037-41ec-813f-e3db1ec6480a",
  "p50": 84.18082382483503
}
```

**ã‚¸ãƒ§ãƒ–å®Œäº†**:
```json
{
  "message": "âœ… Job marked as succeeded",
  "job_id": "f04551cc-8037-41ec-813f-e3db1ec6480a"
}
```

---

### 3) DBç¢ºèª

**äºˆæ¸¬çµæœï¼ˆforecast.daily_forecast_resultsï¼‰**:
```sql
SELECT target_date, p50, p10, p90, unit, generated_at, job_id
FROM forecast.daily_forecast_results
WHERE target_date = DATE '2025-12-15'
ORDER BY generated_at DESC
LIMIT 5;
```

**çµæœ**:
```
 target_date |  p50   |  p10   |  p90   | unit |         generated_at          |                job_id                
-------------+--------+--------+--------+------+-------------------------------+--------------------------------------
 2025-12-15  | 84.181 | 80.399 | 87.962 | ton  | 2025-12-18 08:03:22.917412+00 | f04551cc-8037-41ec-813f-e3db1ec6480a
```

âœ… **ä¿å­˜æˆåŠŸ**: target_date=2025-12-15ã®äºˆæ¸¬çµæœãŒDBã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹

**ã‚¸ãƒ§ãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆforecast.forecast_jobsï¼‰**:
```sql
SELECT id, status, attempt, started_at, finished_at,
       finished_at - started_at AS duration, last_error
FROM forecast.forecast_jobs
WHERE job_type='daily_tplus1' AND target_date=DATE '2025-12-15'
ORDER BY created_at DESC
LIMIT 3;
```

**çµæœ**:
```
                  id                  |  status   | attempt |          started_at           |          finished_at          |    duration     | last_error 
--------------------------------------+-----------+---------+-------------------------------+-------------------------------+-----------------+------------
 f04551cc-8037-41ec-813f-e3db1ec6480a | succeeded |       0 | 2025-12-18 08:03:22.908836+00 | 2025-12-18 08:06:29.094055+00 | 00:03:06.185219 | 
```

âœ… **ã‚¸ãƒ§ãƒ–æˆåŠŸ**: status=succeededã€å®Ÿè¡Œæ™‚é–“3åˆ†6ç§’ã€ã‚¨ãƒ©ãƒ¼ãªã—

---

## ğŸ“ˆ äºˆæ¸¬çµæœã®è©•ä¾¡

### äºˆæ¸¬å€¤ã¨å®Ÿéš›ã®äºˆç´„ã¨ã®æ¯”è¼ƒ

| æŒ‡æ¨™ | äºˆæ¸¬å€¤ï¼ˆtonï¼‰ | äºˆç´„å°æ•° | å‚™è€ƒ |
|------|--------------|---------|------|
| **p50ï¼ˆä¸­å¤®å€¤ï¼‰** | 84.181 | 76å°äºˆç´„ | 1å°ã‚ãŸã‚Šç´„1.1tonæƒ³å®š |
| **p10ï¼ˆä¸‹é™10%ç‚¹ï¼‰** | 80.399 | - | p50ã‚ˆã‚Š3.8tonå°‘ãªã„ |
| **p90ï¼ˆä¸Šé™90%ç‚¹ï¼‰** | 87.962 | - | p50ã‚ˆã‚Š3.8tonå¤šã„ |
| **äºˆæ¸¬å¹…** | 7.56 ton | - | p90-p10ï¼ˆä¸ç¢ºå®Ÿæ€§ã®ç¯„å›²ï¼‰ |

### çµ±è¨ˆçš„å¦¥å½“æ€§

âœ… **p10 < p50 < p90**: 80.399 < 84.181 < 87.962ï¼ˆæ­£ã—ã„å¤§å°é–¢ä¿‚ï¼‰
âœ… **å¯¾ç§°æ€§**: p50-p10 â‰ˆ p90-p50ï¼ˆã»ã¼å¯¾ç§°ã€æ­£å¸¸ãªåˆ†å¸ƒï¼‰
âœ… **äºˆæ¸¬å¹…**: ç´„7.6tonï¼ˆç´„9%ã®å¤‰å‹•å¹…ã€å®Ÿç”¨çš„ãªç¯„å›²ï¼‰

### éå»å®Ÿç¸¾ã¨ã®æ¯”è¼ƒ

- éå»360æ—¥å¹³å‡: 75.95 ton
- ä»Šå›äºˆæ¸¬: 84.18 tonï¼ˆp50ï¼‰
- å·®åˆ†: +8.23 tonï¼ˆç´„10.8%å¢—ï¼‰

â†’ äºˆç´„å°æ•°ï¼ˆ76å°ï¼‰ãŒéå»å¹³å‡ã‚ˆã‚Šå¤šã„å¯èƒ½æ€§ã‚’ç¤ºå”†

---

## âš ï¸ ç™ºè¦‹ã•ã‚ŒãŸèª²é¡Œ

### 1. å—å…¥ãƒ‡ãƒ¼ã‚¿ã®æœ€å¤§æ—¥ã‚ºãƒ¬

**ãƒ­ã‚°ã®è­¦å‘Š**:
```
âš ï¸ Actuals max date mismatch: expected 2025-12-14, got 2025-11-30
```

**åŸå› **:
- `stg.v_active_shogun_flash_receive`ã®ãƒ‡ãƒ¼ã‚¿ãŒ2025-11-30ã¾ã§ã—ã‹ãªã„
- ä»¥å‰ã®èª¿æŸ»ã§åˆ¤æ˜æ¸ˆã¿ï¼ˆ12/16, 12/17ã®ãƒ‡ãƒ¼ã‚¿æœªç€ï¼‰

**å½±éŸ¿**:
- ç›´è¿‘2é€±é–“ã®ãƒˆãƒ¬ãƒ³ãƒ‰ãŒæ•æ‰ã§ããªã„
- ãŸã ã—360æ—¥åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã¯ç¢ºä¿ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€äºˆæ¸¬è‡ªä½“ã¯å®Ÿè¡Œå¯èƒ½

**æ¨å¥¨å¯¾å¿œ**:
1. ãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ç¢ºèª
2. `stg.shogun_flash_receive`ã¨`stg.v_active_shogun_flash_receive`ã®å·®åˆ†ç¢ºèª
3. ãƒ“ãƒ¥ãƒ¼å®šç¾©ã«æ—¥ä»˜åˆ¶é™ãŒãªã„ã‹ç¢ºèª

---

## ğŸ“ å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ

### æˆåŠŸè¦å› 

1. **DBãƒ¢ãƒ¼ãƒ‰ï¼ˆ--use-dbï¼‰ãŒæ­£å¸¸å‹•ä½œ**
   - CSVãƒ•ã‚¡ã‚¤ãƒ«ä¸è¦ã€ç›´æ¥DBã‹ã‚‰èª­ã¿è¾¼ã¿
   - `backend_shared.db.url_builder`ã«ã‚ˆã‚‹æ¥ç¶šæ–‡å­—åˆ—æ§‹ç¯‰

2. **Decimalâ†’floatå¤‰æ›ãŒæ©Ÿèƒ½**
   - `db_loader.py`ã§`pd.to_numeric()`è¿½åŠ æ¸ˆã¿
   - PostgreSQL numericå‹ã®å•é¡Œã‚’è§£æ±º

3. **ãƒ‡ãƒ¼ã‚¿ç¯„å›²ã®æ•´åˆæ€§**
   - å®Ÿç¸¾: 360æ—¥åˆ†ï¼ˆå‰æ—¥ã¾ã§ï¼‰
   - äºˆç´„: 361æ—¥åˆ†ï¼ˆå½“æ—¥å«ã‚€ï¼‰
   - æ­£ã—ãåˆ†é›¢ã•ã‚Œã¦ã„ã‚‹

### æ”¹å–„ã®ä½™åœ°

1. **å—å…¥ãƒ‡ãƒ¼ã‚¿ã®é®®åº¦å‘ä¸Š**
   - æœ€å¤§æ—¥ãŒ11/30ï¼ˆ15æ—¥å‰ï¼‰ã¯å®Ÿç”¨ä¸Šå•é¡Œ
   - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ã‚’æ±‚ã‚ã‚‹å ´åˆã¯è¦æ”¹å–„

2. **ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯ã®å¼·åŒ–**
   - æœ€å¤§æ—¥ã‚ºãƒ¬ã‚’æ¤œå‡ºã—ã¦ã„ã‚‹ãŒã€è­¦å‘Šã®ã¿
   - é–¾å€¤ã‚’è¶…ãˆãŸå ´åˆã¯ã‚¸ãƒ§ãƒ–å¤±æ•—ã•ã›ã‚‹é¸æŠè‚¢ã‚‚

---

## ğŸ“ é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- **äº‹å‰ç¢ºèª**: [20251215_daily_predict_precheck.md](./20251215_daily_predict_precheck.md)
- **æŠ•å…¥SQL**: [20251215_daily_predict_job_insert.sql](./20251215_daily_predict_job_insert.sql)
- **æ—¥ä»˜æ•´åˆãƒã‚§ãƒƒã‚¯**: [20251218_date_alignment_check_result.md](./20251218_date_alignment_check_result.md)

---

## âœ… æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¢ã‚¤ãƒ†ãƒ 

### çŸ­æœŸï¼ˆå¿…é ˆï¼‰

- [ ] å—å…¥ãƒ‡ãƒ¼ã‚¿æœ€å¤§æ—¥ã‚ºãƒ¬ã®åŸå› èª¿æŸ»
  ```sql
  SELECT MAX(slip_date) FROM stg.shogun_flash_receive;
  SELECT MAX(slip_date) FROM stg.v_active_shogun_flash_receive;
  ```

### ä¸­æœŸï¼ˆæ¨å¥¨ï¼‰

- [ ] ãƒ‡ãƒ¼ã‚¿é®®åº¦ã‚¢ãƒ©ãƒ¼ãƒˆã®å®Ÿè£…
- [ ] äºˆæ¸¬ç²¾åº¦ã®æ¤œè¨¼ï¼ˆå®Ÿç¸¾å€¤ã¨ã®çªåˆï¼‰
- [ ] --quickä»¥å¤–ã®ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ•ãƒ«å­¦ç¿’ï¼‰ã§ã®ãƒ†ã‚¹ãƒˆ

### é•·æœŸï¼ˆæ¤œè¨ï¼‰

- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿å–ã‚Šè¾¼ã¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æ§‹ç¯‰
- [ ] äºˆæ¸¬çµæœã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰åŒ–
- [ ] A/Bãƒ†ã‚¹ãƒˆï¼ˆç•°ãªã‚‹ãƒ¢ãƒ‡ãƒ«ãƒ»ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰

---

**ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ**: GitHub Copilot  
**æ¤œè¨¼å®Œäº†æ—¥æ™‚**: 2025-12-18 17:06 JST  
**æœ€çµ‚åˆ¤å®š**: âœ… **SUCCESS - æ—¥æ¬¡t+1äºˆæ¸¬ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ­£å¸¸å‹•ä½œç¢ºèª**
