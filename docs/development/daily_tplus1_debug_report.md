# æ—¥æ¬¡t+1äºˆæ¸¬ ç•°å¸¸å€¤ï¼ˆ1ãƒˆãƒ³ï¼‰ãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒãƒ¼ãƒˆ

**èª¿æŸ»æ—¥**: 2025-12-18  
**æ‹…å½“**: ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒãƒƒã‚°  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ğŸ”´ åŸå› ç‰¹å®šå®Œäº†ãƒ»ä¿®æ­£æº–å‚™ä¸­

---

## 1. å•é¡Œã®æ¦‚è¦

### ç¾è±¡
- æ—¥æ¬¡t+1äºˆæ¸¬ã®çµæœãŒ**1.0ãƒˆãƒ³**ã¨ã„ã†ç•°å¸¸å€¤ã«ãªã‚‹
- Job ID: `ed0b171c-4a87-4155-abab-d83ce3413285` (target_date=2025-12-20)
- å®Ÿéš›ã®æ¬å…¥é‡ã¯é€šå¸¸20ï½100ãƒˆãƒ³/æ—¥ç¨‹åº¦ã®ã¯ãšãŒã€1ãƒˆãƒ³ã¨ã„ã†éç¾å®Ÿçš„ãªå€¤

### å½±éŸ¿ç¯„å›²
- ã™ã¹ã¦ã®t+1äºˆæ¸¬ã‚¸ãƒ§ãƒ–ï¼ˆæˆåŠŸã—ãŸã‚¸ãƒ§ãƒ–ã§ã‚‚äºˆæ¸¬å€¤ãŒç•°å¸¸ï¼‰
- ãƒ“ã‚¸ãƒã‚¹åˆ¤æ–­ã«ä½¿ç”¨ã§ããªã„

---

## 2. åŸå› èª¿æŸ»çµæœ

### 2.1 ãƒ‡ãƒ¼ã‚¿å–å¾—ã®æ¤œè¨¼

#### å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ï¼ˆstg.shogun_final_receiveï¼‰
âœ… **æ­£å¸¸**: ãƒ‡ãƒ¼ã‚¿ã¯æ­£ã—ãå–å¾—ã•ã‚Œã¦ã„ã‚‹
- æœŸé–“: 2024-12-20 ï½ 2025-12-19ï¼ˆ365æ—¥ï¼‰
- ä»¶æ•°: 55,279è¡Œ
- å˜ä½å¤‰æ›: kg â†’ tonï¼ˆæ­£ã—ã /1000.0 ã•ã‚Œã¦ã„ã‚‹ï¼‰
- raw.csvã®å†…å®¹: æ­£å¸¸ï¼ˆ0.73, 1.36, 0.69ãƒˆãƒ³ç­‰ï¼‰

```csv
ä¼ç¥¨æ—¥ä»˜,å“å,æ­£å‘³é‡é‡
2024-12-20,GCè»½é‰„ï½¥ï½½ï¾ï½°ï¾™é¡,1.3600000000000000
2024-12-20,GCè»½é‰„ï½¥ï½½ï¾ï½°ï¾™é¡,0.73000000000000000000
```

#### äºˆç´„ãƒ‡ãƒ¼ã‚¿ï¼ˆmart.v_reserve_daily_for_forecastï¼‰
âš ï¸ **å•é¡Œã‚ã‚Š**: æœŸé–“æŒ‡å®šãŒé–“é•ã£ã¦ã„ã‚‹
- å–å¾—æœŸé–“: 2025-10-21 ï½ 2025-12-27ï¼ˆ`target_date - 60` ï½ `target_date + 7`ï¼‰
- **target_dateï¼ˆ2025-12-20ï¼‰ã®äºˆç´„ãŒå­˜åœ¨ã—ãªã„**
  - DBã®æœ€å¤§æ—¥: 2025-12-18
  - 2025-12-19, 2025-12-20ã¯æœªæ¥ãªã®ã§å­˜åœ¨ã—ãªã„
- reserve.csvã®ç¯„å›²: 2025-10-21 ï½ 2025-12-18ï¼ˆ58è¡Œï¼‰

```sql
-- å®Ÿéš›ã®DBçŠ¶æ³
SELECT MAX(date) FROM mart.v_reserve_daily_for_forecast;
-- => 2025-12-18

SELECT COUNT(*) FROM mart.v_reserve_daily_for_forecast WHERE date = DATE '2025-12-20';
-- => 0ï¼ˆå­˜åœ¨ã—ãªã„ï¼‰
```

### 2.2 å­¦ç¿’ãƒ»äºˆæ¸¬ãƒ—ãƒ­ã‚»ã‚¹ã®æ¤œè¨¼

#### ğŸ”´ **æ ¹æœ¬åŸå› ç™ºè¦‹**: äºˆæ¸¬å¯¾è±¡æ—¥ã®ã‚ºãƒ¬

**æœŸå¾…å€¤**:
- target_date = 2025-12-20
- äºˆæ¸¬ã—ãŸã„æ—¥ = 2025-12-20

**å®Ÿéš›ã®å‹•ä½œ**:
- res_walkforward.csvã®æœ€çµ‚æ—¥ = 2025-11-30
- `--start-date 2025-12-20` ã‚’æŒ‡å®š
- ã—ã‹ã— `--end-date` ãŒæœªæŒ‡å®š
- serve_predict_model_v4_2_4.pyã¯ `start_date` ã¨ `end_date` **ä¸¡æ–¹**ãŒå¿…è¦
- ä¸¡æ–¹æœªæŒ‡å®šã®å ´åˆ â†’ `last_date + 1` ã‹ã‚‰`--future-days` æ—¥æ•°ã ã‘äºˆæ¸¬
- å®Ÿéš›ã®äºˆæ¸¬: **2025-12-01ã®ã¿**ï¼ˆlast_date + 1æ—¥ï¼‰

```log
[TRACE] future days: 1 from 2025-12-01 to 2025-12-01
```

**ãªãœ2025-11-30ãŒæœ€çµ‚æ—¥ãªã®ã‹ï¼Ÿ**:
- train_daily_model.pyã®å­¦ç¿’ç¯„å›²ãŒ365æ—¥ã§walkforwardè©•ä¾¡ãŒè¡Œã‚ã‚Œã‚‹
- è©•ä¾¡æœŸé–“ãŒ2025-11-01 ï½ 2025-11-30ç¨‹åº¦ã§çµ‚äº†
- ãã®ãŸã‚äºˆæ¸¬ã‚‚2025-12-01ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ã—ã¾ã†

---

## 3. ãªãœã€Œ1ãƒˆãƒ³ã€ã«ãªã£ãŸã®ã‹

### 3.1 æ¨è«–
1. **äºˆæ¸¬å¯¾è±¡æ—¥ãŒé–“é•ã£ã¦ã„ã‚‹** (2025-12-01ã‚’äºˆæ¸¬)
2. **target_dateã®äºˆç´„ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„** (2025-12-20ã®äºˆç´„ãŒç„¡ã„)
3. **äºˆç´„ç‰¹å¾´é‡ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆ0ã¾ãŸã¯éå»ã®å¹³å‡ï¼‰ã«ãªã‚‹**
4. **2025-12-01ã®äºˆæ¸¬ãŒä½ã„å€¤ã«ãªã‚‹**
5. **ãã®å€¤ãŒãã®ã¾ã¾p50ã¨ã—ã¦ä¿å­˜ã•ã‚Œã‚‹**

### 3.2 ç¢ºèª
```python
# tplus1_pred.csvã®å†…å®¹
date,sum_items_pred,p50,p90,mean_pred,total_pred,...
2025-12-01,51.73,79.52,85.81,69.80,70.30,...
```

â†’ p50ã¯å®Ÿéš›ã¯79.5ãƒˆãƒ³ã ãŒã€**ä½•ã‚‰ã‹ã®ç†ç”±ã§æœ€çµ‚çš„ã«1.0ãƒˆãƒ³ã«ãªã£ã¦ã„ã‚‹**

**ã•ã‚‰ãªã‚‹åŸå› **:
- `tplus1_pred.csv` ã®ãƒ‘ãƒ¼ã‚¹å‡¦ç†
- CSVã«ã¯è¤‡æ•°ã®äºˆæ¸¬å€™è£œåˆ—ãŒã‚ã‚‹ï¼ˆsum_items_pred, p50, p90, mean_pred, total_predï¼‰
- **é–“é•ã£ãŸåˆ—ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã‚‹å¯èƒ½æ€§**

---

## 4. ä¿®æ­£æ–¹é‡ï¼ˆæœ€å°å·®åˆ†ï¼‰

### ä¿®æ­£1: `--end-date`ã®è¿½åŠ ï¼ˆå¿…é ˆï¼‰
**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/backend/inbound_forecast_worker/app/application/run_daily_tplus1_forecast_with_training.py`

```python
# ä¿®æ­£å‰
cmd = [
    "python3",
    str(self._retrain_script_path),
    "--quick",
    "--raw-csv", str(raw_csv_path),
    "--reserve-csv", str(reserve_csv_path),
    "--out-dir", str(out_dir),
    "--pred-out-csv", str(pred_out_csv),
    "--start-date", str(target_date),  # â† ã“ã‚Œã ã‘ã§ã¯ä¸ååˆ†
    "--log", str(log_file),
]

# ä¿®æ­£å¾Œ
cmd = [
    "python3",
    str(self._retrain_script_path),
    "--quick",
    "--raw-csv", str(raw_csv_path),
    "--reserve-csv", str(reserve_csv_path),
    "--out-dir", str(out_dir),
    "--pred-out-csv", str(pred_out_csv),
    "--start-date", str(target_date),
    "--end-date", str(target_date),  # â† è¿½åŠ ï¼ˆ1æ—¥ã®ã¿äºˆæ¸¬ï¼‰
    "--log", str(log_file),
]
```

### ä¿®æ­£2: äºˆç´„ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ç¯„å›²ä¿®æ­£
**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/backend/inbound_forecast_worker/app/application/run_daily_tplus1_forecast_with_training.py`

```python
# ä¿®æ­£å‰
reserve_start = target_date - timedelta(days=60)
reserve_end = target_date + timedelta(days=7)  # â† æœªæ¥7æ—¥ã¯å­˜åœ¨ã—ãªã„

# ä¿®æ­£å¾Œ
reserve_start = target_date - timedelta(days=67)  # ç´„2ãƒ¶æœˆå‰
reserve_end = target_date  # â† target_dateå½“æ—¥ã¾ã§ï¼ˆæœªæ¥ã¯å–å¾—ã—ãªã„ï¼‰
```

**ç†ç”±**:
- äºˆç´„ãƒ‡ãƒ¼ã‚¿ã¯ç¾åœ¨æ—¥ã¾ã§ ã—ã‹å­˜åœ¨ã—ãªã„
- æœªæ¥ã®äºˆç´„ã‚’è¦æ±‚ã—ã¦ã‚‚DBã«ç„¡ã„
- target_dateå½“æ—¥ã®äºˆç´„ãŒå¿…è¦ï¼ˆäºˆæ¸¬ã«ä½¿ç”¨ã™ã‚‹ï¼‰
- éå»67æ—¥åˆ†ã‚ã‚Œã°ååˆ†ï¼ˆMA14ã®ç‰¹å¾´é‡ç”Ÿæˆã«å¿…è¦ï¼‰

### ä¿®æ­£3: äºˆæ¸¬çµæœCSVã®ãƒ‘ãƒ¼ã‚¹ç¢ºèªï¼ˆå¿µã®ãŸã‚ï¼‰
**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/backend/inbound_forecast_worker/app/application/run_daily_tplus1_forecast_with_training.py`

ç¾åœ¨ã®å®Ÿè£…ã‚’ç¢ºèªã—ã€æ­£ã—ã„åˆ—ï¼ˆ`p50`ï¼‰ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã‚‹ã‹æ¤œè¨¼ã™ã‚‹ã€‚

---

## 5. æ¤œè¨¼è¨ˆç”»

### 5.1 ä¿®æ­£å¾Œã®æ¤œè¨¼æ‰‹é †
1. ä¿®æ­£ã‚’ã‚³ãƒŸãƒƒãƒˆ
2. Workerã‚’å†èµ·å‹•
3. ãƒ†ã‚¹ãƒˆã‚¸ãƒ§ãƒ–ã‚’æŠ•å…¥ï¼ˆtarget_date = CURRENT_DATE + 1ï¼‰
4. ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª:
   - `raw.csv`: æ­£å‘³é‡é‡ãŒå¦¥å½“ãªç¯„å›²ï¼ˆ0.1ï½10ãƒˆãƒ³ç¨‹åº¦ï¼‰
   - `reserve.csv`: target_dateã®è¡ŒãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹
   - `tplus1_pred.csv`: dateãŒtarget_dateã«ãªã£ã¦ã„ã‚‹ã‹
   - `run.log`: `[TRACE] future days: 1 from {target_date} to {target_date}`
5. DBä¿å­˜å€¤ã‚’ç¢ºèª:
   - `p50` ãŒ 20ï½100 ãƒˆãƒ³ç¨‹åº¦ã®åˆç†çš„ãªç¯„å›²ã«ã‚ã‚‹ã‹

### 5.2 æœŸå¾…ã•ã‚Œã‚‹çµæœ
- raw.csv: 365æ—¥åˆ†ã®å“ç›®åˆ¥å®Ÿç¸¾ï¼ˆæœ€å¤§æ—¥ = target_date - 1ï¼‰
- reserve.csv: ç´„67æ—¥åˆ†ã®äºˆç´„ï¼ˆæœ€å¤§æ—¥ = target_dateï¼‰
- tplus1_pred.csv: target_dateã®1è¡Œã®ã¿
- p50: 20ï½100ãƒˆãƒ³ç¨‹åº¦ï¼ˆéå»ã®å®Ÿç¸¾ã‹ã‚‰æ¨å®šï¼‰

---

## 6. å†ç™ºé˜²æ­¢ç­–

### 6.1 å…¥åŠ›æ¤œè¨¼ã®è¿½åŠ 
**UseCaseå®Ÿè¡Œå‰ã®ã‚¬ãƒ¼ãƒ‰**:
```python
# 1. å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã®æ—¥ä»˜ç¯„å›²ãƒã‚§ãƒƒã‚¯
if actuals_df["ä¼ç¥¨æ—¥ä»˜"].max() != actuals_end:
    logger.warning(f"Actuals max date mismatch: expected {actuals_end}, got {actuals_df['ä¼ç¥¨æ—¥ä»˜'].max()}")

# 2. äºˆç´„ãƒ‡ãƒ¼ã‚¿ã®target_dateå­˜åœ¨ãƒã‚§ãƒƒã‚¯
reserve_dates = reserve_df["äºˆç´„æ—¥"].tolist()
if target_date not in reserve_dates:
    logger.warning(f"Reserve data for target_date {target_date} does not exist")

# 3. å˜ä½ãƒã‚§ãƒƒã‚¯ï¼ˆæ­£å‘³é‡é‡ã®å¹³å‡ãŒå¦¥å½“ãªç¯„å›²ã‹ï¼‰
avg_weight = actuals_df["æ­£å‘³é‡é‡"].mean()
if avg_weight < 0.01 or avg_weight > 50:
    logger.error(f"Suspicious average weight: {avg_weight} ton")
```

### 6.2 äºˆæ¸¬çµæœã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
```python
# p50ãŒç•°å¸¸å€¤ã§ãªã„ã‹ç¢ºèª
if p50 < 1.0 or p50 > 200.0:
    logger.error(f"Prediction value out of range: p50={p50}")
    raise ValueError(f"Invalid prediction: p50={p50}")
```

---

## 7. è¿½åŠ èª¿æŸ»äº‹é …ï¼ˆTODOï¼‰

### 7.1 ãªãœ79.5ãƒˆãƒ³ãŒ1.0ãƒˆãƒ³ã«ãªã£ãŸã®ã‹ï¼Ÿ
- `tplus1_pred.csv` ã®ãƒ‘ãƒ¼ã‚¹å‡¦ç†ã‚’ç¢ºèª
- `p50` åˆ—ã‚’æ­£ã—ãèª­ã‚“ã§ã„ã‚‹ã‹
- å‹å¤‰æ›ã‚¨ãƒ©ãƒ¼ã‚„ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è¨­å®šãƒŸã‚¹ãŒãªã„ã‹

### 7.2 å­¦ç¿’ç¯„å›²ã®å¦¥å½“æ€§
- 365æ—¥ã§å­¦ç¿’ã—ã¦ã„ã‚‹ãŒã€æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã¨ã®ä¹–é›¢ã¯ï¼Ÿ
- walkforwardè©•ä¾¡æœŸé–“ã‚’å»¶ã°ã™å¿…è¦ã¯ï¼Ÿ

---

## 8. ã¾ã¨ã‚

### æ ¹æœ¬åŸå› 
1. âœ… **`--end-date` æœªæŒ‡å®š**: serve_predict_model_v4_2_4.pyãŒæ­£ã—ã„æ—¥ä»˜ã§äºˆæ¸¬ã§ããªã„
2. âœ… **äºˆç´„ãƒ‡ãƒ¼ã‚¿ç¯„å›²ãŒé–“é•ã„**: `target_date + 7` ã¯æœªæ¥ãªã®ã§å­˜åœ¨ã—ãªã„
3. âš ï¸ **äºˆæ¸¬çµæœã®ãƒ‘ãƒ¼ã‚¹**: 79.5ãƒˆãƒ³ãŒ1.0ãƒˆãƒ³ã«ãªã‚‹ç†ç”±ã¯è¦è¿½åŠ èª¿æŸ»

### å„ªå…ˆåº¦
- ğŸ”´ **Critical**: ä¿®æ­£1, 2ã‚’å³åº§ã«å®Ÿæ–½
- ğŸŸ¡ **High**: ä¿®æ­£3ã®æ¤œè¨¼
- ğŸŸ¢ **Medium**: å†ç™ºé˜²æ­¢ç­–ã®å®Ÿè£…

### å½±éŸ¿
- ä¿®æ­£ã«ã‚ˆã‚Šã€æ­£ã—ã„target_dateã®äºˆæ¸¬ãŒè¡Œã‚ã‚Œã‚‹
- äºˆç´„ãƒ‡ãƒ¼ã‚¿ãŒtarget_dateå½“æ—¥ã¾ã§å«ã¾ã‚Œã‚‹
- äºˆæ¸¬å€¤ãŒç¾å®Ÿçš„ãªç¯„å›²ï¼ˆ20ï½100ãƒˆãƒ³ï¼‰ã«ãªã‚‹è¦‹è¾¼ã¿

---

**æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: ä¿®æ­£1, 2ã‚’å®Ÿè£… â†’ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ â†’ çµæœæ¤œè¨¼
