# 日付整合性検証結果レポート

**実行日時**: 2025-12-18  
**検証環境**: local_dev (Docker Compose経由)  
**データベース**: sanbou_dev  
**SQLファイル**: [20251218_date_alignment_check.sql](./20251218_date_alignment_check.sql)

---

## 📋 検証目的

1. **データ範囲**: stg受入は過去360日前後、mart予約は361日前後（当日含む）
2. **当日含有**: 予約は当日を含む、受入は前日まで（当日なし）
3. **日付整合**: 両者の日付キーが揃っているか、ズレがないか

---

## 🧪 検証結果サマリー

### 対象日: 2025-12-18（今日）

| 項目 | stg.v_active_shogun_flash_receive（受入） | mart.v_reserve_daily_for_forecast（予約） |
|------|------------------------------------------|------------------------------------------|
| **最小日付** | 2024-12-23 | 2024-12-23 |
| **最大日付** | 2025-12-15（3日前） | 2025-12-18（当日） |
| **総レコード数** | 57,334 | 337 |
| **異なる日数** | 347日 | 337日 |
| **当日レコード** | 0（✅正常） | 1（✅正常、93台予約） |

**判定**: 
- ✅ 受入は当日なし（前日まで）
- ✅ 予約は当日あり（93台、固定60台）
- ⚠️ 受入の最大日が12/15（3日前）→**最新データが不足**

---

### 対象日: 2025-12-19（明日）

| 項目 | stg.v_active_shogun_flash_receive（受入） | mart.v_reserve_daily_for_forecast（予約） |
|------|------------------------------------------|------------------------------------------|
| **最小日付** | 2024-12-24 | 2024-12-24 |
| **最大日付** | 2025-12-15（4日前） | 2025-12-19（当日） |
| **総レコード数** | 57,112 | 337 |
| **異なる日数** | 346日 | 337日 |
| **当日レコード** | 0（✅正常） | 1（✅正常、89台予約） |

**判定**: 
- ✅ 受入は当日なし（前日まで）
- ✅ 予約は当日あり（89台、固定49台）
- ⚠️ 受入の最大日が12/15（4日前）→**最新データが不足**

---

## 🔍 日付集合差分の詳細

両データソース間で存在しない日付（365日範囲内）:

### 受入のみ存在（予約になし）

祝日・連休で受入実績はあるが予約がなかった日（休業日扱い）:

| 日付 | 曜日 | 推定理由 |
|------|------|---------|
| 2024-12-29 | 日曜 | 年末休業 |
| 2025-01-04 | 土曜 | 正月休業 |
| 2025-03-09 | 日曜 | 定休日 |
| 2025-04-13 | 日曜 | 定休日 |
| 2025-05-03 | 土曜 | GW（憲法記念日） |
| 2025-05-05 | 月曜 | GW（こどもの日） |
| 2025-05-06 | 火曜 | GW振替休日 |
| 2025-07-13 | 日曜 | 定休日 |
| 2025-08-13 | 水曜 | お盆 |
| 2025-08-14 | 木曜 | お盆 |
| 2025-08-15 | 金曜 | お盆 |
| 2025-08-16 | 土曜 | お盆 |
| 2025-09-14 | 日曜 | 定休日 |

**合計**: 13日

### 予約のみ存在（受入になし）

最近3日間は受入データがまだ入っていない（更新遅延）:

| 日付 | 曜日 | 状況 |
|------|------|------|
| 2025-12-16 | 火曜 | 受入データ未着 |
| 2025-12-17 | 水曜 | 受入データ未着 |
| 2025-12-18 | 木曜 | 当日（受入は前日まで） |

※対象日=12/19の場合は12/19も追加

---

## 📊 詳細検証結果

### 1-A) stg受入：データ範囲（対象日=2025-12-18）

```
  min_date  |  max_date  | total_rows | distinct_days | days_from_min | days_from_max 
------------+------------+------------+---------------+---------------+---------------
 2024-12-23 | 2025-12-15 |      57334 |           347 |           360 |             3
```

- **範囲**: 2024-12-23 ～ 2025-12-15（360日間）
- **最大日からの差**: 3日前（⚠️ 12/16, 12/17のデータが未着）
- **日数**: 347日（期待360日に対し-13日＝祝休日分）

### 1-B) mart予約：データ範囲（対象日=2025-12-18）

```
  min_date  |  max_date  | total_rows | distinct_days | rows_on_target_date | days_from_min | days_beyond_target 
------------+------------+------------+---------------+---------------------+---------------+--------------------
 2024-12-23 | 2025-12-18 |        337 |           337 |                   1 |           360 |                  0
```

- **範囲**: 2024-12-23 ～ 2025-12-18（361日間、当日含む）
- **最大日**: 当日まで（✅正常）
- **日数**: 337日（休業日除く営業日ベース）

### 2-A) 予約：当日データ確認

```
 reserve_day | reserve_trucks | reserve_fixed_trucks | trucks_state 
-------------+----------------+----------------------+--------------
 2025-12-18  |             93 |                   60 | POSITIVE
```

✅ **正常**: 当日（12/18）の予約データが存在、93台予約（内60台は固定顧客）

### 2-B) 受入：当日混入チェック

```
 rows_on_target_date |       status       
---------------------+--------------------
                   0 | OK: 当日データなし
```

✅ **正常**: 当日（12/18）の受入データは存在しない（前日までのデータ）

---

## 🚨 課題と推奨アクション

### ⚠️ 重要な発見

1. **受入データの更新遅延**
   - 最新が12/15（3日前）
   - 12/16, 12/17のデータが未着
   - **原因候補**: 
     - データ取り込みバッチの遅延
     - 週末アップロード遅れ
     - stg.v_active_shogun_flash_receive のビュー定義が日付フィルタを持っている可能性
   
   **推奨調査**:
   ```sql
   -- 元テーブルに最新データがあるか確認
   SELECT MAX(slip_date), COUNT(*)
   FROM stg.shogun_flash_receive
   WHERE slip_date >= '2025-12-15'::date;
   ```

2. **日付差分（受入のみ13日）**
   - 祝休日で受入実績はあるが予約がない日
   - これは**正常な業務パターン**（休業日の翌日等に受入処理）
   - 予測モデルは休業日を考慮する必要あり

3. **日付差分（予約のみ3-4日）**
   - 最近の日付で受入データ未着
   - **予測への影響**: 直近3日のデータ不足により短期トレンド捕捉が困難

---

## ✅ 結論

### データ品質判定

| 検証項目 | 結果 | 詳細 |
|---------|------|------|
| 受入：当日含有 | ✅ PASS | 当日データなし（前日まで） |
| 予約：当日含有 | ✅ PASS | 当日データあり（93台） |
| 日付粒度の一致 | ✅ PASS | 両者ともdate型、TZズレなし |
| データ範囲（360日） | ⚠️ WARN | 受入が347日（祝休日-13日は許容範囲） |
| 最新性 | ⚠️ WARN | 受入が3日遅延（12/16, 12/17未着） |

### 予測パイプラインへの影響

- **当日含有**: ✅ 正しく分離されている
- **日付整合**: ✅ 型ズレなし、結合可能
- **データ鮮度**: ⚠️ 直近3日の受入データ不足は短期予測精度に影響
- **休業日処理**: ⚠️ 13日の差分は業務カレンダーの考慮が必要

### 次の調査ステップ

1. **受入データ更新遅延の原因調査**
   ```sql
   SELECT MAX(slip_date) FROM stg.shogun_flash_receive;
   SELECT MAX(slip_date) FROM stg.v_active_shogun_flash_receive;
   ```
   → ビュー定義に日付制限があるか確認

2. **休業日カレンダーの整備**
   - 13日の差分日を営業カレンダーテーブルと照合
   - 予測モデルに休業日フラグを追加

3. **データ取り込みスケジュールの確認**
   - いつ、どのバッチで受入データが更新されるか
   - 予測実行タイミングとの整合性確認

---

## 📎 添付資料

- SQLファイル: [20251218_date_alignment_check.sql](./20251218_date_alignment_check.sql)
- 実行ログ: `/tmp/result_today.txt`, `/tmp/result_tomorrow.txt`
- 関連Issue: （必要に応じて記入）

---

**レポート作成者**: GitHub Copilot  
**承認者**: （レビュー後記入）
