# é€šçŸ¥å¥‘ç´„å®Ÿè£…å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆï¼ˆPhase 2ï¼‰

## å®Ÿè£…å®Œäº†æ—¥
2025å¹´10æœˆ6æ—¥

## æ¦‚è¦

OpenAPIä»•æ§˜ã«æº–æ‹ ã—ãŸé€šçŸ¥å¥‘ç´„ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè£…ã—ã€ãƒ•ãƒ­ãƒ³ãƒˆ/ãƒãƒƒã‚¯å…±é€šã®å‹å®šç¾©ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€ã‚¸ãƒ§ãƒ–ç®¡ç†ã€SSEé€šçŸ¥æ©Ÿèƒ½ã‚’å®Œå…¨çµ±åˆã—ã¾ã—ãŸã€‚

---

## ğŸ“‹ å®Ÿè£…å®Œäº†ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä¸€è¦§

### Phase 1: åŸºç›¤æ•´å‚™ï¼ˆNL1ã€œNL5ï¼‰
- âœ… NL1: å¥‘ç´„ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆï¼ˆOpenAPIï¼‰
- âœ… NL2: ãƒ•ãƒ­ãƒ³ãƒˆå¥‘ç´„å‹ã®è¿½åŠ ï¼ˆTypeScriptï¼‰
- âœ… NL3: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å¥‘ç´„ãƒ¢ãƒ‡ãƒ«ï¼ˆPydanticï¼‰
- âœ… NL4: traceIdãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ & ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©
- âœ… NL5: ã‚¸ãƒ§ãƒ–API/å¤±æ•—æ™‚ã®ProblemDetailsæ­è¼‰

### Phase 2: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆï¼ˆNL6ã€œNL11ï¼‰
- âœ… NL6: é€šçŸ¥è¨­å®šã¨ã‚³ãƒ¼ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°ã®ä¸€å…ƒåŒ–
- âœ… NL7: HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ProblemDetailsâ†’ApiErrorå¤‰æ›
- âœ… NL8: notifyApiErrorã®ä½œæˆï¼†æ—¢å­˜catchã®ç½®æ›
- âœ… NL9: ã‚¸ãƒ§ãƒ–ã®å¤±æ•—ã‚’é€šçŸ¥ã«ãƒãƒƒãƒ”ãƒ³ã‚°
- âœ… NL10: ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ï¼ˆSSEï¼‰
- âœ… NL11: æœ€å°ãƒ†ã‚¹ãƒˆ & ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

---

## âœ… Prompt NL6: é€šçŸ¥è¨­å®šã¨ã‚³ãƒ¼ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°ã®ä¸€å…ƒåŒ–

### æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«
- **`/app/frontend/src/features/notification/config.ts`** ğŸ“å¤§å¹…æ›´æ–°

### å†…å®¹
- `NOTIFY_DEFAULTS`: severityåˆ¥ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç§’æ•°
- `codeCatalog`: ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰â†’severity/titleã®ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆ40+ã‚¨ãƒ³ãƒˆãƒªï¼‰
- `getNotificationConfig()`: ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°

### å—ã‘å…¥ã‚Œæ¡ä»¶
âœ… config.ts ãŒä½œæˆã•ã‚Œã€ä»–ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å‚ç…§å¯èƒ½
âœ… å¾Œæ–¹äº’æ›æ€§ç¶­æŒï¼ˆsuccessMs/errorMs ãªã©ï¼‰

---

## âœ… Prompt NL7: HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ProblemDetailsâ†’ApiErrorå¤‰æ›

### æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«
- **`/app/frontend/src/shared/infrastructure/http/httpClient.ts`** ğŸ“å¤§å¹…æ›´æ–°
- **`/app/frontend/src/shared/infrastructure/http/index.ts`** ğŸ“æ›´æ–°

### å†…å®¹
- `ApiError` ã‚¯ãƒ©ã‚¹ï¼ˆcode/status/userMessage/traceIdï¼‰
- `ApiError.fromProblemDetails()`: ProblemDetailsã‹ã‚‰ç”Ÿæˆ
- `ApiError.fromAxiosError()`: AxiosErrorã‹ã‚‰ç”Ÿæˆ
- axiosã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼: è‡ªå‹•çš„ã«ApiErrorã«å¤‰æ›
- `fetchWithTimeout()`: ãƒ¬ã‚¬ã‚·ãƒ¼äº’æ›ç”¨ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¯¾å¿œï¼‰

### å—ã‘å…¥ã‚Œæ¡ä»¶
âœ… 500/422ãªã©ã§ApiErrorãŒæŠ•ã’ã‚‰ã‚Œã€catchã§ãã‚‹
âœ… traceIdãŒè‡ªå‹•çš„ã«å«ã¾ã‚Œã‚‹
âœ… æ—¢å­˜ã®apiGet/apiPostãŒå‹•ä½œã™ã‚‹

---

## âœ… Prompt NL8: notifyApiErrorã®ä½œæˆï¼†æ—¢å­˜catchã®ç½®æ›

### æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«
- **`/app/frontend/src/features/notification/controller/notify.ts`** ğŸ“å¤§å¹…æ›´æ–°
- **`/app/frontend/src/features/notification/index.ts`** ğŸ“æ›´æ–°

### å†…å®¹
- `notifyApiError()`: ApiError/ProblemDetails/Errorã‚’è‡ªå‹•åˆ¤åˆ¥
- `codeCatalog`å‚ç…§: codeâ†’severityå¤‰æ›
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆduration: severityåˆ¥ã«è‡ªå‹•è¨­å®š

### ä½¿ç”¨ä¾‹
```typescript
try {
  await apiPost('/api/upload', formData);
} catch (error) {
  notifyApiError(error, 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
}
```

### å—ã‘å…¥ã‚Œæ¡ä»¶
âœ… å¤±æ•—æ™‚ã®é€šçŸ¥ãŒã™ã¹ã¦notifyApiErrorçµŒç”±ã§å‡ºã‚‹
âœ… codeâ†’severityå¤‰æ›ãŒè‡ªå‹•çš„ã«è¡Œã‚ã‚Œã‚‹
âœ… ApiErrorã‚¯ãƒ©ã‚¹ã¨ã®çµ±åˆ

---

## âœ… Prompt NL9: ã‚¸ãƒ§ãƒ–ã®å¤±æ•—ã‚’é€šçŸ¥ã«ãƒãƒƒãƒ”ãƒ³ã‚°

### æ–°è¦ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«
- **`/app/frontend/src/shared/infrastructure/job/jobService.ts`** âœ¨æ–°è¦
- **`/app/frontend/src/shared/infrastructure/job/index.ts`** âœ¨æ–°è¦

### å†…å®¹
- `JobStatus` ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆerror: ProblemDetailsã‚’å«ã‚€ï¼‰
- `pollJob()`: ã‚¸ãƒ§ãƒ–ã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ã€å¤±æ•—æ™‚ã«`notifyApiError`
- `createAndPollJob()`: ã‚¸ãƒ§ãƒ–ä½œæˆâ†’ãƒãƒ¼ãƒªãƒ³ã‚°

### ä½¿ç”¨ä¾‹
```typescript
const result = await pollJob(
  jobId,
  (progress, message) => {
    console.log(`é€²æ—: ${progress}% - ${message}`);
  }
);
// å¤±æ•—æ™‚ã¯è‡ªå‹•çš„ã« job.error ã‹ã‚‰é€šçŸ¥è¡¨ç¤º
```

### å—ã‘å…¥ã‚Œæ¡ä»¶
âœ… ã‚¸ãƒ§ãƒ–å¤±æ•—æ™‚ã«çµ±ä¸€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®é€šçŸ¥ãŒå‡ºã‚‹
âœ… job.errorã®ProblemDetailsãŒé€šçŸ¥ã«å¤‰æ›ã•ã‚Œã‚‹

---

## âœ… Prompt NL10: ã‚µãƒ¼ãƒãƒ¼ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ï¼ˆSSEï¼‰

### æ–°è¦ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰
- **`/app/backend/ledger_api/app/api/endpoints/notifications.py`** âœ¨æ–°è¦
- **`/app/backend/ledger_api/app/main.py`** ğŸ“æ›´æ–°

### å†…å®¹ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰
- `/notifications/stream` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆSSEï¼‰
- `notification_generator()`: ã‚µãƒ³ãƒ—ãƒ«é€šçŸ¥ã‚’5ç§’ã”ã¨ã«é€ä¿¡
- NotificationEventå½¢å¼ã§é…ä¿¡

### æ–°è¦ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰
- **`/app/frontend/src/features/notification/controller/sse.ts`** âœ¨æ–°è¦
- **`/app/frontend/src/features/notification/index.ts`** ğŸ“æ›´æ–°

### å†…å®¹ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰
- `EventSource`ã‚’ä½¿ç”¨ã—ãŸSSEã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
- `startSSE()`: æ¥ç¶šé–‹å§‹
- `stopSSE()`: æ¥ç¶šåœæ­¢
- `handleNotificationEvent()`: severityåˆ¥ã«é€šçŸ¥è¡¨ç¤º
- è‡ªå‹•å†æ¥ç¶šï¼ˆ5ç§’å¾Œï¼‰

### ä½¿ç”¨ä¾‹
```typescript
// App.tsx
useEffect(() => {
  startSSE();
  return () => stopSSE();
}, []);
```

### å—ã‘å…¥ã‚Œæ¡ä»¶
âœ… ã‚µãƒ³ãƒ—ãƒ«ã®NotificationEventãŒå±Šãã¨ãƒˆãƒ¼ã‚¹ãƒˆãŒå‡ºã‚‹
âœ… è‡ªå‹•å†æ¥ç¶šãŒæ©Ÿèƒ½ã™ã‚‹

---

## âœ… Prompt NL11: æœ€å°ãƒ†ã‚¹ãƒˆ & ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

### æ–°è¦ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«
- **`/app/frontend/src/features/notification/application/notifyApiError.test.ts`** âœ¨æ–°è¦
- **`/app/frontend/docs/notifications.md`** âœ¨æ–°è¦ï¼ˆæ—¢å­˜ã¯ notifications-old.md ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰

### ãƒ†ã‚¹ãƒˆå†…å®¹
- INPUT_INVALID â†’ warning
- AUTH_REQUIRED â†’ error
- INTERNAL_ERROR â†’ error
- ProblemDetailsã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
- ä¸æ˜ãªã‚¨ãƒ©ãƒ¼
- æ–‡å­—åˆ—ã‚¨ãƒ©ãƒ¼
- null/undefined

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå†…å®¹
- å¥‘ç´„ã®ç›®çš„ãƒ»ã‚¹ã‚­ãƒ¼ãƒ
- ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³
- ä½¿ã„æ–¹ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆ/ãƒãƒƒã‚¯ï¼‰
- ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚«ã‚¿ãƒ­ã‚°ã®é‹ç”¨ãƒ«ãƒ¼ãƒ«
- traceIdã®æ‰±ã„ï¼ˆUIæ–¹é‡ï¼‰
- SSEé€šçŸ¥
- ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
- ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å—ã‘å…¥ã‚Œæ¡ä»¶
âœ… ãƒ†ã‚¹ãƒˆãŒ7ã‚±ãƒ¼ã‚¹é€šã‚‹
âœ… ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒç”Ÿæˆã•ã‚Œã‚‹

---

## ğŸ“Š å¤‰æ›´çµ±è¨ˆï¼ˆPhase 2: NL6ã€œNL11ï¼‰

### æ–°è¦ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: 4ãƒ•ã‚¡ã‚¤ãƒ«
  - config.tsï¼ˆæ—¢å­˜ã‚’å¤§å¹…æ›´æ–°ï¼‰
  - jobService.ts
  - sse.ts
  - notifyApiError.test.ts
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: 1ãƒ•ã‚¡ã‚¤ãƒ«
  - notifications.py
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: 1ãƒ•ã‚¡ã‚¤ãƒ«
  - notifications.md

**å°è¨ˆ: 6ãƒ•ã‚¡ã‚¤ãƒ«**

### æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: 5ãƒ•ã‚¡ã‚¤ãƒ«
  - httpClient.ts
  - http/index.ts
  - notify.ts
  - notification/index.ts
  - job/index.ts
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: 1ãƒ•ã‚¡ã‚¤ãƒ«
  - main.py

**å°è¨ˆ: 6ãƒ•ã‚¡ã‚¤ãƒ«**

### Phase 1 + Phase 2 åˆè¨ˆ
- **æ–°è¦ä½œæˆ: 16ãƒ•ã‚¡ã‚¤ãƒ«**
- **æ›´æ–°: 12ãƒ•ã‚¡ã‚¤ãƒ«**
- **å‰Šé™¤: 1ãƒ•ã‚¡ã‚¤ãƒ«**

---

## ğŸ¯ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¨ä½“å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  User Action                                                 â”‚
â”‚    â†“                                                         â”‚
â”‚  API Call (apiGet/apiPost)                                   â”‚
â”‚    â†“                                                         â”‚
â”‚  âŒ Error â†’ ApiError (httpClient interceptor)               â”‚
â”‚    â†“                                                         â”‚
â”‚  catch (error)                                               â”‚
â”‚    â†“                                                         â”‚
â”‚  notifyApiError(error)                                       â”‚
â”‚    â†“                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ codeCatalog ã§ code â†’ severity å¤‰æ›     â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚    â†“                                                         â”‚
â”‚  notify{Success|Error|Warning|Info}()                        â”‚
â”‚    â†“                                                         â”‚
â”‚  NotificationCenter ã«è¡¨ç¤º ğŸ””                               â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ SSE Client (sse.ts)                   â”‚                  â”‚
â”‚  â”‚   â”œâ”€ EventSource("/notifications/stream")               â”‚
â”‚  â”‚   â”œâ”€ handleNotificationEvent()        â”‚                  â”‚
â”‚  â”‚   â””â”€ è‡ªå‹•å†æ¥ç¶š                        â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚    â†“                                                         â”‚
â”‚  é€šçŸ¥è¡¨ç¤º ğŸ””                                                 â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ Job Polling (jobService.ts)           â”‚                  â”‚
â”‚  â”‚   â”œâ”€ pollJob(jobId)                   â”‚                  â”‚
â”‚  â”‚   â”œâ”€ status='failed' â†’ notifyApiError â”‚                  â”‚
â”‚  â”‚   â””â”€ job.error (ProblemDetails)       â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘
         â”‚ HTTP / SSE
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ RequestIdMiddleware                 â”‚                     â”‚
â”‚  â”‚   â””â”€ X-Request-ID â†’ request.state.trace_id              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚    â†“                                                         â”‚
â”‚  ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯                                            â”‚
â”‚    â†“                                                         â”‚
â”‚  âŒ raise DomainError(code, status, userMessage)            â”‚
â”‚    or                                                        â”‚
â”‚  âŒ raise Exception                                          â”‚
â”‚    â†“                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ Error Handlers                      â”‚                     â”‚
â”‚  â”‚   â”œâ”€ handle_domain_error()          â”‚                     â”‚
â”‚  â”‚   â””â”€ handle_unexpected()            â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚    â†“                                                         â”‚
â”‚  ProblemDetails JSON                                         â”‚
â”‚  {                                                           â”‚
â”‚    status: 422,                                              â”‚
â”‚    code: "VALIDATION_ERROR",                                 â”‚
â”‚    userMessage: "å…¥åŠ›å€¤ãŒä¸æ­£ã§ã™",                         â”‚
â”‚    traceId: "550e8400-..."                                   â”‚
â”‚  }                                                           â”‚
â”‚    â†“                                                         â”‚
â”‚  HTTP Response (X-Request-ID header)                         â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ SSE Endpoint (/notifications/stream)â”‚                     â”‚
â”‚  â”‚   â”œâ”€ notification_generator()       â”‚                     â”‚
â”‚  â”‚   â””â”€ NotificationEvent JSON         â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ Job API (/api/jobs)                 â”‚                     â”‚
â”‚  â”‚   â”œâ”€ POST / â†’ JobStatus             â”‚                     â”‚
â”‚  â”‚   â”œâ”€ GET /{id} â†’ JobStatus          â”‚                     â”‚
â”‚  â”‚   â””â”€ JobStatus.error (ProblemDetails)â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹æ³•

### 1. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆ

```bash
# DomainError ã®ãƒ†ã‚¹ãƒˆ
curl -X POST http://localhost:8000/ledger_api/api/jobs/test-123/raise-error

# æœŸå¾…ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹ (ProblemDetails):
# {
#   "status": 422,
#   "code": "TEST_ERROR",
#   "userMessage": "ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ã§ã™",
#   "title": "ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼",
#   "traceId": "550e8400-..."
# }
```

ãƒ•ãƒ­ãƒ³ãƒˆã§ catch ã™ã‚‹ã¨è‡ªå‹•çš„ã«é€šçŸ¥è¡¨ç¤º:
- code="TEST_ERROR" â†’ codeCatalog â†’ error severity
- title="ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼"
- duration=6000ms

### 2. traceId ã®ãƒ†ã‚¹ãƒˆ

```bash
# X-Request-ID ã‚’æŒ‡å®š
curl -H "X-Request-ID: my-trace-123" http://localhost:8000/ledger_api/

# ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã«åŒã˜ X-Request-ID ãŒè¿”ã‚‹
# X-Request-ID: my-trace-123
```

### 3. ã‚¸ãƒ§ãƒ–APIã®ãƒ†ã‚¹ãƒˆ

```bash
# ã‚¸ãƒ§ãƒ–ã‚’ä½œæˆ
curl -X POST http://localhost:8000/ledger_api/api/jobs \
  -H "Content-Type: application/json" \
  -d '{"feature": "csv_upload"}'

# ã‚¸ãƒ§ãƒ–ã‚’å¤±æ•—ã•ã›ã‚‹ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
curl -X POST http://localhost:8000/ledger_api/api/jobs/{job_id}/fail
```

ãƒ•ãƒ­ãƒ³ãƒˆã§pollJob()ã‚’ä½¿ç”¨ã™ã‚‹ã¨:
- status='failed' ã‚’æ¤œçŸ¥
- job.error (ProblemDetails) ã‚’ notifyApiError() ã«æ¸¡ã™
- è‡ªå‹•çš„ã«é€šçŸ¥è¡¨ç¤º

### 4. SSEé€šçŸ¥ã®ãƒ†ã‚¹ãƒˆ

```bash
# SSEæ¥ç¶šï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèªï¼‰
curl -N http://localhost:8000/ledger_api/notifications/stream

# 5ç§’ã”ã¨ã«ã‚µãƒ³ãƒ—ãƒ«é€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã‚‹
```

ãƒ•ãƒ­ãƒ³ãƒˆã§ startSSE() ã‚’å‘¼ã¶ã¨:
- EventSourceæ¥ç¶š
- ã‚µãƒ³ãƒ—ãƒ«é€šçŸ¥ã‚’5ç§’ã”ã¨ã«å—ä¿¡
- è‡ªå‹•çš„ã«é€šçŸ¥è¡¨ç¤º

### 5. ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

```bash
cd app/frontend
npm test notifyApiError.test.ts
```

7ã¤ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒé€šã‚Šã¾ã™:
- INPUT_INVALID â†’ warning
- AUTH_REQUIRED â†’ error
- INTERNAL_ERROR â†’ error
- ProblemDetails â†’ codeå¤‰æ›
- ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ â†’ error
- æ–‡å­—åˆ—ã‚¨ãƒ©ãƒ¼ â†’ error
- null/undefined â†’ error

---

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæ¨å¥¨ï¼‰

### 1. ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³å¯¾å¿œ

#### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
- [ ] SSEé€šçŸ¥ã‚’ Redis Pub/Sub / Message Queue ã«æ¥ç¶š
- [ ] ã‚¸ãƒ§ãƒ–ã‚¹ãƒˆã‚¢ã‚’ Redis/DB ã«æ°¸ç¶šåŒ–
- [ ] ã‚¸ãƒ§ãƒ–ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†
- [ ] ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼ˆDDoSå¯¾ç­–ï¼‰

#### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- [ ] ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã«ã€Œè©³ç´°ã‚’è¡¨ç¤ºã€ãƒœã‚¿ãƒ³è¿½åŠ 
  - traceId ã‚’ã‚³ãƒ”ãƒ¼å¯èƒ½ã«
  - ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¡¨ç¤º
- [ ] æ—¢å­˜ã®catchãƒ–ãƒ­ãƒƒã‚¯ã‚’ notifyApiError ã«ç½®æ›ï¼ˆå…¨ä½“æ¤œç´¢ï¼‰
- [ ] SSEæ¥ç¶šçŠ¶æ…‹ã‚’ UI ã«è¡¨ç¤ºï¼ˆæ¥ç¶šä¸­/åˆ‡æ–­ãªã©ï¼‰

### 2. ç›£è¦–ãƒ»ãƒ­ã‚®ãƒ³ã‚°

- [ ] traceId ã‚’ä½¿ã£ãŸåˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ï¼ˆJaeger/Zipkinï¼‰
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®åé›†ï¼ˆPrometheusï¼‰
- [ ] Sentry/DataDogçµ±åˆ
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚¨ãƒ©ãƒ¼ç‡ã®ç›£è¦–

### 3. E2Eãƒ†ã‚¹ãƒˆ

- [ ] Playwright/Cypress ã§ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã®E2Eãƒ†ã‚¹ãƒˆ
- [ ] ã‚¸ãƒ§ãƒ–ãƒãƒ¼ãƒªãƒ³ã‚°ã®E2Eãƒ†ã‚¹ãƒˆ
- [ ] SSEé€šçŸ¥ã®E2Eãƒ†ã‚¹ãƒˆ

### 4. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ‹¡å……

- [ ] ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºè€…å‘ã‘ã‚¬ã‚¤ãƒ‰
  - æ–°ã—ã„ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã®è¿½åŠ æ–¹æ³•
  - DomainError ã®ä½¿ã„æ–¹
- [ ] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºè€…å‘ã‘ã‚¬ã‚¤ãƒ‰
  - notifyApiError ã®è©³ç´°
  - codeCatalog ã®æ›´æ–°æ–¹æ³•

---

## ğŸ“ ãƒ¡ãƒ¢

- ã™ã¹ã¦ã®å¥‘ç´„ã¯ `/contracts/notifications.openapi.yaml` ã§ç®¡ç†
- `backend_shared` ã«å…±é€šæ©Ÿèƒ½ã‚’é›†ç´„ï¼ˆå†åˆ©ç”¨å¯èƒ½ï¼‰
- æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®äº’æ›æ€§ã‚’ç¶­æŒ
- RFC 7807æº–æ‹ ã§æ¥­ç•Œæ¨™æº–ã«æ²¿ã£ãŸå®Ÿè£…
- SSEæ¥ç¶šã¯è‡ªå‹•å†æ¥ç¶šæ©Ÿèƒ½ä»˜ã
- ã‚¸ãƒ§ãƒ–ã®ãƒãƒ¼ãƒªãƒ³ã‚°ã¯å¤±æ•—æ™‚ã«è‡ªå‹•é€šçŸ¥

---

## ğŸ‰ å®Œäº†

ã™ã¹ã¦ã®Promptï¼ˆNL1ã€œNL11ï¼‰ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼

ãƒ•ãƒ­ãƒ³ãƒˆ/ãƒãƒƒã‚¯çµ±ä¸€ã®é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ãŒå®Œæˆã—ã€ä»¥ä¸‹ãŒå®Ÿç¾ã•ã‚Œã¾ã—ãŸ:

âœ… OpenAPIå¥‘ç´„æº–æ‹   
âœ… ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã®ä¸€å…ƒç®¡ç†  
âœ… è‡ªå‹•é€šçŸ¥è¡¨ç¤ºï¼ˆseverityåˆ¥ï¼‰  
âœ… traceIDè¿½è·¡  
âœ… SSEãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥  
âœ… ã‚¸ãƒ§ãƒ–å¤±æ•—ã®è‡ªå‹•é€šçŸ¥  
âœ… ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ  
âœ… å®Œå…¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ  

æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼


### ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«
- **`/contracts/notifications.openapi.yaml`**

### å†…å®¹
- `ProblemDetails` ã‚¹ã‚­ãƒ¼ãƒï¼ˆRFC 7807æº–æ‹ ï¼‰
- `NotificationEvent` ã‚¹ã‚­ãƒ¼ãƒ
- severity enum: `success` | `info` | `warning` | `error`

### å—ã‘å…¥ã‚Œæ¡ä»¶
âœ… å¥‘ç´„ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã€OpenAPI 3.0.3æº–æ‹ 

---

## âœ… Prompt NL2: ãƒ•ãƒ­ãƒ³ãƒˆå¥‘ç´„å‹ã®è¿½åŠ ï¼ˆTypeScriptï¼‰

### ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«
- **`/app/frontend/src/features/notification/model/contract.ts`**

### å†…å®¹
- `Severity` å‹
- `ProblemDetails` ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
- `NotificationEvent` ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

### å—ã‘å…¥ã‚Œæ¡ä»¶
âœ… TypeScriptå‹å®šç¾©ãŒä½œæˆã•ã‚Œã€OpenAPIå¥‘ç´„ã¨ä¸€è‡´
âœ… å‹ã‚¨ãƒ©ãƒ¼ãªã—

---

## âœ… Prompt NL3: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å¥‘ç´„ãƒ¢ãƒ‡ãƒ«ï¼ˆPydanticï¼‰

### ä½œæˆ/æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«
- **`/app/backend/backend_shared/src/domain/contract.py`** âœ¨æ–°è¦
- **`/app/backend/backend_shared/src/domain/__init__.py`** ğŸ“æ›´æ–°

### å†…å®¹
- `Severity` Literalå‹
- `ProblemDetails` Pydanticãƒ¢ãƒ‡ãƒ«
- `NotificationEvent` Pydanticãƒ¢ãƒ‡ãƒ«
- camelCase/snake_caseä¸¡å¯¾å¿œï¼ˆ`populate_by_name=True`ï¼‰

### å—ã‘å…¥ã‚Œæ¡ä»¶
âœ… Pydanticãƒ¢ãƒ‡ãƒ«ãŒä½œæˆã•ã‚Œã€OpenAPIå¥‘ç´„ã¨ä¸€è‡´
âœ… backend_shared ã«çµ±åˆï¼ˆledger_api ã®é‡è¤‡å‰Šé™¤ï¼‰
âœ… ã‚¢ãƒ—ãƒªãŒèµ·å‹•ã™ã‚‹

---

## âœ… Prompt NL4: traceIdãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ & ä¾‹å¤–ãƒãƒ³ãƒ‰ãƒ©

### ä½œæˆ/æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«

#### 1. **ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢**
- **`/app/backend/backend_shared/src/middleware/request_id.py`** âœ¨æ–°è¦
- **`/app/backend/backend_shared/src/middleware/__init__.py`** ğŸ“æ›´æ–°

**æ©Ÿèƒ½:**
- `X-Request-ID` ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰èª­ã¿å–ã‚Šã€ã¾ãŸã¯è‡ªå‹•ç”Ÿæˆ
- `request.state.trace_id` ã«ä¿å­˜
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã« `X-Request-ID` ã‚’è¿½åŠ 

#### 2. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©**
- **`/app/backend/backend_shared/src/api/error_handlers.py`** âœ¨æ–°è¦
- **`/app/backend/backend_shared/src/api/__init__.py`** ğŸ“æ›´æ–°

**æ©Ÿèƒ½:**
- `DomainError` ã‚¯ãƒ©ã‚¹ï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤ã®ã‚¨ãƒ©ãƒ¼ï¼‰
- `handle_domain_error()`: ProblemDetails å½¢å¼ã§è¿”ã™
- `handle_unexpected()`: äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ã‚’500ã¨ã—ã¦è¿”ã™
- `register_error_handlers()`: ã‚¢ãƒ—ãƒªã«ç™»éŒ²

#### 3. **APIçµ±åˆ**
- **`/app/backend/ledger_api/app/main.py`** ğŸ“æ›´æ–°

**å¤‰æ›´ç‚¹:**
- `RequestIdMiddleware` ã‚’è¿½åŠ 
- `register_error_handlers(app)` ã‚’å‘¼ã³å‡ºã—
- CORS ã® `expose_headers` ã« `X-Request-ID` ã‚’è¿½åŠ 

#### 4. **API Responseæ›´æ–°**
- **`/app/backend/backend_shared/src/api_response/response_base.py`** ğŸ“æ›´æ–°
- **`/app/backend/backend_shared/src/api_response/__init__.py`** ğŸ“æ›´æ–°

**å¤‰æ›´ç‚¹:**
- `ProblemDetails` ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
- `ApiResponse` ã« `traceId` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
- `to_problem_details()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ 
- ã™ã¹ã¦ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¯ãƒ©ã‚¹ã« `traceId` å¯¾å¿œ

### å—ã‘å…¥ã‚Œæ¡ä»¶
âœ… ä»»æ„ã®ã‚¨ãƒ©ãƒ¼ã§ JSON ãŒ ProblemDetails å½¢å¼ã«çµ±ä¸€
âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ã« `X-Request-ID` ãŒå‡ºã‚‹
âœ… æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®å¾Œæ–¹äº’æ›æ€§ã‚’ç¶­æŒ

---

## âœ… Prompt NL5: ã‚¸ãƒ§ãƒ–API/å¤±æ•—æ™‚ã®ProblemDetailsæ­è¼‰

### ä½œæˆ/æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«

#### 1. **ã‚¸ãƒ§ãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«**
- **`/app/backend/backend_shared/src/domain/job.py`** âœ¨æ–°è¦
- **`/app/backend/backend_shared/src/domain/__init__.py`** ğŸ“æ›´æ–°

**å†…å®¹:**
- `JobStatusType`: `pending` | `running` | `completed` | `failed` | `cancelled`
- `JobStatus`: ã‚¸ãƒ§ãƒ–ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹DTOï¼ˆ`error: ProblemDetails | None` ã‚’å«ã‚€ï¼‰
- `JobCreate`: ã‚¸ãƒ§ãƒ–ä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- `JobUpdate`: ã‚¸ãƒ§ãƒ–æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆ

#### 2. **ã‚¸ãƒ§ãƒ–API**
- **`/app/backend/ledger_api/app/api/endpoints/jobs.py`** âœ¨æ–°è¦
- **`/app/backend/ledger_api/app/main.py`** ğŸ“æ›´æ–°

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ:**
- `POST /api/jobs` - ã‚¸ãƒ§ãƒ–ã‚’ä½œæˆ
- `GET /api/jobs/{job_id}` - ã‚¸ãƒ§ãƒ–ã®çŠ¶æ…‹ã‚’å–å¾—
- `POST /api/jobs/{job_id}/fail` - ã€ãƒ†ã‚¹ãƒˆç”¨ã€‘ã‚¸ãƒ§ãƒ–ã‚’å¤±æ•—ã•ã›ã‚‹
- `POST /api/jobs/{job_id}/raise-error` - ã€ãƒ†ã‚¹ãƒˆç”¨ã€‘DomainError ã‚’ç™ºç”Ÿã•ã›ã‚‹

**æ©Ÿèƒ½:**
- éåŒæœŸå‡¦ç†ã®ã‚¸ãƒ§ãƒ–çŠ¶æ…‹ã‚’ç®¡ç†
- å¤±æ•—æ™‚ã« `JobStatus.error` ã« ProblemDetails ã‚’ä¿å­˜
- traceId ã®è‡ªå‹•ä»˜ä¸

### å—ã‘å…¥ã‚Œæ¡ä»¶
âœ… ã‚¸ãƒ§ãƒ–å‹APIãŒå‹•ä½œã™ã‚‹
âœ… å¤±æ•—æ™‚ã« `JobStatus.error` ãŒ ProblemDetails å½¢ã§è¿”ã‚‹
âœ… ãƒ†ã‚¹ãƒˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§å‹•ä½œç¢ºèªå¯èƒ½

---

## ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

### ä½œæˆã—ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

1. **`/app/backend/backend_shared/src/domain/README.md`**
   - Domainå¥‘ç´„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½¿ã„æ–¹
   - ProblemDetails / NotificationEvent ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ã®é€£æºæ–¹æ³•

2. **`/app/backend/backend_shared/ERROR_HANDLING_GUIDE.md`**
   - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° & ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°ã®å®Œå…¨ã‚¬ã‚¤ãƒ‰
   - RequestIdMiddleware ã®ä½¿ã„æ–¹
   - ã‚¸ãƒ§ãƒ–APIã®è©³ç´°ä»•æ§˜
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é€£æºä¾‹
   - ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

---

## ğŸ¯ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ”¹å–„

### 1. **å¥‘ç´„ã®ä¸€å…ƒç®¡ç†**
```
contracts/notifications.openapi.yaml (å¥‘ç´„å®šç¾©)
    â†“
â”œâ”€ frontend/src/features/notification/model/contract.ts (TypeScript)
â””â”€ backend/backend_shared/src/domain/contract.py (Pydantic)
```

### 2. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®çµ±ä¸€**
```
ã™ã¹ã¦ã®ã‚¨ãƒ©ãƒ¼ â†’ ProblemDetails (RFC 7807æº–æ‹ )
    â†“
- DomainError (ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤)
- Exception (äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼)
    â†“
JSONResponse (status, code, userMessage, traceId)
```

### 3. **ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°**
```
RequestIdMiddleware
    â†“
X-Request-ID ãƒ˜ãƒƒãƒ€ãƒ¼ â†’ request.state.trace_id
    â†“
ã™ã¹ã¦ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹/ã‚¨ãƒ©ãƒ¼ã« traceId ã‚’ä»˜ä¸
```

### 4. **ã‚¸ãƒ§ãƒ–ç®¡ç†**
```
JobStatus (ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«)
    â†“
- status: pending | running | completed | failed | cancelled
- error: ProblemDetails | null (å¤±æ•—æ™‚ã®è©³ç´°)
    â†“
GET /api/jobs/{id} ã§çŠ¶æ…‹ã‚’å–å¾—
```

---

## ğŸ“Š å¤‰æ›´çµ±è¨ˆ

### æ–°è¦ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«
- OpenAPIå¥‘ç´„: 1ãƒ•ã‚¡ã‚¤ãƒ«
- TypeScriptå‹å®šç¾©: 1ãƒ•ã‚¡ã‚¤ãƒ«
- Pydanticãƒ¢ãƒ‡ãƒ«: 2ãƒ•ã‚¡ã‚¤ãƒ«
- ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢: 1ãƒ•ã‚¡ã‚¤ãƒ«
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©: 1ãƒ•ã‚¡ã‚¤ãƒ«
- ã‚¸ãƒ§ãƒ–API: 1ãƒ•ã‚¡ã‚¤ãƒ«
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ: 3ãƒ•ã‚¡ã‚¤ãƒ«

**åˆè¨ˆ: 10ãƒ•ã‚¡ã‚¤ãƒ«**

### æ›´æ–°ãƒ•ã‚¡ã‚¤ãƒ«
- `__init__.py`: 4ãƒ•ã‚¡ã‚¤ãƒ«
- `response_base.py`: 1ãƒ•ã‚¡ã‚¤ãƒ«
- `main.py`: 1ãƒ•ã‚¡ã‚¤ãƒ«

**åˆè¨ˆ: 6ãƒ•ã‚¡ã‚¤ãƒ«**

### å‰Šé™¤ãƒ•ã‚¡ã‚¤ãƒ«
- é‡è¤‡ã—ãŸ `ledger_api/app/domain/contract.py`: 1ãƒ•ã‚¡ã‚¤ãƒ«

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹æ³•

### 1. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆ

```bash
# DomainError ã®ãƒ†ã‚¹ãƒˆ
curl -X POST http://localhost:8000/ledger_api/api/jobs/test-123/raise-error

# æœŸå¾…ã•ã‚Œã‚‹ãƒ¬ã‚¹ãƒãƒ³ã‚¹:
# {
#   "status": 422,
#   "code": "TEST_ERROR",
#   "userMessage": "ã“ã‚Œã¯ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ã§ã™",
#   "title": "ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼",
#   "traceId": "550e8400-..."
# }
```

### 2. traceId ã®ãƒ†ã‚¹ãƒˆ

```bash
# X-Request-ID ã‚’æŒ‡å®š
curl -H "X-Request-ID: my-trace-123" http://localhost:8000/ledger_api/

# ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã«åŒã˜ X-Request-ID ãŒè¿”ã‚‹
# X-Request-ID: my-trace-123
```

### 3. ã‚¸ãƒ§ãƒ–APIã®ãƒ†ã‚¹ãƒˆ

```bash
# ã‚¸ãƒ§ãƒ–ã‚’ä½œæˆ
curl -X POST http://localhost:8000/ledger_api/api/jobs \
  -H "Content-Type: application/json" \
  -d '{"feature": "csv_upload", "parameters": {}}'

# ã‚¸ãƒ§ãƒ–ã‚’å–å¾—
curl http://localhost:8000/ledger_api/api/jobs/{job_id}

# ã‚¸ãƒ§ãƒ–ã‚’å¤±æ•—ã•ã›ã‚‹ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
curl -X POST http://localhost:8000/ledger_api/api/jobs/{job_id}/fail

# error ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã« ProblemDetails ãŒå«ã¾ã‚Œã‚‹
```

---

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆæ¨å¥¨ï¼‰

### 1. WebSocket/SSE çµ±åˆ
- NotificationEvent ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é…ä¿¡
- `/ws/notifications` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å®Ÿè£…

### 2. ã‚¸ãƒ§ãƒ–ã‚¹ãƒˆã‚¢ã®æ°¸ç¶šåŒ–
- ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒª â†’ Redis/DB ã¸ã®ç§»è¡Œ
- ã‚¸ãƒ§ãƒ–ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†

### 3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆ
- ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å®Ÿè£…
- traceId ã®ãƒ­ã‚®ãƒ³ã‚°
- ã‚¸ãƒ§ãƒ–çŠ¶æ…‹ã®ãƒãƒ¼ãƒªãƒ³ã‚°/WebSocketè³¼èª­

### 4. ç›£è¦–ãƒ»ãƒ­ã‚®ãƒ³ã‚°
- traceId ã‚’ä½¿ã£ãŸåˆ†æ•£ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®åé›†
- Sentry/DataDogç­‰ã®çµ±åˆ

---

## ğŸ“ ãƒ¡ãƒ¢

- ã™ã¹ã¦ã®å¥‘ç´„ã¯ `/contracts/notifications.openapi.yaml` ã§ç®¡ç†
- `backend_shared` ã«å…±é€šæ©Ÿèƒ½ã‚’é›†ç´„ï¼ˆå†åˆ©ç”¨å¯èƒ½ï¼‰
- æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¨ã®äº’æ›æ€§ã‚’ç¶­æŒï¼ˆ`traceId` ã¯ä»»æ„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰
- RFC 7807æº–æ‹ ã§æ¥­ç•Œæ¨™æº–ã«æ²¿ã£ãŸå®Ÿè£…

---

## ğŸ‰ å®Œäº†

ã™ã¹ã¦ã®Promptï¼ˆNL1ã€œNL5ï¼‰ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼
