# ============================================================
# Pre-commit Configuration
# ============================================================
#
# このファイルはコミット前後のチェックを定義する「正本」です。
# - pre-commit install で Git hooks に組み込まれます
# - CI でも必ず実行されます
#
# 使い方:
#   make hooks-install  # 初回セットアップ
#   make hooks-run      # 全ファイルでチェック実行
#   make hooks-update   # hooks の自動アップデート
#
# ============================================================

# デフォルト設定
default_language_version:
  python: python3

default_stages: [pre-commit]

# 除外ディレクトリ
exclude: |
  (?x)^(
      data/|
      backups/|
      \.git/|
      __pycache__/|
      \.venv/|
      venv/|
      node_modules/|
      dist/|
      build/|
      \.cache/|
      \.mypy_cache/|
      \.pytest_cache/|
      \.ruff_cache/|
      migrations/versions/.*\.py$
  )

# ============================================================
# 基本チェック（ファイル整形・YAML/JSON検証）
# ============================================================
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      # ファイル整形
      - id: trailing-whitespace
        name: 行末空白を削除
        args: [--markdown-linebreak-ext=md]
        exclude: '(\.svg$|\.md$|\.txt$)'

      - id: end-of-file-fixer
        name: ファイル末尾に改行を追加
        exclude: '\.svg$'

      - id: mixed-line-ending
        name: 改行コードを統一（LF）
        args: [--fix=lf]

      # 構文チェック
      - id: check-yaml
        name: YAML構文チェック
        args: [--unsafe]

      - id: check-json
        name: JSON構文チェック

      - id: check-toml
        name: TOML構文チェック

      - id: check-xml
        name: XML構文チェック

      # マージコンフリクト検出
      - id: check-merge-conflict
        name: マージコンフリクトマーカーをチェック

      # 大きいファイルの検出
      - id: check-added-large-files
        name: 大きいファイルを検出（1000KB以上）
        args: [--maxkb=1000]

      # ケースの競合チェック（大文字小文字）
      - id: check-case-conflict
        name: ファイル名の大文字小文字競合をチェック

      # 実行権限の追加（スクリプト）
      - id: check-executables-have-shebangs
        name: 実行可能ファイルにshebangがあるかチェック

      # 秘密鍵検出
      - id: detect-private-key
        name: 秘密鍵を検出
        exclude: ^(scripts/git/lib/security_patterns\.sh|secrets/.*\.template|.*_example\..*|.*\.md)$

      # Python AST チェック
      - id: check-ast
        name: Python ASTをチェック
        types: [python]

  # ============================================================
  # Secrets検出（追加レイヤー）
  # ============================================================
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.5.0
    hooks:
      - id: detect-secrets
        name: 機密情報を検出 (detect-secrets)
        args:
          - "--baseline"
          - ".secrets.baseline"
          - "--exclude-files"
          - '^secrets/.*\.template$'
          - "--exclude-files"
          - '^.*_example\..*$'
          - "--exclude-files"
          - "^docs/.*$"
          - "--exclude-files"
          - '^.*migrations.*alembic/versions/.*\.py$'
          - "--exclude-files"
          - "^scripts/test/.*$"
          - "--exclude-files"
          - '^scripts/git/lib/security_patterns\.sh$'
          - "--exclude-files"
          - '^.*\.ipynb$'
          - "--exclude-files"
          - '^app/backend/.*\.env\.example$'
          - "--exclude-files"
          - '^app/backend/.*/README\.md$'
          - "--exclude-files"
          - '^ops/db/legacy/.*\.sql$'
        exclude: |
          (?x)^(
              package-lock\.json|
              .*\.lock|
              \.secrets\.baseline
          )$

  # ============================================================
  # Python フォーマット・リント
  # ============================================================
  - repo: https://github.com/psf/black
    rev: 25.12.0
    hooks:
      - id: black
        name: Python コードフォーマット (black)
        language_version: python3
        files: ^app/backend/.*\.py$

  - repo: https://github.com/pycqa/isort
    rev: 7.0.0
    hooks:
      - id: isort
        name: Python importソート (isort)
        args: ["--profile", "black"]
        files: ^app/backend/.*\.py$

  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.14.10
    hooks:
      - id: ruff
        name: Python リント (ruff)
        args: [--fix, --exit-zero]
        files: ^app/backend/.*\.py$

  # ============================================================
  # Frontend (JavaScript/TypeScript)
  # ============================================================
  - repo: https://github.com/pre-commit/mirrors-prettier
    rev: v4.0.0-alpha.8
    hooks:
      - id: prettier
        name: フロントエンドフォーマット (Prettier)
        types_or: [javascript, jsx, ts, tsx, json, yaml, markdown]
        exclude: |
          (?x)^(
              package-lock\.json|
              pnpm-lock\.yaml|
              yarn\.lock|
              .*\.lock|
              \.min\.(js|css)$|
              \.hadolint\.yaml$
          )
        additional_dependencies:
          - prettier@3.3.3

  - repo: https://github.com/pre-commit/mirrors-eslint
    rev: v10.0.0-beta.0
    hooks:
      - id: eslint
        name: TypeScript/JavaScript リント (ESLint)
        files: ^app/frontend/src/.*\.[jt]sx?$
        types: [file]
        args: [--fix, --config, app/frontend/eslint.config.js]
        additional_dependencies:
          - eslint@^9.17.0
          - typescript@^5.7.2
          - "@typescript-eslint/parser@^8.18.1"
          - "@typescript-eslint/eslint-plugin@^8.18.1"
          - eslint-plugin-react@^7.37.2
          - eslint-plugin-react-hooks@^5.1.0
          - globals@^15.0.0
          - "@eslint/js@^9.0.0"
          - eslint-plugin-boundaries@^5.0.0

  # ============================================================
  # Docker・Dockerfileチェック
  # ============================================================
  - repo: https://github.com/hadolint/hadolint
    rev: v2.14.0
    hooks:
      - id: hadolint-docker
        name: Dockerfile リント (hadolint)
        args: [--config, .hadolint.yaml]

  # ============================================================
  # Markdown リント
  # ============================================================
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.47.0
    hooks:
      - id: markdownlint
        name: Markdown リント
        args: [--fix, --disable, MD013, MD033, MD041]

  # ============================================================
  # シェルスクリプトチェック
  # ============================================================
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.11.0.1
    hooks:
      - id: shellcheck
        name: シェルスクリプトチェック (shellcheck)
        args: [--severity=warning]

  # ============================================================
  # カスタムチェック（repo: local）
  # ============================================================
  - repo: local
    hooks:
      # パスワードパターンチェック（既存）
      - id: check-hardcoded-passwords
        name: docs内のハードコードパスワードをチェック
        entry: tools/precommit/check_docs_passwords.sh
        language: system
        pass_filenames: false
        always_run: true

      # カスタムチェックのサンプル（tools/precommit/ から呼び出し）
      - id: check-todos-on-push
        name: TODO/FIXME コメントをチェック (pre-push)
        entry: tools/precommit/check_todos.py
        language: python
        types: [python]
        pass_filenames: true
        stages: [pre-push]

      # env/配下の実ファイルがコミットされようとしたら警告
      - id: check-env-files
        name: env/配下の実ファイル追跡を防止
        entry: >
          bash -c 'for f in "$@"; do if [[ "$f" =~ ^env/\.env\. ]] && [[ ! "$f" =~ \.(example|template)$ ]]; then echo "❌ エラー: 実環境ファイル $f をコミットしないでください"; exit 1; fi; done' --
        language: system
        pass_filenames: true
        types: [file]
