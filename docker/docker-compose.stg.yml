## =============================================================
## docker-compose.stg.yml (GCP VM ステージング環境 - ENV=vm_stg 用)
## - Makefile 経由で起動: make up ENV=vm_stg
## - 使用する env ファイル: env/.env.common + env/.env.vm_stg + secrets/.env.vm_stg.secrets
## - 特徴:
##   * VPN / Tailscale 経由でのアクセス(IAP なし)
##   * AUTH_MODE=vpn_dummy (固定ユーザーでのダミー認証)
##   * Artifact Registry のイメージを利用(pull のみ、build なし)
##   * 3層ネットワーク分離(edge/app/data)
## - イメージ: asia-northeast1-docker.pkg.dev/honest-sanbou-app-stg/sanbou-app/*:stg-latest
## - CI/CD でビルド、本番では pull のみ
##
## ★ 重要: 1台の VM で vm_stg / vm_prod を同時起動しないこと
##   - 80番ポートは両者とも "80:80" を使用するため、片方を down してから起動すること
## =============================================================

# =============================================================================
# YAML アンカー定義（共通設定の再利用）
# =============================================================================
x-common-env: &common-env-files
  - ../env/.env.common
  - ../env/.env.vm_stg
  - ../secrets/.env.vm_stg.secrets

x-common-logging: &common-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"

x-common-healthcheck: &common-healthcheck
  interval: 30s
  timeout: 5s
  retries: 3

x-tz-env: &tz-environment
  TZ: "Asia/Tokyo"

services:
  core_api:
    image: ${IMAGE_REGISTRY}/core_api:${IMAGE_TAG}
    networks:
    - app-net
    - data-net
    depends_on:
    - db
    env_file: &id001
    - ../env/.env.common
    - ../env/.env.vm_stg
    - ../secrets/.env.vm_stg.secrets
    volumes:
    - ../app/backend/core_api/migrations:/backend/migrations:rw
    - ../app/config:/backend/config
    environment:
      TZ: Asia/Tokyo
    restart: unless-stopped
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8000/health
      interval: 30s
      timeout: 5s
      retries: 3
    logging:
      driver: json-file
      options: &id002
        max-size: 10m
        max-file: '3'
  plan_worker:
    image: ${IMAGE_REGISTRY}/plan_worker:${IMAGE_TAG}
    networks:
    - data-net
    depends_on:
    - db
    env_file: *id001
    environment:
      TZ: Asia/Tokyo
    restart: unless-stopped
    logging:
      driver: json-file
      options: *id002
  ai_api:
    image: ${IMAGE_REGISTRY}/ai_api:${IMAGE_TAG}
    networks:
    - app-net
    depends_on:
    - db
    env_file: *id001
    volumes:
    - ../app/config:/backend/config
    environment:
      TZ: Asia/Tokyo
    restart: unless-stopped
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8000/health
      interval: 30s
      timeout: 5s
      retries: 3
    logging:
      driver: json-file
      options: *id002
  ledger_api:
    image: ${IMAGE_REGISTRY}/ledger_api:${IMAGE_TAG}
    user: 0:0
    networks:
    - app-net
    - data-net
    depends_on:
    - db
    env_file: *id001
    volumes:
    - ../app/config:/backend/config
    environment:
      REPORT_ARTIFACT_URL_PREFIX: /reports/artifacts
      STRICT_STARTUP: 'true'
      TZ: Asia/Tokyo
    restart: unless-stopped
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8000/health
      interval: 30s
      timeout: 5s
      retries: 3
    logging:
      driver: json-file
      options: *id002
  rag_api:
    image: ${IMAGE_REGISTRY}/rag_api:${IMAGE_TAG}
    networks:
    - app-net
    - data-net
    depends_on:
    - db
    env_file: *id001
    volumes:
    - ../app/config:/backend/config
    environment:
      CATEGORY_QUESTION_TEMPLATES_WITH_TAGS: /backend/config/category_question_templates_with_tags.yaml
      TZ: Asia/Tokyo
    restart: unless-stopped
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8000/health
      interval: 30s
      timeout: 5s
      retries: 3
    logging:
      driver: json-file
      options: *id002
  manual_api:
    image: ${IMAGE_REGISTRY}/manual_api:${IMAGE_TAG}
    networks:
    - app-net
    env_file: *id001
    environment:
      MANUAL_FRONTEND_BASE_URL: ${MANUAL_FRONTEND_BASE_URL:-http://localhost:5173}
      TZ: Asia/Tokyo
    restart: unless-stopped
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:8000/health
      interval: 30s
      timeout: 5s
      retries: 3
    logging:
      driver: json-file
      options: *id002
  nginx:
    # ★ 注意: nginx イメージは app/nginx/Dockerfile でビルドされたものを使用
    #   - ビルド時に stg.conf がイメージにコピー済み
    #   - volume マウントで実行時に上書き可能
    #   - HTTP(80) のみで応答、HTTPS リダイレクトなし
    image: ${IMAGE_REGISTRY}/nginx:${IMAGE_TAG}
    depends_on:
    - core_api
    - ai_api
    - ledger_api
    - rag_api
    - manual_api
    networks:
    - edge-net
    - app-net
    ports:
    - ${STG_NGINX_HTTP_PORT:-80}:80
    - ${STG_NGINX_HTTPS_PORT:-443}:443
    environment:
      TZ: Asia/Tokyo
    volumes:
    - ../app/nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf:ro
    - ../app/nginx/conf.d/stg.conf:/etc/nginx/conf.d/stg.conf:ro
    - ../app/nginx/conf.d/_proxy_common.conf:/etc/nginx/conf.d/_proxy_common.conf:ro
    - ../app/nginx/certs:/etc/nginx/certs:ro
    restart: unless-stopped
    healthcheck:
      test:
      - CMD
      - curl
      - -f
      - http://localhost:80/health
      interval: 30s
      timeout: 5s
      retries: 3
    logging:
      driver: json-file
      options: *id002
  db:
    image: postgres:17-alpine
    networks:
    - data-net
    - default
    environment:
      TZ: Asia/Tokyo
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
    - db_data:/var/lib/postgresql/data
    ports:
    - 5432:5432
    restart: unless-stopped
    healthcheck:
      test:
      - CMD-SHELL
      - pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: json-file
      options: *id002
networks:
  edge-net:
    driver: bridge
    name: sanbou_stg_edge
  app-net:
    driver: bridge
    name: sanbou_stg_app
    internal: false
  data-net:
    driver: bridge
    name: sanbou_stg_data
    internal: true
volumes:
  db_data:
    driver: local
