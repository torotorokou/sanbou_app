## =============================================================
## docker-compose.dev.yml (ローカル開発環境 - ENV=local_dev 用)
## - Makefile 経由で起動: make up ENV=local_dev
## - 使用する env ファイル: env/.env.common + env/.env.local_dev + secrets/.env.local_dev.secrets
## - 特徴: ホットリロード有効、開発用ポート使用、ボリュームマウント
## - backend サービスは標準化された Dockerfile (target: dev) を利用
## =============================================================
services:
  # ===========================================================================
  # Frontend
  # ===========================================================================
  frontend:
    build:
      context: ../app/frontend
      dockerfile: Dockerfile
      target: dev
    env_file:
      - ../env/.env.common
      - ../env/.env.local_dev
      - ../secrets/.env.local_dev.secrets
    command: ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
    ports:
      - "${DEV_FRONTEND_PORT:-5173}:5173"
    volumes:
      - node_modules_dev:/app/node_modules
      - ../app/frontend:/app
    environment:
      - DOCKER=true
    depends_on:
      core_api:
        condition: service_healthy
    networks:
      - app-net

  # ===========================================================================
  # AI API
  # ===========================================================================
  ai_api:
    build:
      context: ../app/backend
      dockerfile: ai_api/Dockerfile
      target: dev
    env_file:
      - ../env/.env.common
      - ../env/.env.local_dev
      - ../secrets/.env.local_dev.secrets
    command: >
      uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
      --reload-dir /backend/app
      --reload-dir /opt/backend_shared/src
    ports:
      - "${DEV_AI_API_PORT:-8001}:8000"
    volumes:
      - ../app/backend/ai_api/app:/backend/app:rw
      - ../app/backend/backend_shared:/opt/backend_shared:rw
      - ../app/config:/backend/config
      - ../secrets:/backend/secrets:ro
    environment:
      - WATCHFILES_FORCE_POLLING=1
      - TZ=Asia/Tokyo
      # Security: Use service account key instead of mounting ~/.config/gcloud
      - GOOGLE_APPLICATION_CREDENTIALS=/backend/secrets/gcs-key-dev.json
    depends_on:
      db:
        condition: service_healthy
    networks:
      - app-net

  # ===========================================================================
  # Ledger API
  # ===========================================================================
  ledger_api:
    build:
      context: ../app/backend
      dockerfile: ledger_api/Dockerfile
      target: dev
    env_file:
      - ../env/.env.common
      - ../env/.env.local_dev
      - ../secrets/.env.local_dev.secrets
    # Security: Run as non-root user (appuser defined in Dockerfile)
    command: >
      uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
      --reload-dir /backend/app
      --reload-dir /opt/backend_shared/src
    ports:
      - "${DEV_LEDGER_API_PORT:-8002}:8000"
    volumes:
      - ../app/backend/ledger_api/app:/backend/app:rw
      - ../app/backend/backend_shared:/opt/backend_shared:rw
      - ../app/config:/backend/config
      - ../secrets:/backend/secrets:ro
      # - ~/.config/gcloud:/home/appuser/.config/gcloud
    environment:
      WATCHFILES_FORCE_POLLING: "1"
      REPORT_ARTIFACT_URL_PREFIX: "/reports/artifacts"
      TZ: "Asia/Tokyo"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - app-net

  # ===========================================================================
  # Core API (BFF)
  # ===========================================================================
  core_api:
    build:
      context: ../app/backend
      dockerfile: core_api/Dockerfile
      target: dev
    env_file:
      - ../env/.env.common
      - ../env/.env.local_dev
      - ../secrets/.env.local_dev.secrets
    command: >
      uvicorn app.app:app --host 0.0.0.0 --port 8000 --reload
      --reload-dir /backend/app
      --reload-dir /opt/backend_shared/src
    ports:
      - "${DEV_CORE_API_PORT:-8003}:8000"
    volumes:
      - ../app/backend/core_api/app:/backend/app:rw
      - ../app/backend/core_api/migrations_v2:/backend/migrations_v2:rw
      - ../app/backend/core_api/migrations_legacy:/backend/migrations_legacy:rw
      - ../app/backend/backend_shared:/opt/backend_shared:rw
      - ../app/config:/backend/config
      - ../secrets:/backend/secrets:ro
    environment:
      - WATCHFILES_FORCE_POLLING=1
      - TZ=Asia/Tokyo
      # Security: Use service account key instead of mounting ~/.config/gcloud
      - GOOGLE_APPLICATION_CREDENTIALS=/backend/secrets/gcs-key-dev.json
      # Alembic: DB connection string (uses myuser for DDL operations)
      # PASSWORD MOVED TO: secrets/.env.local_dev.secrets (DB_ALEMBIC_PASSWORD)
      - ALEMBIC_DB_USER=myuser
    depends_on:
      db:
        condition: service_healthy
    networks:
      - app-net

  # ===========================================================================
  # Plan Worker
  # ===========================================================================
  plan_worker:
    build:
      context: ../app/backend
      dockerfile: plan_worker/Dockerfile
      target: dev
    env_file:
      - ../env/.env.common
      - ../env/.env.local_dev
      - ../secrets/.env.local_dev.secrets
    command: ["python", "-m", "app.main"]
    volumes:
      - ../app/backend/plan_worker/app:/backend/app:rw
      - ../app/backend/plan_worker/test:/backend/test:rw
      - ../app/backend/backend_shared:/opt/backend_shared:rw
      - ../secrets:/backend/secrets:ro
      # - ~/.config/gcloud:/home/appuser/.config/gcloud
    environment:
      WATCHFILES_FORCE_POLLING: "1"
      TZ: "Asia/Tokyo"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - app-net
    restart: unless-stopped

  # ===========================================================================
  # RAG API
  # ===========================================================================
  rag_api:
    build:
      context: ../app/backend
      dockerfile: rag_api/Dockerfile
      target: dev
    env_file:
      - ../env/.env.common
      - ../env/.env.local_dev
      - ../secrets/.env.local_dev.secrets
    command: ["bash", "startup.sh"]
    ports:
      - "${DEV_RAG_API_PORT:-8004}:8000"
    volumes:
      - ../app/backend/rag_api/app:/backend/app:rw
      - ../app/backend/backend_shared:/opt/backend_shared:rw
      - ../app/config:/backend/config
      - ../secrets:/backend/secrets:ro
      # GCS からダウンロードしたデータを書き込みたいので dev では read-write にする
      - ../app/backend/rag_api/local_data/master:/backend/local_data/master
    environment:
      CATEGORY_QUESTION_TEMPLATES_WITH_TAGS: /backend/config/category_question_templates_with_tags.yaml
      DEV_RELOAD: "1"
      LOCAL_DATA_DIR: /backend/local_data/master
      RAG_GCS_URI: gs://sanbouapp-dev/rag_api/object_haikibutu/master/
      WATCHFILES_FORCE_POLLING: "1"
      TZ: "Asia/Tokyo"
      # Security: Use service account key instead of mounting ~/.config/gcloud
      GOOGLE_APPLICATION_CREDENTIALS: /backend/secrets/gcs-key-dev.json
    depends_on:
      db:
        condition: service_healthy
    networks:
      - app-net

  # ===========================================================================
  # Manual API
  # ===========================================================================
  manual_api:
    build:
      context: ../app/backend
      dockerfile: manual_api/Dockerfile
      target: dev
    env_file:
      - ../env/.env.common
      - ../env/.env.local_dev
      - ../secrets/.env.local_dev.secrets
    command: ["bash", "startup.sh"]
    ports:
      - "${DEV_MANUAL_API_PORT:-8005}:8000"
    volumes:
      - ../app/backend/manual_api/app:/backend/app:rw
      - ../app/backend/backend_shared:/opt/backend_shared:rw
      - ../secrets:/backend/secrets:ro
    environment:
      MANUAL_FRONTEND_BASE_URL: ${MANUAL_FRONTEND_BASE_URL:-http://localhost:5173}
      TZ: "Asia/Tokyo"
      # Security: Use service account key instead of mounting ~/.config/gcloud
      GOOGLE_APPLICATION_CREDENTIALS: /backend/secrets/gcs-key-dev.json
    networks:
      - app-net

  # ===========================================================================
  # Inbound Forecast API (需要予測サービス)
  # ===========================================================================
  inbound_forecast_api:
    build:
      context: ../app/backend/inbound_forecast_api
      dockerfile: Dockerfile
      target: dev
    env_file:
      - ../env/.env.common
      - ../env/.env.local_dev
      - ../secrets/.env.local_dev.secrets
    command: >
      uvicorn scripts.api_server:app
      --host 0.0.0.0 --port 8000 --reload
      --reload-dir /backend/scripts
    ports:
      - "${DEV_INBOUND_FORECAST_API_PORT:-8006}:8000"
    volumes:
      - ../app/backend/inbound_forecast_api/scripts:/backend/scripts:rw
      - ../app/backend/inbound_forecast_api/data:/backend/data:rw
      - ../app/backend/inbound_forecast_api/models:/backend/models:rw
      - ../app/backend/inbound_forecast_api/output:/backend/output:rw
      - ../app/backend/inbound_forecast_api/worker:/backend/worker:rw
      - ../secrets:/backend/secrets:ro
    environment:
      WATCHFILES_FORCE_POLLING: "1"
      TZ: "Asia/Tokyo"
      # 必要に応じてDB接続を追加（現時点では不要と判断）
      # GOOGLE_APPLICATION_CREDENTIALS: /backend/secrets/gcs-key-dev.json
    networks:
      - app-net
    # DB依存は現時点で不要（独立した推論サービスとして動作）
    # depends_on:
    #   db:
    #     condition: service_healthy

  # ===========================================================================
  # Inbound Forecast Worker (需要予測ジョブ実行 - run-to-completion)
  # ===========================================================================
  inbound_forecast_worker:
    build:
      context: ../app/backend/inbound_forecast_api
      dockerfile: Dockerfile
      target: dev
    env_file:
      - ../env/.env.common
      - ../env/.env.local_dev
      - ../secrets/.env.local_dev.secrets
    command: ["python", "-m", "worker.main", "--help"]
    # ポート公開なし（バックグラウンドジョブ実行のみ）
    volumes:
      - ../app/backend/inbound_forecast_api/scripts:/backend/scripts:rw
      - ../app/backend/inbound_forecast_api/data:/backend/data:rw
      - ../app/backend/inbound_forecast_api/models:/backend/models:rw
      - ../app/backend/inbound_forecast_api/output:/backend/output:rw
      - ../app/backend/inbound_forecast_api/worker:/backend/worker:rw
      - ../secrets:/backend/secrets:ro
    environment:
      TZ: "Asia/Tokyo"
      PYTHONPATH: /backend
    networks:
      - app-net
    # 通常起動では立ち上がらない（profile指定時のみ）
    profiles:
      - jobs
      - forecast

  # ===========================================================================
  # Nginx (Optional - for testing prod-like routing)
  # ===========================================================================
  # 使い方: docker compose -f docker/docker-compose.dev.yml -p local_dev up -d nginx
  # アクセス: http://localhost:8080
  nginx:
    image: nginx:1.27-alpine
    depends_on:
      - core_api
      - ai_api
      - ledger_api
      - rag_api
      - manual_api
      - frontend
    ports:
      - "${DEV_NGINX_PORT:-8080}:80"
    volumes:
      - ../app/nginx/conf.d/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ../app/nginx/conf.d/dev.conf:/etc/nginx/conf.d/dev.conf:ro
      - ../app/nginx/conf.d/_proxy_headers_dev_stg.conf:/etc/nginx/conf.d/_proxy_headers_dev_stg.conf:ro
      - ../app/nginx/conf.d/_security_headers.conf:/etc/nginx/conf.d/_security_headers.conf:ro
    environment:
      - TZ=Asia/Tokyo
    networks:
      - app-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    profiles:
      - with-nginx

  # ===========================================================================
  # PostgreSQL Database
  # ===========================================================================
  db:
    image: postgres:17-alpine
    env_file:
      - ../env/.env.common
      - ../env/.env.local_dev
      - ../secrets/.env.local_dev.secrets
    ports:
      - "${DEV_DB_PORT:-5432}:5432"
    volumes:
      - ../data/postgres_v17:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app-net

volumes:
  node_modules_dev:
    driver: local

networks:
  app-net:
    driver: bridge
